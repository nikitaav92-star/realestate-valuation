# Bug: Address Parser Regression

**Status:** Open  
**Priority:** P1  
**Created:** 2025-11-21  
**Owner:** AI Assistant  

## Description
- Карточки объявлений возвращают адрес только в 2 из 24 случаев (8.3%).
- Полный адрес `address_full` на детальной странице почти всегда пустой.
- Адреса содержат лишний текст («На карте», станции метро, время пешком).
- Адрес разбит на несколько DOM-элементов (breadcrumbs), а текущая логика ожидает одну строку.
- Валидация требует одновременно «Москва», улицу (`ул.`) и номер дома, поэтому реальные адресы отбрасываются.

## Impact
- В БД ~92% объявлений остаются без адреса → нельзя фильтровать по районам, строить карты, нормализовать FIAS.
- Качество данных нарушает принцип `.speckit/constitution/project-constitution.md` (>90% объявлений с адресом).
- Отчёт `ADDRESS_EXTRACTION_PROBLEM.md` фиксирует проблему и блокирует интеграцию гео-аналитики.

## Root Cause
1. `etl/collector_cian/browser_fetcher.py::_parse_offers_from_html` ожидает, что адрес целиком содержится в `GeoLabel`, не объединяет части.
2. `parse_listing_detail`:
   - Жёстко требует `Москва + улица + номер`, иначе отбрасывает кандидата.
   - Очищает «На карте» только в конце строки, поэтому текст метро остаётся в середине.
   - Использует общие селекторы и не ориентируется на реальные контейнеры CIAN.

## Proposed Solution
1. **Карточки (`address`)**
   - Собрать все части адреса в контейнере `[data-name='GeoLabel']` / breadcrumbs, вставлять запятые между ними.
   - Разрешить адреса без номера дома; валидировать по наличию `Москва` или округа / района / метро.
   - Нормализовать текст: убрать «На карте», станции метро и время (регулярки + список ключевых слов).
2. **Детальные страницы (`address_full`)**
   - Использовать специфичные селекторы CIAN: `.a10a3f92e9--address--`, breadcrumbs внутри `data-name='Breadcrumbs'`.
   - Переписать очистку: удалить всё после `На карте`, убрать «м. ... 15 мин», удалить повторяющиеся пробелы.
   - При комбинировании частей ограничить требования до `Москва + (улица|проспект|шоссе|дом)` или `Москва + ЖК`.
   - Добавить подробное логирование (DEBUG) с подсчётом успешных/проваленных кандидатов.
3. **Fallback**
   - Если найдены части (город, округ, район, улица) по отдельности, объединить их в порядке: город → округ → район → улица → дом.
   - Сформировать метрики: сколько объявлений получили адрес и откуда (GeoLabel, breadcrumbs, regex и т.д.).

## Test Cases
1. Прогнать `python -m etl.collector_cian.cli to-db --pages 1 --parse-details`:
   - ≥90% карточек на странице содержат `offer["address"]`.
   - В логах видно хотя бы по одной успешной записи на каждый метод (`GeoLabel`, breadcrumbs, detail DOM).
2. Юнит-тесты для чистки:
   - Вход: `Москва, ВАО, р-н Сокольники, ул. ГастеллоНа карте Сокольники 14 мин. Электрозаводская 15 мин.`  
     Ожидаемый результат: `Москва, ВАО, р-н Сокольники, ул. Гастелло`.
   - Вход: `Москва, район Сокольники, улица Гастелло, дом 5` → не должен отбрасываться.
3. Проверить, что `address_full` появляется в `listings_details` хотя бы в 80% объявлений при запуске одной страницы.

## References
- `/ADDRESS_EXTRACTION_PROBLEM.md`
- `/PARSER_ISSUE_REPORT.md`
- `.speckit/tasks/current-sprint.md`

