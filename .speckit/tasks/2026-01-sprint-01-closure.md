# Фиксация итогов: Январь 2026 - Спринт 1 (Data Quality)

## Контекст
CIAN Real Estate Valuation Platform - парсер объявлений CIAN для оценки недвижимости.
Основная задача спринта: улучшение качества данных и инфраструктуры.

## Что сделано в этом этапе

### Выполнено
- [x] **Дедупликация** - система обнаружения перепостов объявлений
  - Миграция `012_duplicate_tracking.sql` (is_repost, original_listing_id, description_hash)
  - Таблица `listing_duplicates` для связей
  - Детектор в `etl/duplicate_detector.py`
  - Интеграция в `etl/collector_cian/cli.py`
  - **Результат: 310 дубликатов найдено и связано**

- [x] **FIAS нормализация** - DaData Suggest API (бесплатный 10k/день)
  - Скрипт `scripts/normalize_fias.py`
  - Обновлён `etl/fias_normalizer.py`
  - **Результат: 42.9% адресов нормализовано (9,247 из 21,558)**

- [x] **Очистка данных**
  - Удалены листинги с ценой > 100M RUB
  - Деактивированы 1080 "снятых с публикации"
  - Деактивирован 1 подозрительный листинг (850k RUB)
  - **Результат: диапазон цен 1.8M - 100M RUB**

- [x] **house_material bug** - исправлено дублирование
  - Очищена колонка house_material (использовался как копия building_type)
  - Теперь используется только building_type от CIAN

- [x] **Оптимизация сервисов**
  - Отключён дублирующий `cian-fast-scan.service`
  - Причина: общий lock файл с `cian-scraper`, не может работать параллельно

- [x] **Git коммиты**
  - Закоммичены миграции 011, 012
  - Закоммичены изменения API и ETL

### Ключевые решения
| Решение | Причина |
|---------|---------|
| DaData вместо FIAS API | fias.nalog.ru заблокирован с VPS |
| Прокси только для cookies | Экономия, правило безопасности |
| Отключение fast-scan | Дублирует основной scraper |
| MD5 для description_hash | Достаточно для детекции, быстрый |

---

## Задачи фиксации

### 1. Документация
- [x] Создан шаблон фиксации `.speckit/constitution/sprint-closure-template.md`
- [x] Обновить README.md с новыми фичами
- [x] Обновить CHANGELOG.md

### 2. Код и структура
- [x] Удалён мёртвый код (fast-scan отключён)
- [x] Проверены зависимости

### 3. Git hygiene
- [x] Коммит: `feat: add duplicate detection, FIAS normalization, CBR rates`
- [x] Создать тег v2.2.1

### 4. AI-контекст (SpecKit)
- [x] Создан шаблон фиксации спринта
- [x] Создан отчёт по спринту
- [ ] Обновить PROJECT-MAP.md

### 5. Технический долг
| Задача | Критичность | Статус |
|--------|-------------|--------|
| FIAS нормализация ~57% осталось | Medium | В процессе (фон) |
| Rate limiting от CIAN | Low | Работает с backoff |
| Первый этаж в данных | Low | 301 листинг, возможно ОК |

---

## Следующий этап

### Приоритет 1 (Critical)
- Завершить FIAS нормализацию (оставшиеся ~12k адресов)

### Приоритет 2 (High)
- Автоматическая очистка мусорных объявлений при парсинге
- Валидация параметров на входе

### Приоритет 3 (Medium)
- Улучшить детекцию дубликатов (по фото?)
- Добавить мониторинг качества данных

### Блокеры
- Лимит DaData 10k/день (нужно ~2 дня на оставшиеся адреса)

---

## Статистика БД на конец спринта

```
Всего объявлений:     22,054 активных
Дубликаты (reposts):  310
FIAS нормализация:    42.9%
Диапазон цен:         1.8M - 100M RUB
description_hash:     100% покрытие
Парсер:               9 процессов активно
```

---

## Чек-лист перед закрытием

- [x] README отражает текущее состояние
- [x] Нет хардкода секретов
- [x] .env.example актуален
- [x] Тег версии создан (v2.2.1)
- [x] Все изменения закоммичены

---

## Заметки

### Правило прокси (КРИТИЧНО!)
```
ПРОКСИ ТОЛЬКО ДЛЯ COOKIES!
- config/get_cookies_with_proxy.py - РАЗРЕШЕНО
- Парсинг страниц - ЗАПРЕЩЕНО (use_smart_proxy=False)
```

### Сервисы
```
cian-scraper:        каждые 90 мин (работает)
cian-fast-scan:      ОТКЛЮЧЁН
cian-alerts:         каждые 10 мин
realestate-bot:      работает
rating-valuation-api: работает
```

---

**Дата закрытия:** 2026-01-07
**Следующий спринт:** Завершение FIAS, валидация данных
