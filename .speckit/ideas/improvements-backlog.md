# Real Estate Platform - Improvements Backlog

> **Последнее обновление:** 2025-01-03

---

## Завершено (Январь 2025)

### Валюация

- **IQR фильтрация выбросов** - удаление аномальных цен из аналогов
- **Aging discount** - учёт возраста объявлений (-1% за 30 дней)
- **Confidence-based price range** - диапазон ±5%/±10%/±15% по confidence
- **Коэффициент площади** - снижен с 0.002 до 0.001
- **Дисконт последнего этажа** - снижен с 5% до 2%

### Инвестиционный калькулятор

- **Исправлен ЖКУ баг** - `or True` убран
- **Валидация interest_price** - проверка > 0

### UI

- **Кнопка "Переоценить"** - в истории оценок
- **Улучшены чипы этажей** - лучший визуал

---

## Высокий приоритет

### 1. Кэширование DaData

**Статус:** Запланировано
**Effort:** Small (1 день)
**Impact:** High

**Проблема:** Каждый запрос = API вызов. Лимит 10k/месяц.

**Решение:**
```python
from functools import lru_cache
import hashlib

@lru_cache(maxsize=10000)
def geocode_address_cached(address: str):
    return dadata.clean("address", address)
```

**Файлы:** `etl/geocoder.py`

---

### 2. Rate Limiting API

**Статус:** Запланировано
**Effort:** Small (1 день)
**Impact:** High

**Проблема:** API открыт для DDoS.

**Решение:**
```python
from slowapi import Limiter
limiter = Limiter(key_func=get_remote_address)

@app.get("/estimate")
@limiter.limit("10/minute")
async def estimate(request: Request):
    ...
```

**Файлы:** `api/main.py`

---

### 3. Транзакции при сохранении

**Статус:** Запланировано
**Effort:** Small (0.5 дня)
**Impact:** Medium

**Проблема:** Сохранение valuation и comparables не атомарно.

**Решение:**
```python
async with db.transaction():
    valuation_id = await save_valuation(data)
    await save_comparables(valuation_id, comparables)
```

**Файлы:** `api/v1/valuation.py`

---

## Средний приоритет

### 4. Учёт близости к метро

**Статус:** Идея
**Effort:** Medium (2-3 дня)
**Impact:** High

**Описание:** Добавить коррекцию ±10-30% на основе расстояния до метро.

**Реализация:**
1. Получить координаты станций метро (OSM/API)
2. Добавить в БД таблицу `metro_stations`
3. Рассчитывать distance при оценке
4. Применять коррекцию

**Отложено:** Пользователь решил не добавлять в первой итерации.

---

### 5. Инфляционная коррекция Росреестра

**Статус:** Идея
**Effort:** Medium (1-2 дня)
**Impact:** Medium

**Проблема:** Сделки годовой давности учитываются без корректировки на рост цен.

**Решение:**
```python
# Коэффициент инфляции по месяцам
INFLATION_MONTHLY = 0.005  # 0.5% в месяц

months_ago = (now - deal_date).days // 30
inflation_correction = 1 + (INFLATION_MONTHLY * months_ago)
corrected_price = deal_price * inflation_correction
```

---

### 6. Автоматический скрейпинг по расписанию

**Статус:** Идея
**Effort:** Small (1 день)
**Impact:** High

**Описание:** Systemd timer для ночного сбора данных.

```bash
# /etc/systemd/system/cian-scraper.timer
[Timer]
OnCalendar=*-*-* 03:00:00
Persistent=true
```

**Файлы:** `infra/systemd/`

---

### 7. Price Drop Alerts

**Статус:** Идея
**Effort:** Medium (2-3 дня)
**Impact:** Medium

**Описание:** Telegram уведомления при:
- Снижении цены >5%
- Новых объектах ниже порога
- Соответствии сохранённому поиску

**Реализация:**
1. SQL view для отслеживания изменений
2. Python скрипт с Telegram API
3. Cron job каждый час

---

## Низкий приоритет

### 8. ML модель предсказания цены

**Статус:** Исследование
**Effort:** Large (3-4 недели)
**Impact:** Medium

**Описание:**
- Обучить модель на исторических данных
- Features: площадь, комнаты, район, этаж, возраст дома
- Сравнить с KNN подходом

**Требования:**
- 6+ месяцев исторических данных
- Labeled dataset
- XGBoost / LightGBM

---

### 9. Учёт особых случаев

**Статус:** Идея
**Effort:** Medium (2-3 дня)
**Impact:** Low

**Описание:** Обработка особых типов:
- Пентхаусы - премия вместо дисконта
- Первый этаж с отдельным входом - коммерческий потенциал
- Квартиры с террасой - +10-20%
- Двухуровневые - особый сегмент

**Отложено:** Редкие случаи, низкий приоритет.

---

### 10. Multi-region поддержка

**Статус:** Идея
**Effort:** Large (1-2 недели)
**Impact:** Medium

**Описание:** Поддержка других городов:
- Санкт-Петербург
- Казань
- Екатеринбург

**Сложности:**
- Разные прокси по регионам
- Разная структура метро/районов
- Партиционирование БД

---

### 11. Безопасность: убрать credentials из кода

**Статус:** Запланировано
**Effort:** Small (0.5 дня)
**Impact:** High

**Проблема:**
```python
"postgresql://realuser:strongpass123@localhost:5432/realdb"
```

**Решение:**
- Все credentials через .env
- Проверка при старте
- .env.example без реальных данных

**Файлы:** Все файлы с DB URL

---

## Отклонено

### Учёт балкона

**Причина:** Пользователь решил не добавлять - недостаточно данных.

### Учёт стороны света

**Причина:** Слишком субъективно, сложно получить данные.

### Налог 13% при продаже

**Причина:** Текущая схема (6% от разницы) уже работает правильно.

---

## История

### Декабрь 2024
- Инвестиционный калькулятор
- Telegram отчёты
- Интерактивная карта

### Ноябрь 2024
- HTML парсер с Playwright
- Smart proxy rotation
- SCD Type 2 для истории цен

### Октябрь 2024
- Базовый CIAN парсер
- PostgreSQL + PostGIS
- Первый Web UI

---

**Maintainer:** AI Assistant
