# Спецификация: Интеграция интерактивной карты с квартирами

## Цель
Интегрировать интерактивную карту для визуализации квартир на основе их адресов, с возможностью перехода от адреса к карте и обратно.

## Требования

### Функциональные требования

1. **Отображение квартир на карте**
   - Каждая квартира отображается как маркер на карте
   - Маркер содержит базовую информацию (цена, площадь, комнаты)
   - При клике на маркер открывается подробная информация

2. **Переход от адреса к карте**
   - В таблице объявлений добавлена кнопка "Показать на карте"
   - При клике открывается карта с центром на адресе квартиры
   - Выделяется соответствующий маркер

3. **Переход от карты к объявлению**
   - При клике на маркер открывается страница с полным описанием квартиры
   - Возможность вернуться к списку объявлений

4. **Фильтрация на карте**
   - Применение тех же фильтров что и в таблице (комнаты, цена, площадь)
   - Обновление маркеров на карте в реальном времени

5. **Кластеризация маркеров**
   - При большом количестве квартир маркеры группируются в кластеры
   - При зуме кластеры разбиваются на отдельные маркеры

### Технические требования

1. **Картографический сервис**
   - Вариант 1: Яндекс.Карты (рекомендуется для России)
   - Вариант 2: OpenStreetMap + Leaflet (бесплатно, но требует геокодирования)
   - Вариант 3: Google Maps (платно, но хорошо работает)

2. **Геокодирование адресов**
   - Использовать координаты из БД (lat, lon) если есть
   - Если координат нет - геокодировать через API (Яндекс.Геокодер, Dadata, OSM Nominatim)
   - Кэшировать результаты геокодирования

3. **Производительность**
   - Ленивая загрузка маркеров (только видимые на карте)
   - Ограничение количества маркеров на карте (макс 1000)
   - Использование кластеризации для больших наборов данных

## Архитектура

### Компоненты

1. **Backend API**
   - `/api/listings/map` - получение списка квартир с координатами для карты
   - `/api/listings/{id}/geocode` - геокодирование адреса конкретной квартиры
   - `/api/listings/bounds` - получение квартир в заданных границах карты

2. **Frontend компоненты**
   - `MapView` - компонент карты с маркерами
   - `ListingMarker` - компонент маркера квартиры
   - `MapPopup` - всплывающее окно с информацией о квартире
   - `MapFilters` - фильтры для карты

3. **База данных**
   - Использовать существующие поля `lat`, `lon` в таблице `listings`
   - Добавить индекс для быстрого поиска по координатам: `CREATE INDEX idx_listings_location ON listings USING GIST (point(lon, lat))`
   - Добавить поле `geocoded_at` для отслеживания времени геокодирования

### Технологический стек

- **Карта**: Яндекс.Карты API (JavaScript API 3.0)
- **Backend**: FastAPI (существующий)
- **Frontend**: Vanilla JavaScript или React (в зависимости от текущего стека)
- **Геокодирование**: Яндекс.Геокодер API или Dadata API

## Этапы реализации

### Этап 1: Подготовка данных (1-2 дня)
- [ ] Проверить наличие координат в БД
- [ ] Реализовать геокодирование адресов через API
- [ ] Создать задачу для массового геокодирования существующих адресов
- [ ] Добавить индекс для поиска по координатам

### Этап 2: Backend API (2-3 дня)
- [ ] Создать endpoint `/api/listings/map` с фильтрацией
- [ ] Создать endpoint `/api/listings/{id}/geocode` для геокодирования
- [ ] Создать endpoint `/api/listings/bounds` для получения квартир в границах карты
- [ ] Добавить кэширование результатов геокодирования

### Этап 3: Frontend карта (3-4 дня)
- [ ] Интегрировать Яндекс.Карты API
- [ ] Создать компонент карты с базовым отображением
- [ ] Реализовать отображение маркеров квартир
- [ ] Добавить всплывающие окна с информацией о квартире
- [ ] Реализовать кластеризацию маркеров

### Этап 4: Интеграция с таблицей (1-2 дня)
- [ ] Добавить кнопку "Показать на карте" в таблицу объявлений
- [ ] Реализовать переход от таблицы к карте с центрированием на адресе
- [ ] Реализовать переход от карты к странице объявления
- [ ] Синхронизировать фильтры между таблицей и картой

### Этап 5: Оптимизация и тестирование (2-3 дня)
- [ ] Оптимизировать загрузку маркеров (ленивая загрузка)
- [ ] Добавить ограничение на количество маркеров
- [ ] Протестировать производительность с большим количеством данных
- [ ] Добавить обработку ошибок геокодирования

## API Endpoints

### GET /api/listings/map
Получение списка квартир для отображения на карте.

**Query параметры:**
- `bounds` (optional): Границы карты в формате `min_lat,min_lon,max_lat,max_lon`
- `rooms` (optional): Количество комнат
- `min_price` (optional): Минимальная цена
- `max_price` (optional): Максимальная цена
- `limit` (optional): Максимальное количество результатов (по умолчанию 1000)

**Response:**
```json
{
  "listings": [
    {
      "id": 123456,
      "lat": 55.7558,
      "lon": 37.6173,
      "price": 15000000,
      "rooms": 2,
      "area_total": 60.5,
      "address": "Москва, ул. Примерная, д. 1"
    }
  ],
  "total": 150,
  "bounds": {
    "min_lat": 55.5,
    "min_lon": 37.5,
    "max_lat": 56.0,
    "max_lon": 38.0
  }
}
```

### POST /api/listings/{id}/geocode
Геокодирование адреса квартиры.

**Response:**
```json
{
  "id": 123456,
  "lat": 55.7558,
  "lon": 37.6173,
  "address": "Москва, ул. Примерная, д. 1",
  "geocoded_at": "2025-11-20T12:00:00Z"
}
```

### GET /api/listings/bounds
Получение квартир в заданных границах карты.

**Query параметры:**
- `min_lat`: Минимальная широта
- `min_lon`: Минимальная долгота
- `max_lat`: Максимальная широта
- `max_lon`: Максимальная долгота
- `filters` (optional): JSON с фильтрами

**Response:** Аналогично `/api/listings/map`

## UI/UX требования

1. **Карта должна занимать большую часть экрана**
2. **Маркеры должны быть визуально различимы** (разные цвета для разных ценовых категорий)
3. **Всплывающие окна должны содержать ключевую информацию** (цена, площадь, комнаты, ссылка на полное описание)
4. **Фильтры должны быть доступны как на карте, так и в таблице**
5. **Должна быть возможность переключения между видом карты и таблицы**

## Безопасность

1. **Ограничение частоты запросов к API геокодирования** (rate limiting)
2. **Кэширование результатов геокодирования** для снижения нагрузки на API
3. **Валидация входных данных** (границы карты, фильтры)

## Мониторинг

1. **Отслеживание успешности геокодирования** (метрики)
2. **Мониторинг производительности API** (время ответа)
3. **Отслеживание использования карты** (количество просмотров, кликов)

## Оценка времени

- **Общее время**: 10-15 рабочих дней
- **Критический путь**: Backend API → Frontend карта → Интеграция

## Зависимости

1. **API ключ для картографического сервиса** (Яндекс.Карты или альтернатива)
2. **API ключ для геокодирования** (если координаты отсутствуют)
3. **Обновление существующих данных** (геокодирование адресов)

## Риски и митигация

1. **Риск**: Отсутствие координат у большинства квартир
   - **Митигация**: Реализовать массовое геокодирование через API

2. **Риск**: Высокая стоимость API геокодирования
   - **Митигация**: Использовать бесплатные альтернативы (OSM Nominatim) или кэширование

3. **Риск**: Низкая производительность при большом количестве маркеров
   - **Митигация**: Использовать кластеризацию и ленивую загрузку

4. **Риск**: Неправильное геокодирование адресов
   - **Митигация**: Валидация результатов, возможность ручной коррекции

