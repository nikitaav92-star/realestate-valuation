# –§–ò–ê–° –∏ –ö–∞–¥–∞—Å—Ç—Ä - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ  
**–î–∞—Ç–∞:** 2025-11-03

---

## –ß—Ç–æ –≠—Ç–æ?

–°–∏—Å—Ç–µ–º–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–¥—Ä–µ—Å–æ–≤ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏.

### –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

‚úÖ **–§–ò–ê–° –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è** - –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤ –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É  
‚úÖ **–ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–∑ –†–æ—Å—Ä–µ–µ—Å—Ç—Ä–∞  
‚úÖ **–ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ‚Üí –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å  
‚úÖ **–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞** - –æ—Ü–µ–Ω–∫–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ –∞–¥—Ä–µ—Å–∞  

---

## –ü–æ—á–µ–º—É –≠—Ç–æ –í–∞–∂–Ω–æ?

### –ü—Ä–æ–±–ª–µ–º–∞
CIAN –¥–∞–µ—Ç –∞–¥—Ä–µ—Å–∞ –≤ —Å–≤–æ–±–æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:
- "–ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞, 10"
- "–≥ –ú–æ—Å–∫–≤–∞, –õ–µ–Ω–∏–Ω–∞ —É–ª–∏—Ü–∞, –¥–æ–º 10"
- "–ú–æ—Å–∫–≤–∞, –õ–µ–Ω–∏–Ω–∞, 10"

‚ùå **–†–∞–∑–Ω—ã–µ –Ω–∞–ø–∏—Å–∞–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞**  
‚ùå **–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å**  
‚ùå **–ù–µ—Ç —Å–≤—è–∑–∏ —Å –≥–æ—Å—Ä–µ–µ—Å—Ç—Ä–∞–º–∏**

### –†–µ—à–µ–Ω–∏–µ
–§–ò–ê–° –ø—Ä–∏–≤–æ–¥–∏—Ç –≤—Å–µ –∫ –µ–¥–∏–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É:
- `77000000000123456` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π GUID –∑–¥–∞–Ω–∏—è
- `77:01:0001001:1001` - –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä
- –ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É

‚úÖ **–û–¥–Ω–æ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ**  
‚úÖ **–ú–æ–∂–Ω–æ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å**  
‚úÖ **–°–≤—è–∑—å —Å –†–æ—Å—Ä–µ–µ—Å—Ç—Ä–æ–º**

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
CIAN –∞–¥—Ä–µ—Å ‚Üí Dadata API ‚Üí –§–ò–ê–° ‚Üí –ë–î
    ‚Üì           ‚Üì           ‚Üì
"–õ–µ–Ω–∏–Ω–∞ 10"  Normalize   77:01:...
             Geocode     GUID
             Cadastral   
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **etl/address_normalizer.py** - –º–æ–¥—É–ª—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
2. **etl/normalize_addresses.py** - CLI –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
3. **db/migrations/003_add_fias_cadastral.sql** - —Å—Ö–µ–º–∞ –ë–î
4. **Dadata API** - –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ü–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á–∏ Dadata

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è: https://dadata.ru/profile/#info
2. –ü–æ–ª—É—á–∏—Ç—å:
   - API key (–¥–ª—è suggestions)
   - Secret key (–¥–ª—è clean)
3. **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω:** 10,000 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å

### 2. –î–æ–±–∞–≤–∏—Ç—å –≤ .env

```bash
# Dadata API
DADATA_API_KEY=your_api_key_here
DADATA_SECRET_KEY=your_secret_key_here
```

### 3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```bash
psql $PG_DSN -f db/migrations/003_add_fias_cadastral.sql
```

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–∞–∫–µ—Ç–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è

–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—Å–µ –∞–¥—Ä–µ—Å–∞ –≤ –ë–î:

```bash
# –í—Å–µ –∞–¥—Ä–µ—Å–∞
python -m etl.normalize_addresses

# –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 100 (–¥–ª—è —Ç–µ—Å—Ç–∞)
python -m etl.normalize_addresses --limit 100

# –° –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏
python -m etl.normalize_addresses --verbose

# –ü–µ—Ä–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å (–¥–∞–∂–µ –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å FIAS)
python -m etl.normalize_addresses --no-skip-existing
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –í –∫–æ–¥–µ –ø–∞—Ä—Å–µ—Ä–∞

```python
from etl.address_normalizer import normalize_address
from etl.upsert import upsert_fias_data

# –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å
normalized = normalize_address("–ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞, 10")

if normalized:
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
    upsert_fias_data(
        conn,
        listing_id=123,
        fias_address=normalized.fias_address,
        fias_id=normalized.fias_id,
        cadastral_number=normalized.cadastral_number,
        quality_code=normalized.qc,
    )
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
from etl.address_normalizer import geocode_coords

# –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ CIAN
normalized = geocode_coords(55.755826, 37.6173)

print(f"Address: {normalized.fias_address}")
print(f"Cadastral: {normalized.cadastral_number}")
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### 1. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

```sql
SELECT * FROM address_normalization_stats;
```

**–ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:**
```
total_listings | normalized_count | with_cadastral | pct_normalized | pct_with_cadastral
---------------|-----------------|----------------|----------------|-------------------
140            | 135             | 98             | 96.4           | 70.0
```

### 2. –ê–¥—Ä–µ—Å–∞ —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏

```sql
SELECT * FROM addresses_need_review
LIMIT 10;
```

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–¥—Ä–µ—Å–∞ —Å `quality_code >= 2` (—Ç—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏).

### 3. –ü—Ä–∏–º–µ—Ä –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞

```sql
SELECT 
    id,
    address as raw,
    fias_address as normalized,
    cadastral_number,
    address_quality_code as qc
FROM listings
WHERE fias_id IS NOT NULL
LIMIT 5;
```

---

## –ö–æ–¥—ã –ö–∞—á–µ—Å—Ç–≤–∞ (QC)

| –ö–æ–¥ | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|--------|----------|
| **0** | Exact | –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –§–ò–ê–° |
| **1** | Good | –•–æ—Ä–æ—à–µ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ |
| **2** | Corrected | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (–æ–ø–µ—á–∞—Ç–∫–∏ –∏ —Ç.–ø.) |
| **3** | Incomplete | –ù–µ–ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å |
| **4+** | Invalid | –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –∞–¥—Ä–µ—Å |

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ QC <= 1 –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

---

## –ü—Ä–∏–º–µ—Ä—ã

### –î–æ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
```
"–ú–æ—Å–∫–≤–∞, –õ–µ–Ω–∏–Ω–∞, 10"
"–≥. –ú–æ—Å–∫–≤–∞, —É–ª –õ–µ–Ω–∏–Ω–∞ –¥ 10"
"–ú–æ—Å–∫–≤–∞, —É–ª–∏—Ü–∞ –õ–µ–Ω–∏–Ω–∞, –¥–æ–º 10"
```

### –ü–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
```
fias_address: "–≥ –ú–æ—Å–∫–≤–∞, —É–ª –õ–µ–Ω–∏–Ω–∞, –¥ 10"
fias_id: 77000000000123456
cadastral_number: 77:01:0001001:1001
postal_code: 101000
quality_code: 0
```

‚úÖ **–í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –∫ –æ–¥–Ω–æ–º—É**

---

## –õ–∏–º–∏—Ç—ã –∏ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### Dadata API
- **–ë–µ—Å–ø–ª–∞—Ç–Ω–æ:** 10,000 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å
- **–°–∫–æ—Ä–æ—Å—Ç—å:** ~500 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- **–°—Ç–æ–∏–º–æ—Å—Ç—å:** –æ—Ç 500‚ÇΩ/–º–µ—Å –∑–∞ 30k –∑–∞–ø—Ä–æ—Å–æ–≤

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
```bash
# –°–Ω–∞—á–∞–ª–∞ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–µ–±–æ–ª—å—à—É—é —á–∞—Å—Ç—å (—Ç–µ—Å—Ç)
python -m etl.normalize_addresses --limit 100

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
psql $PG_DSN -c "SELECT * FROM address_normalization_stats;"

# –ï—Å–ª–∏ –û–ö, –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–∞ –≤—Å—é –ë–î
python -m etl.normalize_addresses
```

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ü–∞—Ä—Å–µ—Ä–æ–º

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ

TODO: –î–æ–±–∞–≤–∏—Ç—å –≤ `cli.py` —Ñ–ª–∞–≥ `--normalize-addresses`

```bash
python -m etl.collector_cian.cli to-db \
    --pages 10 \
    --normalize-addresses  # –ù–æ–≤—ã–π —Ñ–ª–∞–≥
```

–ë—É–¥–µ—Ç:
1. –ü–∞—Ä—Å–∏—Ç—å CIAN
2. –°—Ä–∞–∑—É –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å–∞
3. –ü–æ–ª—É—á–∞—Ç—å –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞
4. –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –ë–î

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –î–∞—à–±–æ—Ä–¥ –≤ Metabase

–°–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏:
- –ü—Ä–æ—Ü–µ–Ω—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–æ–¥–∞–º –∫–∞—á–µ—Å—Ç–≤–∞
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏
- TOP-10 –∞–¥—Ä–µ—Å–æ–≤ —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏

### –ê–ª–µ—Ä—Ç—ã

```sql
-- –ê–ª–µ—Ä—Ç –µ—Å–ª–∏ <90% –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–æ
SELECT 
    CASE 
        WHEN pct_normalized < 90 THEN 
            ‚ö†Ô∏è Low normalization rate:  || pct_normalized || %
        ELSE OK
    END as status
FROM address_normalization_stats;
```

---

## FAQ

### Q: –ì–¥–µ –≤–∑—è—Ç—å API –∫–ª—é—á–∏?
A: https://dadata.ru/profile/#info (–±–µ—Å–ø–ª–∞—Ç–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)

### Q: –°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç?
A: –î–æ 10k –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å - –±–µ—Å–ø–ª–∞—Ç–Ω–æ. –î–∞–ª–µ–µ –æ—Ç 500‚ÇΩ/–º–µ—Å.

### Q: –ß—Ç–æ –µ—Å–ª–∏ –∞–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω?
A: Dadata –≤–µ—Ä–Ω–µ—Ç `qc >= 3`. –¢–∞–∫–∏–µ –∞–¥—Ä–µ—Å–∞ —Ç—Ä–µ–±—É—é—Ç —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å–º. `addresses_need_review`).

### Q: –ú–æ–∂–Ω–æ –ª–∏ –±–µ–∑ Dadata?
A: –î–∞, –º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –§–ò–ê–° –±–∞–∑—É (~10GB) –∏ —Ä–∞–±–æ—Ç–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ. –ù–æ –Ω—É–∂–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL –∏ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

### Q: –ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –≤—Å–µ—Ö?
A: –ù–µ—Ç, ~70% –∑–¥–∞–Ω–∏–π –∏–º–µ—é—Ç –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä –≤ –ø—É–±–ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –û—Å—Ç–∞–ª—å–Ω—ã–µ - –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –†–æ—Å—Ä–µ–µ—Å—Ç—Ä–∞.

---

## Troubleshooting

### –û—à–∏–±–∫–∞: "Dadata API keys not configured"
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å `DADATA_API_KEY` –∏ `DADATA_SECRET_KEY` –≤ `.env`

### –û—à–∏–±–∫–∞: "401 Unauthorized"
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–µ–π, –≤–æ–∑–º–æ–∂–Ω–æ –∏—Å—Ç—ë–∫ –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤

### –û—à–∏–±–∫–∞: "429 Too Many Requests"
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É. –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏.

---

## –°—Å—ã–ª–∫–∏

- **Dadata API:** https://dadata.ru/api/
- **–§–ò–ê–°:** https://fias.nalog.ru/
- **–†–æ—Å—Ä–µ–µ—Å—Ç—Ä:** https://rosreestr.gov.ru/
- **–ü—É–±–ª–∏—á–Ω–∞—è –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–∞—è –∫–∞—Ä—Ç–∞:** https://pkk.rosreestr.ru/

---

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üéâ  
–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.
