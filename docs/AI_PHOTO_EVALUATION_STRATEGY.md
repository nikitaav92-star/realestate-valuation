## AI-–æ—Ü–µ–Ω–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º

**Date:** 2025-10-11  
**Goal:** –ê–Ω–∞–ª–∏–∑ 50,000+ —Ñ–æ—Ç–æ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∑–∞—Ç—Ä–∞—Ç–∞–º–∏

---

## üéØ –¶–µ–ª—å

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GPT-4 Vision –∏–ª–∏ Claude –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º –∏ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ 1-5 –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ —Ü–µ–Ω—ã.

---

## üìä –°—Ç—Ä–∞—Ç–µ–≥–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç

### –í–∞—Ä–∏–∞–Ω—Ç 1: OpenAI GPT-4 Vision (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

**API:** GPT-4 Turbo with Vision

**–¶–µ–Ω—ã:**
- Input: $0.01 / 1K tokens
- **Images:** $0.01275 per image (high detail)
- **Images:** $0.00425 per image (low detail)

**–î–ª—è 50,000 –æ–±—ä—è–≤–ª–µ–Ω–∏–π:**
- –û–±—ä—è–≤–ª–µ–Ω–∏–π: 50,000
- –§–æ—Ç–æ –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ: 1 (–≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ)
- –†–µ–∂–∏–º: low detail
- **–°—Ç–æ–∏–º–æ—Å—Ç—å: 50,000 √ó $0.00425 = $212.50**

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å low detail mode
- –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ 1 –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ
- Batch processing (50 —Ñ–æ—Ç–æ –∑–∞ —Ä–∞–∑)
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: Claude 3.5 Sonnet (–ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ê)

**API:** Claude 3.5 Sonnet with vision

**–¶–µ–Ω—ã:**
- Input: $3 / 1M tokens
- **Images:** –°—á–∏—Ç–∞—é—Ç—Å—è –∫–∞–∫ ~1,600 tokens (~$0.0048)

**–î–ª—è 50,000 –æ–±—ä—è–≤–ª–µ–Ω–∏–π:**
- **–°—Ç–æ–∏–º–æ—Å—Ç—å: 50,000 √ó $0.0048 = $240**

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –õ—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏–∑–∞
- –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è
- –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: Hybrid (–û–ü–¢–ò–ú–ê–õ–¨–ù–´–ô)

**–ü–æ–¥—Ö–æ–¥:**
1. GPT-4 Vision (low detail) –¥–ª—è bulk –æ—Ü–µ–Ω–∫–∏
2. Claude 3.5 –¥–ª—è —Å–ø–æ—Ä–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
3. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ—Ü–µ–Ω–æ–∫

**–î–ª—è 50,000 –æ–±—ä—è–≤–ª–µ–Ω–∏–π:**
- GPT-4 Vision: 48,000 √ó $0.00425 = $204
- Claude 3.5: 2,000 √ó $0.0048 = $9.60
- **–ò—Ç–æ–≥–æ: $213.60**

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –≠—Ç–∞–ø 1: –°–±–æ—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π

```
CIAN API ‚Üí Extract photo URLs ‚Üí Save to DB
```

### –≠—Ç–∞–ø 2: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ

```
DB (URLs) ‚Üí Download images ‚Üí Save locally/S3
```

### –≠—Ç–∞–ø 3: AI –æ—Ü–µ–Ω–∫–∞

```
Images ‚Üí GPT-4 Vision API ‚Üí Condition rating (1-5) ‚Üí Save to DB
```

### –≠—Ç–∞–ø 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ

```
Listings + Condition ‚Üí Price adjustment ‚Üí Better estimates
```

---

## üìã –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î

### –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã:

```sql
-- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
CREATE TABLE listing_photos (
    id BIGSERIAL PRIMARY KEY,
    listing_id BIGINT NOT NULL REFERENCES listings(id) ON DELETE CASCADE,
    photo_url TEXT NOT NULL,
    photo_order INT DEFAULT 0,  -- –ü–æ—Ä—è–¥–æ–∫ (0 = –≥–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ)
    is_main BOOLEAN DEFAULT FALSE,
    downloaded BOOLEAN DEFAULT FALSE,
    local_path TEXT,  -- –ü—É—Ç—å –∫ —Å–∫–∞—á–∞–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É
    s3_url TEXT,  -- URL –≤ S3 (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(listing_id, photo_url)
);

CREATE INDEX idx_listing_photos_listing ON listing_photos(listing_id);
CREATE INDEX idx_listing_photos_main ON listing_photos(listing_id, is_main) WHERE is_main;
CREATE INDEX idx_listing_photos_downloaded ON listing_photos(downloaded) WHERE NOT downloaded;

-- AI –æ—Ü–µ–Ω–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
CREATE TABLE listing_condition_ratings (
    id BIGSERIAL PRIMARY KEY,
    listing_id BIGINT NOT NULL REFERENCES listings(id) ON DELETE CASCADE,
    condition_score INT NOT NULL CHECK (condition_score BETWEEN 1 AND 5),
    condition_label TEXT NOT NULL,  -- excellent, good, fair, poor, very_poor
    ai_model TEXT NOT NULL,  -- gpt-4-vision, claude-3.5-sonnet
    ai_analysis TEXT,  -- –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—Ç AI
    confidence NUMERIC(3,2),  -- –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (0.00-1.00)
    analyzed_at TIMESTAMPTZ DEFAULT NOW(),
    cost_usd NUMERIC(10,4),  -- –°—Ç–æ–∏–º–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞
    
    -- –î–µ—Ç–∞–ª–∏ –∞–Ω–∞–ª–∏–∑–∞
    repair_quality TEXT,  -- excellent, good, average, poor
    furniture_condition TEXT,
    cleanliness TEXT,
    modern_design BOOLEAN,
    needs_renovation BOOLEAN,
    
    UNIQUE(listing_id)  -- –û–¥–Ω–∞ –æ—Ü–µ–Ω–∫–∞ –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
);

CREATE INDEX idx_condition_ratings_listing ON listing_condition_ratings(listing_id);
CREATE INDEX idx_condition_ratings_score ON listing_condition_ratings(condition_score);
CREATE INDEX idx_condition_ratings_analyzed ON listing_condition_ratings(analyzed_at DESC);

COMMENT ON TABLE listing_photos IS 'Photos from CIAN listings';
COMMENT ON TABLE listing_condition_ratings IS 'AI-based condition ratings (1-5 scale)';
COMMENT ON COLUMN listing_condition_ratings.condition_score IS '1=very poor, 2=poor, 3=fair, 4=good, 5=excellent';
```

---

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –®–∞–≥ 1: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π

**–û–±–Ω–æ–≤–∏—Ç—å mapper:**

```python
# etl/collector_cian/mapper_v2.py

def extract_photo_urls(offer: Dict[str, Any]) -> List[str]:
    """Extract photo URLs from offer.
    
    Returns
    -------
    list[str]
        List of photo URLs (ordered, main photo first)
    """
    photo_urls = []
    
    # Try different possible paths in API response
    for key in ("photos", "images", "photoUrls", "photo"):
        photos = offer.get(key)
        
        if isinstance(photos, list):
            for photo in photos:
                if isinstance(photo, dict):
                    # Extract URL from dict
                    url = photo.get("fullUrl") or photo.get("url") or photo.get("link")
                    if url:
                        photo_urls.append(str(url))
                elif isinstance(photo, str):
                    photo_urls.append(photo)
        elif isinstance(photos, dict):
            url = photos.get("fullUrl") or photos.get("url")
            if url:
                photo_urls.append(str(url))
    
    return photo_urls
```

---

### –®–∞–≥ 2: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–î–≤–∞ –ø–æ–¥—Ö–æ–¥–∞:**

#### A. –•—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ URLs (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ—Ç –∑–∞—Ç—Ä–∞—Ç –Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ
- –ë—ã—Å—Ç—Ä—ã–π —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
- –§–æ—Ç–æ –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç CIAN CDN
- –§–æ—Ç–æ –º–æ–≥—É—Ç —É–¥–∞–ª–∏—Ç—å—Å—è

#### B. –°–∫–∞—á–∏–≤–∞—Ç—å –∏ —Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ/S3

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç CIAN
- –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ (~10 GB –¥–ª—è 50k)
- –ú–µ–¥–ª–µ–Ω–Ω–µ–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞—á–∞—Ç—å —Å URLs, —Å–∫–∞—á–∏–≤–∞—Ç—å –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

---

### –®–∞–≥ 3: AI –æ—Ü–µ–Ω–∫–∞

#### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è GPT-4 Vision:

```python
import openai
import base64

def analyze_apartment_condition(image_url: str) -> dict:
    """Analyze apartment condition using GPT-4 Vision.
    
    Parameters
    ----------
    image_url : str
        URL of apartment photo
        
    Returns
    -------
    dict
        {
            'condition_score': 1-5,
            'condition_label': 'excellent' | 'good' | 'fair' | 'poor' | 'very_poor',
            'analysis': 'Detailed description',
            'repair_quality': 'excellent' | 'good' | 'average' | 'poor',
            'needs_renovation': True | False,
            'confidence': 0.0-1.0
        }
    """
    
    prompt = """–û—Ü–µ–Ω–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 5:

1 - –û—á–µ–Ω—å –ø–ª–æ—Ö–æ–µ (—Ç—Ä–µ–±—É–µ—Ç –∫–∞–ø–∏—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞, —Å—Ç–∞—Ä–∞—è –æ—Ç–¥–µ–ª–∫–∞, –≤–∏–¥–∏–º—ã–µ –¥–µ—Ñ–µ–∫—Ç—ã)
2 - –ü–ª–æ—Ö–æ–µ (—Ç—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞, —É—Å—Ç–∞—Ä–µ–≤—à–∞—è –æ—Ç–¥–µ–ª–∫–∞, –∏–∑–Ω–æ—Å)
3 - –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ–µ (–∂–∏–ª–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –Ω–æ –Ω–µ –Ω–æ–≤–æ–µ)
4 - –•–æ—Ä–æ—à–µ–µ (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ–º–æ–Ω—Ç, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Ç–¥–µ–ª–∫–∞)
5 - –û—Ç–ª–∏—á–Ω–æ–µ (–Ω–æ–≤—ã–π —Ä–µ–º–æ–Ω—Ç, –ø—Ä–µ–º–∏—É–º –æ—Ç–¥–µ–ª–∫–∞, –¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—å–µ—Ä)

–û—Ç–≤–µ—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{
  "condition_score": 1-5,
  "condition_label": "excellent/good/fair/poor/very_poor",
  "repair_quality": "excellent/good/average/poor",
  "cleanliness": "excellent/good/average/poor",
  "modern_design": true/false,
  "needs_renovation": true/false,
  "confidence": 0.0-1.0,
  "analysis": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)"
}"""
    
    response = openai.ChatCompletion.create(
        model="gpt-4-vision-preview",
        messages=[
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": prompt},
                    {
                        "type": "image_url",
                        "image_url": {
                            "url": image_url,
                            "detail": "low"  # –í–ê–ñ–ù–û: low –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏!
                        }
                    }
                ]
            }
        ],
        max_tokens=300,  # –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –æ—Ç–≤–µ—Ç
        temperature=0.3,  # –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
    )
    
    # Parse JSON response
    import json
    result = json.loads(response.choices[0].message.content)
    return result
```

---

## üí∞ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞—Ç—Ä–∞—Ç

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: Batch Processing (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

**–ü–æ–¥—Ö–æ–¥:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–æ 100 –æ–±—ä—è–≤–ª–µ–Ω–∏–π –∑–∞ —Ä–∞–∑

```python
async def analyze_batch(photo_urls: List[str]) -> List[dict]:
    """Analyze multiple photos in parallel."""
    import asyncio
    
    # Use async to process 10 at a time
    semaphore = asyncio.Semaphore(10)
    
    async def analyze_one(url):
        async with semaphore:
            return analyze_apartment_condition(url)
    
    tasks = [analyze_one(url) for url in photo_urls]
    results = await asyncio.gather(*tasks)
    
    return results
```

**–≠–∫–æ–Ω–æ–º–∏—è:** –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–∫–æ—Ä—è–µ—Ç –≤ 10x

---

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü–æ–¥—Ö–æ–¥:** –ù–µ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ

```python
def get_or_analyze_condition(listing_id: int, photo_url: str):
    """Get cached rating or analyze if new."""
    
    # Check if already analyzed
    cached = get_cached_rating(listing_id)
    if cached:
        return cached
    
    # Analyze and cache
    rating = analyze_apartment_condition(photo_url)
    cache_rating(listing_id, rating)
    
    return rating
```

**–≠–∫–æ–Ω–æ–º–∏—è:** 0% –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏

---

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è 3: –í—ã–±–æ—Ä–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑

**–ü–æ–¥—Ö–æ–¥:** –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è

```python
def should_analyze(listing):
    """Decide if listing needs AI analysis."""
    
    # Analyze if:
    # 1. Price anomaly (too high/low for area)
    # 2. New listing (first_seen today)
    # 3. Price changed recently
    # 4. Missing manual rating
    
    if listing.price / listing.area_total > 300000:  # >300k per sqm
        return True
    
    if (datetime.now() - listing.first_seen).days < 1:
        return True
    
    return False
```

**–≠–∫–æ–Ω–æ–º–∏—è:** –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ 20-30% ‚Üí **$42-64 –≤–º–µ—Å—Ç–æ $212**

---

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è 4: Hybrid (GPT-4 + Claude)

**–ü–æ–¥—Ö–æ–¥:**
1. –ë—ã—Å—Ç—Ä–∞—è –æ—Ü–µ–Ω–∫–∞ GPT-4 Vision (low detail) - $0.00425
2. –ï—Å–ª–∏ confidence < 0.7 ‚Üí Claude 3.5 - $0.0048
3. –ï—Å–ª–∏ —Ü–µ–Ω–∞ >20 –º–ª–Ω ‚Üí Claude 3.5 (—Ç–æ—á–Ω–µ–µ)

**–î–ª—è 50,000:**
- GPT-4 (80%): 40,000 √ó $0.00425 = $170
- Claude (20%): 10,000 √ó $0.0048 = $48
- **–ò—Ç–æ–≥–æ: $218**

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ/—Ü–µ–Ω–∞
- –¢–æ—á–Ω–æ—Å—Ç—å –¥–ª—è –¥–æ—Ä–æ–≥–∏—Ö –∫–≤–∞—Ä—Ç–∏—Ä
- –≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞—è—Ö

---

## üèóÔ∏è –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î

```sql
-- Apply: db/schema_v3_with_photos.sql
psql -h localhost -U realuser -d realdb -f db/schema_v3_with_photos.sql
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ mapper

```python
# etl/collector_cian/mapper_v3.py

from etl.models_v3 import Listing, ListingPhoto

def to_listing_with_photos(offer: Dict) -> tuple[Listing, List[ListingPhoto]]:
    """Extract listing and photos."""
    
    listing = to_listing(offer)
    
    photo_urls = extract_photo_urls(offer)
    photos = [
        ListingPhoto(
            listing_id=listing.id,
            photo_url=url,
            photo_order=i,
            is_main=(i == 0),
        )
        for i, url in enumerate(photo_urls)
    ]
    
    return listing, photos
```

### 3. AI –º–æ–¥—É–ª—å

```python
# etl/ai_evaluator/photo_analyzer.py

class PhotoAnalyzer:
    """AI-based photo analysis."""
    
    def __init__(self, provider: str = "openai"):
        self.provider = provider
        if provider == "openai":
            self.client = openai.OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
        elif provider == "anthropic":
            self.client = anthropic.Anthropic(api_key=os.getenv("ANTHROPIC_API_KEY"))
    
    def analyze_condition(
        self,
        photo_url: str,
        *,
        detail: str = "low",
    ) -> ConditionRating:
        """Analyze apartment condition."""
        
        if self.provider == "openai":
            return self._analyze_openai(photo_url, detail)
        else:
            return self._analyze_claude(photo_url)
```

### 4. Batch processor

```python
# etl/ai_evaluator/batch_processor.py

class BatchProcessor:
    """Process photos in batches for cost efficiency."""
    
    def __init__(self, batch_size: int = 50):
        self.batch_size = batch_size
        self.analyzer = PhotoAnalyzer("openai")
    
    async def process_listings(
        self,
        listing_ids: List[int],
    ) -> dict:
        """Process multiple listings."""
        
        total_cost = 0
        total_analyzed = 0
        
        for i in range(0, len(listing_ids), self.batch_size):
            batch = listing_ids[i:i + self.batch_size]
            
            # Analyze batch
            for listing_id in batch:
                rating = await self.analyze_listing(listing_id)
                total_cost += rating.cost_usd
                total_analyzed += 1
            
            # Progress
            print(f"Analyzed {total_analyzed}/{len(listing_ids)} "
                  f"(${total_cost:.2f})")
            
            # Rate limit
            await asyncio.sleep(1)
        
        return {
            "total_analyzed": total_analyzed,
            "total_cost": total_cost,
            "avg_cost": total_cost / total_analyzed,
        }
```

---

## üí° –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã - –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω

### –ü–ª–∞–Ω A: URL-only + On-demand –∞–Ω–∞–ª–∏–∑ (–ú–ò–ù–ò–ú–£–ú)

**–ü–æ–¥—Ö–æ–¥:**
1. –°–æ–±–∏—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ URLs —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
2. –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å AI —Ç–æ–ª—å–∫–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–ó–∞—Ç—Ä–∞—Ç—ã:**
- –°–±–æ—Ä URLs: $0
- AI –∞–Ω–∞–ª–∏–∑: $0.00425 –∑–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É)
- –î–ª—è 1000 –æ–±—ä—è–≤–ª–µ–Ω–∏–π: $4.25

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
# –í –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
@app.route('/listings/<int:listing_id>/analyze')
def analyze_listing(listing_id):
    """Analyze listing condition on demand."""
    
    # Check cache
    rating = get_cached_rating(listing_id)
    if rating:
        return jsonify(rating)
    
    # Get main photo
    photo_url = get_main_photo_url(listing_id)
    
    # Analyze
    rating = analyzer.analyze_condition(photo_url)
    
    # Cache
    save_rating(listing_id, rating)
    
    return jsonify(rating)
```

---

### –ü–ª–∞–Ω B: Pre-analyze –≤–∞–∂–Ω—ã–µ (–û–ü–¢–ò–ú–ê–õ–¨–ù–´–ô)

**–ü–æ–¥—Ö–æ–¥:**
1. –°–æ–±—Ä–∞—Ç—å URLs –≤—Å–µ—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
2. AI –∞–Ω–∞–ª–∏–∑ —Ç–æ–ª—å–∫–æ –¥–ª—è:
   - –¶–µ–Ω–∞ >15 –º–ª–Ω (–ø—Ä–µ–º–∏—É–º —Å–µ–≥–º–µ–Ω—Ç)
   - –ê–Ω–æ–º–∞–ª–∏–∏ —Ü–µ–Ω—ã (—Å–ª–∏—à–∫–æ–º –¥–µ—à–µ–≤–æ/–¥–æ—Ä–æ–≥–æ)
   - –ù–æ–≤—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è

**–ó–∞—Ç—Ä–∞—Ç—ã:**
- 30% –æ—Ç 50,000 = 15,000 –æ–±—ä—è–≤–ª–µ–Ω–∏–π
- 15,000 √ó $0.00425 = **$63.75**

**ROI:**
- –§–æ–∫—É—Å –Ω–∞ –≤–∞–∂–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏—è—Ö
- –≠–∫–æ–Ω–æ–º–∏—è 70%
- –õ—É—á—à–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –æ—Ü–µ–Ω–∫–∏

---

### –ü–ª–∞–Ω C: –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π (–ú–ê–ö–°–ò–ú–£–ú)

**–ü–æ–¥—Ö–æ–¥:**
1. –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ 50,000
2. Low detail mode
3. Batch processing
4. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ó–∞—Ç—Ä–∞—Ç—ã:**
- 50,000 √ó $0.00425 = **$212.50**

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GPT-4o-mini (–¥–µ—à–µ–≤–ª–µ): $85
- –ò–ª–∏ —Ç–æ–ª—å–∫–æ 1-2 —Ñ–æ—Ç–æ –≤–º–µ—Å—Ç–æ –≤—Å–µ—Ö: $106

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

### –§–∞–∑–∞ 1: URL Collection (–°–µ–π—á–∞—Å)

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
```python
# 1. –û–±–Ω–æ–≤–∏—Ç—å mapper
def to_listing_with_photos(offer):
    listing = to_listing(offer)
    photo_urls = extract_photo_urls(offer)
    return listing, photo_urls

# 2. –°–æ—Ö—Ä–∞–Ω—è—Ç—å URLs –≤ –ë–î
for offer in offers:
    listing, photo_urls = to_listing_with_photos(offer)
    save_listing(listing)
    save_photo_urls(listing.id, photo_urls)
```

**–°—Ç–æ–∏–º–æ—Å—Ç—å:** $0  
**–í—Ä–µ–º—è:** +0 (–≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–≥–æ —Å–±–æ—Ä–∞)

---

### –§–∞–∑–∞ 2: Selective AI Analysis (–ü–æ–∑–∂–µ)

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
```python
# –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –≤–∞–∂–Ω—ã–µ
important_listings = """
SELECT id FROM listings 
WHERE price > 15000000 
   OR price / area_total > 250000
   OR first_seen > NOW() - INTERVAL '1 day'
LIMIT 15000
"""

# –ó–∞–ø—É—Å—Ç–∏—Ç—å batch –∞–Ω–∞–ª–∏–∑
python -m etl.ai_evaluator.cli analyze \
    --batch-size 50 \
    --model gpt-4-vision \
    --detail low \
    --filter important
```

**–°—Ç–æ–∏–º–æ—Å—Ç—å:** $63.75  
**–í—Ä–µ–º—è:** ~4 —á–∞—Å–∞

---

### –§–∞–∑–∞ 3: Price Adjustment (–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)

**–§–æ—Ä–º—É–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ —Ü–µ–Ω—ã:**

```python
def adjust_price_by_condition(
    base_price: float,
    condition_score: int,
) -> float:
    """Adjust price based on condition rating.
    
    Adjustments:
    - Score 5 (excellent): +10%
    - Score 4 (good): +5%
    - Score 3 (fair): 0%
    - Score 2 (poor): -10%
    - Score 1 (very poor): -20%
    """
    
    adjustments = {
        5: 1.10,  # +10%
        4: 1.05,  # +5%
        3: 1.00,  # 0%
        2: 0.90,  # -10%
        1: 0.80,  # -20%
    }
    
    multiplier = adjustments.get(condition_score, 1.0)
    return base_price * multiplier
```

**SQL View:**

```sql
CREATE VIEW v_listings_adjusted_price AS
SELECT 
    l.*,
    lp.price AS original_price,
    lcr.condition_score,
    CASE 
        WHEN lcr.condition_score = 5 THEN lp.price * 1.10
        WHEN lcr.condition_score = 4 THEN lp.price * 1.05
        WHEN lcr.condition_score = 3 THEN lp.price * 1.00
        WHEN lcr.condition_score = 2 THEN lp.price * 0.90
        WHEN lcr.condition_score = 1 THEN lp.price * 0.80
        ELSE lp.price
    END AS adjusted_price
FROM listings l
JOIN LATERAL (...) lp ON true
LEFT JOIN listing_condition_ratings lcr ON l.id = lcr.listing_id;
```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

| –ü–æ–¥—Ö–æ–¥ | –û–±—ä—è–≤–ª–µ–Ω–∏–π | –°—Ç–æ–∏–º–æ—Å—Ç—å | –í—Ä–µ–º—è | –ö–∞—á–µ—Å—Ç–≤–æ |
|--------|------------|-----------|-------|----------|
| **URL only** | 50,000 | $0 | 0—á | - |
| **On-demand** | ~1,000 | $4 | 1—á | –í—ã—Å–æ–∫–æ–µ |
| **Selective (30%)** | 15,000 | $64 | 4—á | –í—ã—Å–æ–∫–æ–µ |
| **Full (low detail)** | 50,000 | $213 | 12—á | –°—Ä–µ–¥–Ω–µ–µ |
| **Full (high detail)** | 50,000 | $637 | 12—á | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ |

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

### –≠—Ç–∞–ø 1: –°–µ–π—á–∞—Å (–ë–µ—Å–ø–ª–∞—Ç–Ω–æ)

```bash
1. –°–æ–±—Ä–∞—Ç—å URLs —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π (–¥–æ–±–∞–≤–∏—Ç—å –≤ mapper)
2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î (listing_photos table)
3. –°—Ç–æ–∏–º–æ—Å—Ç—å: $0
```

### –≠—Ç–∞–ø 2: –ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é ($64)

```bash
1. –í—ã–±—Ä–∞—Ç—å –≤–∞–∂–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è (30%)
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å batch AI –∞–Ω–∞–ª–∏–∑
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫–∏ –≤ –ë–î
4. –°—Ç–æ–∏–º–æ—Å—Ç—å: $64
```

### –≠—Ç–∞–ø 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```bash
1. –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ –≤ UI
2. –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω—ã
3. –§–∏–ª—å—Ç—Ä –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é
4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π
```

---

## üõ†Ô∏è Implementation Files

### –°–æ–∑–¥–∞–º —Å–ª–µ–¥—É—é—â–∏–µ —Ñ–∞–π–ª—ã:

1. `db/schema_v3_with_photos.sql` - –°—Ö–µ–º–∞ —Å —Ñ–æ—Ç–æ
2. `etl/models_v3.py` - –ú–æ–¥–µ–ª–∏ —Å —Ñ–æ—Ç–æ
3. `etl/collector_cian/mapper_v3.py` - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–æ—Ç–æ
4. `etl/ai_evaluator/__init__.py` - AI –º–æ–¥—É–ª—å
5. `etl/ai_evaluator/photo_analyzer.py` - –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä
6. `etl/ai_evaluator/batch_processor.py` - Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞
7. `etl/ai_evaluator/cli.py` - CLI –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
8. `scripts/analyze_conditions.py` - Production —Å–∫—Ä–∏–ø—Ç

---

## üí∞ –ò—Ç–æ–≥–æ–≤—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã

### –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:

```
–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö + URLs: $0.50
AI –∞–Ω–∞–ª–∏–∑ (30%):     $64
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û:               $64.50

ROI:
- –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ —Ü–µ–Ω
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π
- –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ
```

### –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:

```
–§–∞–∑–∞ 1: –°–æ–±—Ä–∞—Ç—å URLs           $0
–§–∞–∑–∞ 2: –ê–Ω–∞–ª–∏–∑ –≤–∞–∂–Ω—ã—Ö (15k)    $64
–§–∞–∑–∞ 3: On-demand –∞–Ω–∞–ª–∏–∑       $4 (–ø–æ –∑–∞–ø—Ä–æ—Å—É)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫:           $64
–ü–æ–¥–¥–µ—Ä–∂–∫–∞ (–º–µ—Å—è—Ü):            $10-20
```

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:
1. ‚è≥ –û–±–Ω–æ–≤–∏—Ç—å mapper –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è URLs —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
2. ‚è≥ –†–∞—Å—à–∏—Ä–∏—Ç—å —Å—Ö–µ–º—É –ë–î (listing_photos)
3. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ

### –ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ:
1. ‚è≥ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å AI –º–æ–¥—É–ª—å (GPT-4 Vision)
2. ‚è≥ –°–æ–∑–¥–∞—Ç—å batch processor
3. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 100 –æ–±—ä—è–≤–ª–µ–Ω–∏—è—Ö

### –í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ:
1. ‚è≥ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ 15,000 –≤–∞–∂–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π
2. ‚è≥ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ü–µ–Ω–∫–∏ –≤ UI
3. ‚è≥ –°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π

---

**Document owner:** Cursor AI  
**Last updated:** 2025-10-11  
**Status:** Strategy Defined, Ready to Implement

