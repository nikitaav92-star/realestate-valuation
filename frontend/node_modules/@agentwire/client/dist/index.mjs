var F=Object.defineProperty,k=Object.defineProperties;var J=Object.getOwnPropertyDescriptors;var j=Object.getOwnPropertySymbols;var B=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable;var z=(l,t,e)=>t in l?F(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e,x=(l,t)=>{for(var e in t||(t={}))B.call(t,e)&&z(l,e,t[e]);if(j)for(var e of j(t))q.call(t,e)&&z(l,e,t[e]);return l},R=(l,t)=>k(l,J(t));import{EventType as T}from"@agentwire/core";import{mergeMap as V}from"rxjs/operators";var v=l=>{if(typeof structuredClone=="function")return structuredClone(l);try{return JSON.parse(JSON.stringify(l))}catch(t){return x({},l)}};import{applyPatch as W}from"fast-json-patch";import Y from"untruncate-json";var I=l=>t=>{let e=v(l.messages),s=v(l.state),r,c=n=>[v(n)],o=()=>[];return t.pipe(V(n=>{var p;switch(n.type){case T.TEXT_MESSAGE_START:{let{messageId:E,role:S}=n,g={id:E,role:S,content:""};return e.push(g),c({messages:e})}case T.TEXT_MESSAGE_CONTENT:{let{delta:E}=n,S=e[e.length-1];return S.content=S.content+E,c({messages:e})}case T.TEXT_MESSAGE_END:return o();case T.TOOL_CALL_START:{let{toolCallId:E,toolCallName:S,parentMessageId:g}=n,i;return g&&e.length>0&&e[e.length-1].id===g?i=e[e.length-1]:(i={id:g||E,role:"assistant",toolCalls:[]},e.push(i)),(p=i.toolCalls)!=null||(i.toolCalls=[]),i.toolCalls.push({id:E,type:"function",function:{name:S,arguments:""}}),c({messages:e})}case T.TOOL_CALL_ARGS:{let{delta:E}=n,S=e[e.length-1],g=S.toolCalls[S.toolCalls.length-1];if(g.function.arguments+=E,r){let i=r.find(L=>L.tool===g.function.name);if(i)try{let L=JSON.parse(Y(g.function.arguments));return i.tool_argument&&i.tool_argument in L?(s=R(x({},s),{[i.state_key]:L[i.tool_argument]}),c({messages:e,state:s})):(s=R(x({},s),{[i.state_key]:L}),c({messages:e,state:s}))}catch(L){}}return c({messages:e})}case T.TOOL_CALL_END:return o();case T.STATE_SNAPSHOT:{let{snapshot:E}=n;return s=E,c({state:s})}case T.STATE_DELTA:{let{delta:E}=n;try{return s=W(s,E,!0,!1).newDocument,c({state:s})}catch(S){let g=S instanceof Error?S.message:String(S);return console.warn(`Failed to apply state patch:
Current state: ${JSON.stringify(s,null,2)}
Patch operations: ${JSON.stringify(E,null,2)}
Error: ${g}`),o()}}case T.MESSAGES_SNAPSHOT:{let{messages:E}=n;return e=E,c({messages:e})}case T.RAW:return o();case T.CUSTOM:{let E=n;return E.name==="PredictState"&&(r=E.value),o()}case T.RUN_STARTED:return o();case T.RUN_FINISHED:return o();case T.RUN_ERROR:return o();case T.STEP_STARTED:return o();case T.STEP_FINISHED:return r=void 0,o()}let u=n.type;return o()}))};import{EventType as m,AgentWireError as d}from"@agentwire/core";import{throwError as y,of as h}from"rxjs";import{mergeMap as K}from"rxjs/operators";var b=l=>{let t,e,s=!1,r=!1,c=!1,o=new Map;return l.pipe(K(n=>{let u=n.type;if(r)return y(()=>new d(`Cannot send event type '${u}': The run has already errored with 'RUN_ERROR'. No further events can be sent.`));if(s&&u!==m.RUN_ERROR)return y(()=>new d(`Cannot send event type '${u}': The run has already finished with 'RUN_FINISHED'. Start a new run with 'RUN_STARTED'.`));if(t!==void 0&&![m.TEXT_MESSAGE_CONTENT,m.TEXT_MESSAGE_END,m.RAW].includes(u))return y(()=>new d(`Cannot send event type '${u}' after 'TEXT_MESSAGE_START': Send 'TEXT_MESSAGE_END' first.`));if(e!==void 0&&![m.TOOL_CALL_ARGS,m.TOOL_CALL_END,m.RAW].includes(u))return u===m.TOOL_CALL_START?y(()=>new d("Cannot send 'TOOL_CALL_START' event: A tool call is already in progress. Complete it with 'TOOL_CALL_END' first.")):y(()=>new d(`Cannot send event type '${u}' after 'TOOL_CALL_START': Send 'TOOL_CALL_END' first.`));if(c){if(u===m.RUN_STARTED)return y(()=>new d("Cannot send multiple 'RUN_STARTED' events: A 'RUN_STARTED' event was already sent. Each run must have exactly one 'RUN_STARTED' event at the beginning."))}else if(c=!0,u!==m.RUN_STARTED&&u!==m.RUN_ERROR)return y(()=>new d("First event must be 'RUN_STARTED'"));switch(u){case m.TEXT_MESSAGE_START:return t!==void 0?y(()=>new d("Cannot send 'TEXT_MESSAGE_START' event: A text message is already in progress. Complete it with 'TEXT_MESSAGE_END' first.")):(t=n.messageId,h(n));case m.TEXT_MESSAGE_CONTENT:return t===void 0?y(()=>new d("Cannot send 'TEXT_MESSAGE_CONTENT' event: No active text message found. Start a text message with 'TEXT_MESSAGE_START' first.")):n.messageId!==t?y(()=>new d(`Cannot send 'TEXT_MESSAGE_CONTENT' event: Message ID mismatch. The ID '${n.messageId}' doesn't match the active message ID '${t}'.`)):h(n);case m.TEXT_MESSAGE_END:return t===void 0?y(()=>new d("Cannot send 'TEXT_MESSAGE_END' event: No active text message found. A 'TEXT_MESSAGE_START' event must be sent first.")):n.messageId!==t?y(()=>new d(`Cannot send 'TEXT_MESSAGE_END' event: Message ID mismatch. The ID '${n.messageId}' doesn't match the active message ID '${t}'.`)):(t=void 0,h(n));case m.TOOL_CALL_START:return e!==void 0?y(()=>new d("Cannot send 'TOOL_CALL_START' event: A tool call is already in progress. Complete it with 'TOOL_CALL_END' first.")):(e=n.toolCallId,h(n));case m.TOOL_CALL_ARGS:return e===void 0?y(()=>new d("Cannot send 'TOOL_CALL_ARGS' event: No active tool call found. Start a tool call with 'TOOL_CALL_START' first.")):n.toolCallId!==e?y(()=>new d(`Cannot send 'TOOL_CALL_ARGS' event: Tool call ID mismatch. The ID '${n.toolCallId}' doesn't match the active tool call ID '${e}'.`)):h(n);case m.TOOL_CALL_END:return e===void 0?y(()=>new d("Cannot send 'TOOL_CALL_END' event: No active tool call found. A 'TOOL_CALL_START' event must be sent first.")):n.toolCallId!==e?y(()=>new d(`Cannot send 'TOOL_CALL_END' event: Tool call ID mismatch. The ID '${n.toolCallId}' doesn't match the active tool call ID '${e}'.`)):(e=void 0,h(n));case m.STEP_STARTED:{let p=n.name;return o.has(p)?y(()=>new d(`Step "${p}" is already active for 'STEP_STARTED'`)):(o.set(p,!0),h(n))}case m.STEP_FINISHED:{let p=n.name;return o.has(p)?(o.delete(p),h(n)):y(()=>new d(`Cannot send 'STEP_FINISHED' for step "${p}" that was not started`))}case m.RUN_STARTED:return h(n);case m.RUN_FINISHED:{if(o.size>0){let p=Array.from(o.keys()).join(", ");return y(()=>new d(`Cannot send 'RUN_FINISHED' while steps are still active: ${p}`))}return s=!0,h(n)}case m.RUN_ERROR:return r=!0,h(n);case m.CUSTOM:return h(n);default:return h(n)}}))};import{EventSchemas as ae}from"@agentwire/core";import{Subject as oe,ReplaySubject as ce}from"rxjs";import{Observable as Q,from as Z,defer as ee,throwError as te}from"rxjs";import{switchMap as ne}from"rxjs/operators";var D=(l,t)=>ee(()=>Z(fetch(l,t))).pipe(ne(e=>{var c;let s={type:"headers",status:e.status,headers:e.headers},r=(c=e.body)==null?void 0:c.getReader();return r?new Q(o=>(o.next(s),(async()=>{try{for(;;){let{done:n,value:u}=await r.read();if(n)break;let p={type:"data",data:u};o.next(p)}o.complete()}catch(n){o.error(n)}})(),()=>{r.cancel()})):te(()=>new Error("Failed to getReader() from response"))}));import{Subject as se}from"rxjs";var w=l=>{let t=new se,e=new TextDecoder("utf-8",{fatal:!1}),s="";l.subscribe({next:c=>{if(c.type!=="headers"&&c.type==="data"&&c.data){let o=e.decode(c.data,{stream:!0});s+=o;let n=s.split(/\n\n/);s=n.pop()||"";for(let u of n)r(u)}},error:c=>t.error(c),complete:()=>{s&&(s+=e.decode(),r(s)),t.complete()}});function r(c){let o=c.split(`
`),n=[];for(let u of o)u.startsWith("data: ")&&n.push(u.slice(6));if(n.length>0)try{let u=n.join(`
`),p=JSON.parse(u);t.next(p)}catch(u){t.error(u)}}return t.asObservable()};import{Subject as re}from"rxjs";import*as X from"@agentwire/proto";var H=l=>{let t=new re,e=new Uint8Array(0);l.subscribe({next:r=>{if(r.type!=="headers"&&r.type==="data"&&r.data){let c=new Uint8Array(e.length+r.data.length);c.set(e,0),c.set(r.data,e.length),e=c,s()}},error:r=>t.error(r),complete:()=>{if(e.length>0)try{s()}catch(r){console.warn("Incomplete or invalid protocol buffer data at stream end")}t.complete()}});function s(){for(;e.length>=4;){let o=4+new DataView(e.buffer,e.byteOffset,4).getUint32(0,!1);if(e.length<o)break;try{let n=e.slice(4,o),u=X.decode(n);t.next(u),e=e.slice(o)}catch(n){let u=n instanceof Error?n.message:String(n);t.error(new Error(`Failed to decode protocol buffer message: ${u}`));return}}}return t.asObservable()};import*as $ from"@agentwire/proto";var P=l=>{let t=new oe,e=new ce,s=!1;return l.subscribe({next:r=>{e.next(r),r.type==="headers"&&!s?(s=!0,r.headers.get("content-type")===$.AGENTWIRE_MEDIA_TYPE?H(e).subscribe({next:o=>t.next(o),error:o=>t.error(o),complete:()=>t.complete()}):w(e).subscribe({next:o=>{try{let n=ae.parse(o);t.next(n)}catch(n){t.error(n)}},error:o=>t.error(o),complete:()=>t.complete()})):s||t.error(new Error("No headers event received before data events"))},error:r=>{e.error(r),t.error(r)},complete:()=>{e.complete()}}),t.asObservable()};import{mergeMap as Se}from"rxjs/operators";import{applyPatch as Te}from"fast-json-patch";import{EventType as A}from"@agentwire/core";import{z as a}from"zod";var f=a.enum(["TextMessageStart","TextMessageContent","TextMessageEnd","ActionExecutionStart","ActionExecutionArgs","ActionExecutionEnd","ActionExecutionResult","AgentStateMessage","MetaEvent","RunStarted","RunFinished","RunError","NodeStarted","NodeFinished"]),ie=a.enum(["LangGraphInterruptEvent","PredictState","Exit"]),le=a.object({type:a.literal(f.enum.TextMessageStart),messageId:a.string(),parentMessageId:a.string().optional()}),ue=a.object({type:a.literal(f.enum.TextMessageContent),messageId:a.string(),content:a.string()}),ge=a.object({type:a.literal(f.enum.TextMessageEnd),messageId:a.string()}),pe=a.object({type:a.literal(f.enum.ActionExecutionStart),actionExecutionId:a.string(),actionName:a.string(),parentMessageId:a.string().optional()}),Ee=a.object({type:a.literal(f.enum.ActionExecutionArgs),actionExecutionId:a.string(),args:a.string()}),fe=a.object({type:a.literal(f.enum.ActionExecutionEnd),actionExecutionId:a.string()}),me=a.object({type:a.literal(f.enum.ActionExecutionResult),actionName:a.string(),actionExecutionId:a.string(),result:a.string()}),de=a.object({type:a.literal(f.enum.AgentStateMessage),threadId:a.string(),agentName:a.string(),nodeName:a.string(),runId:a.string(),active:a.boolean(),role:a.string(),state:a.string(),running:a.boolean()}),ye=a.object({type:a.literal(f.enum.MetaEvent),name:ie,value:a.any()}),Ct=a.discriminatedUnion("type",[le,ue,ge,pe,Ee,fe,me,de,ye]),bt=a.object({id:a.string(),role:a.string(),content:a.string(),parentMessageId:a.string().optional()}),Ot=a.object({id:a.string(),name:a.string(),arguments:a.any(),parentMessageId:a.string().optional()}),Nt=a.object({id:a.string(),result:a.any(),actionExecutionId:a.string(),actionName:a.string()});import Ae from"untruncate-json";var U=(l,t,e)=>s=>{let r={},c=!0,o=!0,n="",u=null,p=null,E=[],S=g=>{typeof g=="object"&&g!==null&&("messages"in g&&delete g.messages,r=g)};return s.pipe(Se(g=>{switch(g.type){case A.TEXT_MESSAGE_START:{let i=g;return[{type:f.enum.TextMessageStart,messageId:i.messageId}]}case A.TEXT_MESSAGE_CONTENT:{let i=g;return[{type:f.enum.TextMessageContent,messageId:i.messageId,content:i.delta}]}case A.TEXT_MESSAGE_END:{let i=g;return[{type:f.enum.TextMessageEnd,messageId:i.messageId}]}case A.TOOL_CALL_START:{let i=g;return E.push({id:i.toolCallId,type:"function",function:{name:i.toolCallName,arguments:""}}),o=!0,[{type:f.enum.ActionExecutionStart,actionExecutionId:i.toolCallId,actionName:i.toolCallName,parentMessageId:i.parentMessageId}]}case A.TOOL_CALL_ARGS:{let i=g,L=E[E.length-1];L.function.arguments+=i.delta;let N=!1;if(p){let _=p.find(M=>M.tool==L.function.name);if(_)try{let M=JSON.parse(Ae(L.function.arguments));_.tool_argument&&_.tool_argument in M?(S(R(x({},r),{[_.state_key]:M[_.tool_argument]})),N=!0):_.tool_argument||(S(R(x({},r),{[_.state_key]:M})),N=!0)}catch(M){}}return[{type:f.enum.ActionExecutionArgs,actionExecutionId:i.toolCallId,args:i.delta},...N?[{type:f.enum.AgentStateMessage,threadId:l,agentName:e,nodeName:n,runId:t,running:c,role:"assistant",state:JSON.stringify(r),active:o}]:[]]}case A.TOOL_CALL_END:{let i=g;return[{type:f.enum.ActionExecutionEnd,actionExecutionId:i.toolCallId}]}case A.RAW:return[];case A.CUSTOM:{let i=g;switch(i.name){case"Exit":c=!1;break;case"PredictState":p=i.value;break}return[{type:f.enum.MetaEvent,name:i.name,value:i.value}]}case A.STATE_SNAPSHOT:return S(g.snapshot),[{type:f.enum.AgentStateMessage,threadId:l,agentName:e,nodeName:n,runId:t,running:c,role:"assistant",state:JSON.stringify(r),active:o}];case A.STATE_DELTA:{let L=Te(r,g.delta,!0,!1);return L?(S(L.newDocument),[{type:f.enum.AgentStateMessage,threadId:l,agentName:e,nodeName:n,runId:t,running:c,role:"assistant",state:JSON.stringify(r),active:o}]):[]}case A.MESSAGES_SNAPSHOT:return u=g.messages,[{type:f.enum.AgentStateMessage,threadId:l,agentName:e,nodeName:n,runId:t,running:c,role:"assistant",state:JSON.stringify(x(x({},r),u?{messages:u}:{})),active:!0}];case A.RUN_STARTED:return[];case A.RUN_FINISHED:return u&&(r.messages=u),[{type:f.enum.AgentStateMessage,threadId:l,agentName:e,nodeName:n,runId:t,running:c,role:"assistant",state:JSON.stringify(x(x({},r),u?{messages:ve(u)}:{})),active:!1}];case A.RUN_ERROR:return console.error("Run error",g),[];case A.STEP_STARTED:return n=g.stepName,E=[],p=null,[{type:f.enum.AgentStateMessage,threadId:l,agentName:e,nodeName:n,runId:t,running:c,role:"assistant",state:JSON.stringify(r),active:!0}];case A.STEP_FINISHED:return E=[],p=null,[{type:f.enum.AgentStateMessage,threadId:l,agentName:e,nodeName:n,runId:t,running:c,role:"assistant",state:JSON.stringify(r),active:!1}];default:return[]}}))};function ve(l){var e;let t=[];for(let s of l)if(s.role==="assistant"||s.role==="user"||s.role==="system"){if(s.content){let r={id:s.id,role:s.role,content:s.content};t.push(r)}if(s.role==="assistant"&&s.toolCalls&&s.toolCalls.length>0)for(let r of s.toolCalls){let c={id:r.id,name:r.function.name,arguments:JSON.parse(r.function.arguments),parentMessageId:s.id};t.push(c)}}else if(s.role==="tool"){let r="unknown";for(let o of l)if(o.role==="assistant"&&((e=o.toolCalls)!=null&&e.length)){for(let n of o.toolCalls)if(n.id===s.toolCallId){r=n.function.name;break}}let c={id:s.id,result:s.content,actionExecutionId:s.toolCallId,actionName:r};t.push(c)}return t}import{v4 as O}from"uuid";import{catchError as xe}from"rxjs/operators";import{finalize as Le}from"rxjs/operators";import{throwError as he,pipe as Re,Observable as _e}from"rxjs";var C=class{runAgent(t){var c;this.agentId=(c=this.agentId)!=null?c:O();let e=this.prepareRunAgentInput(t),s=this.run(e),r=this.apply(e);return Re(s,b,r,xe(o=>(this.onError(o),he(()=>o))),Le(()=>{this.onFinalize()}))}legacy_to_be_removed_runAgentBridged(t){var c;this.agentId=(c=this.agentId)!=null?c:O();let e=this.prepareRunAgentInput(t),s=this.run(e),r=U(this.threadId,e.runId,this.agentId);return new _e(o=>s().pipe(b,r).subscribe(o))}abortRun(){}constructor({agentId:t,description:e,threadId:s,initialMessages:r,initialState:c}={}){this.agentId=t,this.description=e!=null?e:"",this.threadId=s!=null?s:O(),this.messages=v(r!=null?r:[]),this.state=v(c!=null?c:{})}apply(t){return I({messages:t.messages,state:t.state})}prepareRunAgentInput(t){var e,s,r;return{threadId:this.threadId,runId:(t==null?void 0:t.runId)||O(),tools:v((e=t==null?void 0:t.tools)!=null?e:[]),context:v((s=t==null?void 0:t.context)!=null?s:[]),forwardedProps:v((r=t==null?void 0:t.forwardedProps)!=null?r:{}),state:v(this.state),messages:v(this.messages)}}onError(t){console.error("Agent execution failed:",t)}onFinalize(){}clone(){let t=Object.create(Object.getPrototypeOf(this));for(let e of Object.getOwnPropertyNames(this)){let s=this[e];typeof s!="function"&&(t[e]=v(s))}return t}};var G=class extends C{constructor(e){var s;super(e);this.abortController=new AbortController;this.url=e.url,this.headers=v((s=e.headers)!=null?s:{})}requestInit(e){return{method:"POST",headers:R(x({},this.headers),{"Content-Type":"application/json",Accept:"text/event-stream"}),body:JSON.stringify(e),signal:this.abortController.signal}}runAgent(e){var s;return this.abortController=(s=e==null?void 0:e.abortController)!=null?s:new AbortController,super.runAgent(e)}abortRun(){this.abortController.abort(),super.abortRun()}run(e){return()=>D(this.url,this.requestInit(e)).pipe(P)}};export*from"@agentwire/core";export{C as AbstractAgent,G as HttpAgent,U as convertToLegacyEvents,H as parseProtoStream,w as parseSSEStream,D as runHttpRequest,P as transformHttpEventStream,b as verifyEvents,I as withDefaultApplyEvents};
//# sourceMappingURL=index.mjs.map