"use strict";var le=Object.create;var N=Object.defineProperty,ue=Object.defineProperties,ge=Object.getOwnPropertyDescriptor,pe=Object.getOwnPropertyDescriptors,Ee=Object.getOwnPropertyNames,J=Object.getOwnPropertySymbols,fe=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty,me=Object.prototype.propertyIsEnumerable;var B=(o,t,e)=>t in o?N(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,v=(o,t)=>{for(var e in t||(t={}))q.call(t,e)&&B(o,e,t[e]);if(J)for(var e of J(t))me.call(t,e)&&B(o,e,t[e]);return o},R=(o,t)=>ue(o,pe(t));var de=(o,t)=>{for(var e in t)N(o,e,{get:t[e],enumerable:!0})},w=(o,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Ee(t))!q.call(o,r)&&r!==e&&N(o,r,{get:()=>t[r],enumerable:!(n=ge(t,r))||n.enumerable});return o},h=(o,t,e)=>(w(o,t,"default"),e&&w(e,t,"default")),H=(o,t,e)=>(e=o!=null?le(fe(o)):{},w(t||!o||!o.__esModule?N(e,"default",{value:o,enumerable:!0}):e,o)),ye=o=>w(N({},"__esModule",{value:!0}),o);var L={};de(L,{AbstractAgent:()=>b,HttpAgent:()=>F,convertToLegacyEvents:()=>$,parseProtoStream:()=>j,parseSSEStream:()=>G,runHttpRequest:()=>U,transformHttpEventStream:()=>X,verifyEvents:()=>I,withDefaultApplyEvents:()=>P});module.exports=ye(L);var S=require("@agentwire/core"),V=require("rxjs/operators");var A=o=>{if(typeof structuredClone=="function")return structuredClone(o);try{return JSON.parse(JSON.stringify(o))}catch(t){return v({},o)}};var W=require("fast-json-patch"),Y=H(require("untruncate-json"));var P=o=>t=>{let e=A(o.messages),n=A(o.state),r,i=s=>[A(s)],c=()=>[];return t.pipe((0,V.mergeMap)(s=>{var f;switch(s.type){case S.EventType.TEXT_MESSAGE_START:{let{messageId:m,role:y}=s,E={id:m,role:y,content:""};return e.push(E),i({messages:e})}case S.EventType.TEXT_MESSAGE_CONTENT:{let{delta:m}=s,y=e[e.length-1];return y.content=y.content+m,i({messages:e})}case S.EventType.TEXT_MESSAGE_END:return c();case S.EventType.TOOL_CALL_START:{let{toolCallId:m,toolCallName:y,parentMessageId:E}=s,u;return E&&e.length>0&&e[e.length-1].id===E?u=e[e.length-1]:(u={id:E||m,role:"assistant",toolCalls:[]},e.push(u)),(f=u.toolCalls)!=null||(u.toolCalls=[]),u.toolCalls.push({id:m,type:"function",function:{name:y,arguments:""}}),i({messages:e})}case S.EventType.TOOL_CALL_ARGS:{let{delta:m}=s,y=e[e.length-1],E=y.toolCalls[y.toolCalls.length-1];if(E.function.arguments+=m,r){let u=r.find(x=>x.tool===E.function.name);if(u)try{let x=JSON.parse((0,Y.default)(E.function.arguments));return u.tool_argument&&u.tool_argument in x?(n=R(v({},n),{[u.state_key]:x[u.tool_argument]}),i({messages:e,state:n})):(n=R(v({},n),{[u.state_key]:x}),i({messages:e,state:n}))}catch(x){}}return i({messages:e})}case S.EventType.TOOL_CALL_END:return c();case S.EventType.STATE_SNAPSHOT:{let{snapshot:m}=s;return n=m,i({state:n})}case S.EventType.STATE_DELTA:{let{delta:m}=s;try{return n=(0,W.applyPatch)(n,m,!0,!1).newDocument,i({state:n})}catch(y){let E=y instanceof Error?y.message:String(y);return console.warn(`Failed to apply state patch:
Current state: ${JSON.stringify(n,null,2)}
Patch operations: ${JSON.stringify(m,null,2)}
Error: ${E}`),c()}}case S.EventType.MESSAGES_SNAPSHOT:{let{messages:m}=s;return e=m,i({messages:e})}case S.EventType.RAW:return c();case S.EventType.CUSTOM:{let m=s;return m.name==="PredictState"&&(r=m.value),c()}case S.EventType.RUN_STARTED:return c();case S.EventType.RUN_FINISHED:return c();case S.EventType.RUN_ERROR:return c();case S.EventType.STEP_STARTED:return c();case S.EventType.STEP_FINISHED:return r=void 0,c()}let g=s.type;return c()}))};var l=require("@agentwire/core"),p=require("rxjs"),K=require("rxjs/operators"),I=o=>{let t,e,n=!1,r=!1,i=!1,c=new Map;return o.pipe((0,K.mergeMap)(s=>{let g=s.type;if(r)return(0,p.throwError)(()=>new l.AgentWireError(`Cannot send event type '${g}': The run has already errored with 'RUN_ERROR'. No further events can be sent.`));if(n&&g!==l.EventType.RUN_ERROR)return(0,p.throwError)(()=>new l.AgentWireError(`Cannot send event type '${g}': The run has already finished with 'RUN_FINISHED'. Start a new run with 'RUN_STARTED'.`));if(t!==void 0&&![l.EventType.TEXT_MESSAGE_CONTENT,l.EventType.TEXT_MESSAGE_END,l.EventType.RAW].includes(g))return(0,p.throwError)(()=>new l.AgentWireError(`Cannot send event type '${g}' after 'TEXT_MESSAGE_START': Send 'TEXT_MESSAGE_END' first.`));if(e!==void 0&&![l.EventType.TOOL_CALL_ARGS,l.EventType.TOOL_CALL_END,l.EventType.RAW].includes(g))return g===l.EventType.TOOL_CALL_START?(0,p.throwError)(()=>new l.AgentWireError("Cannot send 'TOOL_CALL_START' event: A tool call is already in progress. Complete it with 'TOOL_CALL_END' first.")):(0,p.throwError)(()=>new l.AgentWireError(`Cannot send event type '${g}' after 'TOOL_CALL_START': Send 'TOOL_CALL_END' first.`));if(i){if(g===l.EventType.RUN_STARTED)return(0,p.throwError)(()=>new l.AgentWireError("Cannot send multiple 'RUN_STARTED' events: A 'RUN_STARTED' event was already sent. Each run must have exactly one 'RUN_STARTED' event at the beginning."))}else if(i=!0,g!==l.EventType.RUN_STARTED&&g!==l.EventType.RUN_ERROR)return(0,p.throwError)(()=>new l.AgentWireError("First event must be 'RUN_STARTED'"));switch(g){case l.EventType.TEXT_MESSAGE_START:return t!==void 0?(0,p.throwError)(()=>new l.AgentWireError("Cannot send 'TEXT_MESSAGE_START' event: A text message is already in progress. Complete it with 'TEXT_MESSAGE_END' first.")):(t=s.messageId,(0,p.of)(s));case l.EventType.TEXT_MESSAGE_CONTENT:return t===void 0?(0,p.throwError)(()=>new l.AgentWireError("Cannot send 'TEXT_MESSAGE_CONTENT' event: No active text message found. Start a text message with 'TEXT_MESSAGE_START' first.")):s.messageId!==t?(0,p.throwError)(()=>new l.AgentWireError(`Cannot send 'TEXT_MESSAGE_CONTENT' event: Message ID mismatch. The ID '${s.messageId}' doesn't match the active message ID '${t}'.`)):(0,p.of)(s);case l.EventType.TEXT_MESSAGE_END:return t===void 0?(0,p.throwError)(()=>new l.AgentWireError("Cannot send 'TEXT_MESSAGE_END' event: No active text message found. A 'TEXT_MESSAGE_START' event must be sent first.")):s.messageId!==t?(0,p.throwError)(()=>new l.AgentWireError(`Cannot send 'TEXT_MESSAGE_END' event: Message ID mismatch. The ID '${s.messageId}' doesn't match the active message ID '${t}'.`)):(t=void 0,(0,p.of)(s));case l.EventType.TOOL_CALL_START:return e!==void 0?(0,p.throwError)(()=>new l.AgentWireError("Cannot send 'TOOL_CALL_START' event: A tool call is already in progress. Complete it with 'TOOL_CALL_END' first.")):(e=s.toolCallId,(0,p.of)(s));case l.EventType.TOOL_CALL_ARGS:return e===void 0?(0,p.throwError)(()=>new l.AgentWireError("Cannot send 'TOOL_CALL_ARGS' event: No active tool call found. Start a tool call with 'TOOL_CALL_START' first.")):s.toolCallId!==e?(0,p.throwError)(()=>new l.AgentWireError(`Cannot send 'TOOL_CALL_ARGS' event: Tool call ID mismatch. The ID '${s.toolCallId}' doesn't match the active tool call ID '${e}'.`)):(0,p.of)(s);case l.EventType.TOOL_CALL_END:return e===void 0?(0,p.throwError)(()=>new l.AgentWireError("Cannot send 'TOOL_CALL_END' event: No active tool call found. A 'TOOL_CALL_START' event must be sent first.")):s.toolCallId!==e?(0,p.throwError)(()=>new l.AgentWireError(`Cannot send 'TOOL_CALL_END' event: Tool call ID mismatch. The ID '${s.toolCallId}' doesn't match the active tool call ID '${e}'.`)):(e=void 0,(0,p.of)(s));case l.EventType.STEP_STARTED:{let f=s.name;return c.has(f)?(0,p.throwError)(()=>new l.AgentWireError(`Step "${f}" is already active for 'STEP_STARTED'`)):(c.set(f,!0),(0,p.of)(s))}case l.EventType.STEP_FINISHED:{let f=s.name;return c.has(f)?(c.delete(f),(0,p.of)(s)):(0,p.throwError)(()=>new l.AgentWireError(`Cannot send 'STEP_FINISHED' for step "${f}" that was not started`))}case l.EventType.RUN_STARTED:return(0,p.of)(s);case l.EventType.RUN_FINISHED:{if(c.size>0){let f=Array.from(c.keys()).join(", ");return(0,p.throwError)(()=>new l.AgentWireError(`Cannot send 'RUN_FINISHED' while steps are still active: ${f}`))}return n=!0,(0,p.of)(s)}case l.EventType.RUN_ERROR:return r=!0,(0,p.of)(s);case l.EventType.CUSTOM:return(0,p.of)(s);default:return(0,p.of)(s)}}))};var ne=require("@agentwire/core"),z=require("rxjs");var _=require("rxjs"),Q=require("rxjs/operators");var U=(o,t)=>(0,_.defer)(()=>(0,_.from)(fetch(o,t))).pipe((0,Q.switchMap)(e=>{var i;let n={type:"headers",status:e.status,headers:e.headers},r=(i=e.body)==null?void 0:i.getReader();return r?new _.Observable(c=>(c.next(n),(async()=>{try{for(;;){let{done:s,value:g}=await r.read();if(s)break;let f={type:"data",data:g};c.next(f)}c.complete()}catch(s){c.error(s)}})(),()=>{r.cancel()})):(0,_.throwError)(()=>new Error("Failed to getReader() from response"))}));var Z=require("rxjs");var G=o=>{let t=new Z.Subject,e=new TextDecoder("utf-8",{fatal:!1}),n="";o.subscribe({next:i=>{if(i.type!=="headers"&&i.type==="data"&&i.data){let c=e.decode(i.data,{stream:!0});n+=c;let s=n.split(/\n\n/);n=s.pop()||"";for(let g of s)r(g)}},error:i=>t.error(i),complete:()=>{n&&(n+=e.decode(),r(n)),t.complete()}});function r(i){let c=i.split(`
`),s=[];for(let g of c)g.startsWith("data: ")&&s.push(g.slice(6));if(s.length>0)try{let g=s.join(`
`),f=JSON.parse(g);t.next(f)}catch(g){t.error(g)}}return t.asObservable()};var ee=require("rxjs");var te=H(require("@agentwire/proto")),j=o=>{let t=new ee.Subject,e=new Uint8Array(0);o.subscribe({next:r=>{if(r.type!=="headers"&&r.type==="data"&&r.data){let i=new Uint8Array(e.length+r.data.length);i.set(e,0),i.set(r.data,e.length),e=i,n()}},error:r=>t.error(r),complete:()=>{if(e.length>0)try{n()}catch(r){console.warn("Incomplete or invalid protocol buffer data at stream end")}t.complete()}});function n(){for(;e.length>=4;){let c=4+new DataView(e.buffer,e.byteOffset,4).getUint32(0,!1);if(e.length<c)break;try{let s=e.slice(4,c),g=te.decode(s);t.next(g),e=e.slice(c)}catch(s){let g=s instanceof Error?s.message:String(s);t.error(new Error(`Failed to decode protocol buffer message: ${g}`));return}}}return t.asObservable()};var se=H(require("@agentwire/proto")),X=o=>{let t=new z.Subject,e=new z.ReplaySubject,n=!1;return o.subscribe({next:r=>{e.next(r),r.type==="headers"&&!n?(n=!0,r.headers.get("content-type")===se.AGENTWIRE_MEDIA_TYPE?j(e).subscribe({next:c=>t.next(c),error:c=>t.error(c),complete:()=>t.complete()}):G(e).subscribe({next:c=>{try{let s=ne.EventSchemas.parse(c);t.next(s)}catch(s){t.error(s)}},error:c=>t.error(c),complete:()=>t.complete()})):n||t.error(new Error("No headers event received before data events"))},error:r=>{e.error(r),t.error(r)},complete:()=>{e.complete()}}),t.asObservable()};var re=require("rxjs/operators"),ae=require("fast-json-patch"),T=require("@agentwire/core");var a=require("zod"),d=a.z.enum(["TextMessageStart","TextMessageContent","TextMessageEnd","ActionExecutionStart","ActionExecutionArgs","ActionExecutionEnd","ActionExecutionResult","AgentStateMessage","MetaEvent","RunStarted","RunFinished","RunError","NodeStarted","NodeFinished"]),Se=a.z.enum(["LangGraphInterruptEvent","PredictState","Exit"]),Te=a.z.object({type:a.z.literal(d.enum.TextMessageStart),messageId:a.z.string(),parentMessageId:a.z.string().optional()}),Ae=a.z.object({type:a.z.literal(d.enum.TextMessageContent),messageId:a.z.string(),content:a.z.string()}),ve=a.z.object({type:a.z.literal(d.enum.TextMessageEnd),messageId:a.z.string()}),xe=a.z.object({type:a.z.literal(d.enum.ActionExecutionStart),actionExecutionId:a.z.string(),actionName:a.z.string(),parentMessageId:a.z.string().optional()}),Le=a.z.object({type:a.z.literal(d.enum.ActionExecutionArgs),actionExecutionId:a.z.string(),args:a.z.string()}),he=a.z.object({type:a.z.literal(d.enum.ActionExecutionEnd),actionExecutionId:a.z.string()}),Re=a.z.object({type:a.z.literal(d.enum.ActionExecutionResult),actionName:a.z.string(),actionExecutionId:a.z.string(),result:a.z.string()}),_e=a.z.object({type:a.z.literal(d.enum.AgentStateMessage),threadId:a.z.string(),agentName:a.z.string(),nodeName:a.z.string(),runId:a.z.string(),active:a.z.boolean(),role:a.z.string(),state:a.z.string(),running:a.z.boolean()}),Me=a.z.object({type:a.z.literal(d.enum.MetaEvent),name:Se,value:a.z.any()}),dt=a.z.discriminatedUnion("type",[Te,Ae,ve,xe,Le,he,Re,_e,Me]),yt=a.z.object({id:a.z.string(),role:a.z.string(),content:a.z.string(),parentMessageId:a.z.string().optional()}),St=a.z.object({id:a.z.string(),name:a.z.string(),arguments:a.z.any(),parentMessageId:a.z.string().optional()}),Tt=a.z.object({id:a.z.string(),result:a.z.any(),actionExecutionId:a.z.string(),actionName:a.z.string()});var oe=H(require("untruncate-json"));var $=(o,t,e)=>n=>{let r={},i=!0,c=!0,s="",g=null,f=null,m=[],y=E=>{typeof E=="object"&&E!==null&&("messages"in E&&delete E.messages,r=E)};return n.pipe((0,re.mergeMap)(E=>{switch(E.type){case T.EventType.TEXT_MESSAGE_START:{let u=E;return[{type:d.enum.TextMessageStart,messageId:u.messageId}]}case T.EventType.TEXT_MESSAGE_CONTENT:{let u=E;return[{type:d.enum.TextMessageContent,messageId:u.messageId,content:u.delta}]}case T.EventType.TEXT_MESSAGE_END:{let u=E;return[{type:d.enum.TextMessageEnd,messageId:u.messageId}]}case T.EventType.TOOL_CALL_START:{let u=E;return m.push({id:u.toolCallId,type:"function",function:{name:u.toolCallName,arguments:""}}),c=!0,[{type:d.enum.ActionExecutionStart,actionExecutionId:u.toolCallId,actionName:u.toolCallName,parentMessageId:u.parentMessageId}]}case T.EventType.TOOL_CALL_ARGS:{let u=E,x=m[m.length-1];x.function.arguments+=u.delta;let k=!1;if(f){let M=f.find(C=>C.tool==x.function.name);if(M)try{let C=JSON.parse((0,oe.default)(x.function.arguments));M.tool_argument&&M.tool_argument in C?(y(R(v({},r),{[M.state_key]:C[M.tool_argument]})),k=!0):M.tool_argument||(y(R(v({},r),{[M.state_key]:C})),k=!0)}catch(C){}}return[{type:d.enum.ActionExecutionArgs,actionExecutionId:u.toolCallId,args:u.delta},...k?[{type:d.enum.AgentStateMessage,threadId:o,agentName:e,nodeName:s,runId:t,running:i,role:"assistant",state:JSON.stringify(r),active:c}]:[]]}case T.EventType.TOOL_CALL_END:{let u=E;return[{type:d.enum.ActionExecutionEnd,actionExecutionId:u.toolCallId}]}case T.EventType.RAW:return[];case T.EventType.CUSTOM:{let u=E;switch(u.name){case"Exit":i=!1;break;case"PredictState":f=u.value;break}return[{type:d.enum.MetaEvent,name:u.name,value:u.value}]}case T.EventType.STATE_SNAPSHOT:return y(E.snapshot),[{type:d.enum.AgentStateMessage,threadId:o,agentName:e,nodeName:s,runId:t,running:i,role:"assistant",state:JSON.stringify(r),active:c}];case T.EventType.STATE_DELTA:{let x=(0,ae.applyPatch)(r,E.delta,!0,!1);return x?(y(x.newDocument),[{type:d.enum.AgentStateMessage,threadId:o,agentName:e,nodeName:s,runId:t,running:i,role:"assistant",state:JSON.stringify(r),active:c}]):[]}case T.EventType.MESSAGES_SNAPSHOT:return g=E.messages,[{type:d.enum.AgentStateMessage,threadId:o,agentName:e,nodeName:s,runId:t,running:i,role:"assistant",state:JSON.stringify(v(v({},r),g?{messages:g}:{})),active:!0}];case T.EventType.RUN_STARTED:return[];case T.EventType.RUN_FINISHED:return g&&(r.messages=g),[{type:d.enum.AgentStateMessage,threadId:o,agentName:e,nodeName:s,runId:t,running:i,role:"assistant",state:JSON.stringify(v(v({},r),g?{messages:Ce(g)}:{})),active:!1}];case T.EventType.RUN_ERROR:return console.error("Run error",E),[];case T.EventType.STEP_STARTED:return s=E.stepName,m=[],f=null,[{type:d.enum.AgentStateMessage,threadId:o,agentName:e,nodeName:s,runId:t,running:i,role:"assistant",state:JSON.stringify(r),active:!0}];case T.EventType.STEP_FINISHED:return m=[],f=null,[{type:d.enum.AgentStateMessage,threadId:o,agentName:e,nodeName:s,runId:t,running:i,role:"assistant",state:JSON.stringify(r),active:!1}];default:return[]}}))};function Ce(o){var e;let t=[];for(let n of o)if(n.role==="assistant"||n.role==="user"||n.role==="system"){if(n.content){let r={id:n.id,role:n.role,content:n.content};t.push(r)}if(n.role==="assistant"&&n.toolCalls&&n.toolCalls.length>0)for(let r of n.toolCalls){let i={id:r.id,name:r.function.name,arguments:JSON.parse(r.function.arguments),parentMessageId:n.id};t.push(i)}}else if(n.role==="tool"){let r="unknown";for(let c of o)if(c.role==="assistant"&&((e=c.toolCalls)!=null&&e.length)){for(let s of c.toolCalls)if(s.id===n.toolCallId){r=s.function.name;break}}let i={id:n.id,result:n.content,actionExecutionId:n.toolCallId,actionName:r};t.push(i)}return t}var D=require("uuid");var ce=require("rxjs/operators"),ie=require("rxjs/operators"),O=require("rxjs");var b=class{runAgent(t){var i;this.agentId=(i=this.agentId)!=null?i:(0,D.v4)();let e=this.prepareRunAgentInput(t),n=this.run(e),r=this.apply(e);return(0,O.pipe)(n,I,r,(0,ce.catchError)(c=>(this.onError(c),(0,O.throwError)(()=>c))),(0,ie.finalize)(()=>{this.onFinalize()}))}legacy_to_be_removed_runAgentBridged(t){var i;this.agentId=(i=this.agentId)!=null?i:(0,D.v4)();let e=this.prepareRunAgentInput(t),n=this.run(e),r=$(this.threadId,e.runId,this.agentId);return new O.Observable(c=>n().pipe(I,r).subscribe(c))}abortRun(){}constructor({agentId:t,description:e,threadId:n,initialMessages:r,initialState:i}={}){this.agentId=t,this.description=e!=null?e:"",this.threadId=n!=null?n:(0,D.v4)(),this.messages=A(r!=null?r:[]),this.state=A(i!=null?i:{})}apply(t){return P({messages:t.messages,state:t.state})}prepareRunAgentInput(t){var e,n,r;return{threadId:this.threadId,runId:(t==null?void 0:t.runId)||(0,D.v4)(),tools:A((e=t==null?void 0:t.tools)!=null?e:[]),context:A((n=t==null?void 0:t.context)!=null?n:[]),forwardedProps:A((r=t==null?void 0:t.forwardedProps)!=null?r:{}),state:A(this.state),messages:A(this.messages)}}onError(t){console.error("Agent execution failed:",t)}onFinalize(){}clone(){let t=Object.create(Object.getPrototypeOf(this));for(let e of Object.getOwnPropertyNames(this)){let n=this[e];typeof n!="function"&&(t[e]=A(n))}return t}};var F=class extends b{constructor(e){var n;super(e);this.abortController=new AbortController;this.url=e.url,this.headers=A((n=e.headers)!=null?n:{})}requestInit(e){return{method:"POST",headers:R(v({},this.headers),{"Content-Type":"application/json",Accept:"text/event-stream"}),body:JSON.stringify(e),signal:this.abortController.signal}}runAgent(e){var n;return this.abortController=(n=e==null?void 0:e.abortController)!=null?n:new AbortController,super.runAgent(e)}abortRun(){this.abortController.abort(),super.abortRun()}run(e){return()=>U(this.url,this.requestInit(e)).pipe(X)}};h(L,require("@agentwire/core"),module.exports);0&&(module.exports={AbstractAgent,HttpAgent,convertToLegacyEvents,parseProtoStream,parseSSEStream,runHttpRequest,transformHttpEventStream,verifyEvents,withDefaultApplyEvents,...require("@agentwire/core")});
//# sourceMappingURL=index.js.map