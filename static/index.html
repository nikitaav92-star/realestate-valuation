<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Version: 2025-12-17-v8-4types -->
    <title>üè† –û—Ü–µ–Ω–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #111827;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #9ca3af;
            font-size: 16px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            justify-content: center;
        }
        
        .tab {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            background: #374151;
            color: #9ca3af;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab.active {
            background: #3b82f6;
            color: white;
        }
        
        .tab:hover {
            color: white;
        }
        
        /* Card */
        .card {
            background: #1f2937;
            border-radius: 10px;
            border: 1px solid #374151;
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Form */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            color: #9ca3af;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 14px;
            background: #111827;
            border: 1px solid #374151;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        input::placeholder {
            color: #6b7280;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .hint {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        /* Examples */
        .examples {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
        }
        
        .examples h4 {
            font-size: 13px;
            color: #60a5fa;
            margin-bottom: 8px;
        }
        
        .example-btn {
            background: transparent;
            border: 1px solid #374151;
            color: #9ca3af;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin: 4px;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .example-btn:hover {
            border-color: #60a5fa;
            color: #60a5fa;
            background: rgba(59, 130, 246, 0.1);
        }
        
        /* Button */
        .btn-estimate {
            width: 100%;
            padding: 14px;
            background: #22c55e;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 8px;
        }
        
        .btn-estimate:hover {
            background: #16a34a;
        }
        
        .btn-estimate:disabled {
            background: #166534;
            cursor: not-allowed;
        }
        
        /* Loader */
        .loader {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loader.show {
            display: block;
        }
        
        .spinner {
            border: 3px solid #374151;
            border-top-color: #3b82f6;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loader p {
            color: #9ca3af;
            font-size: 14px;
        }
        
        /* Alerts */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .alert.show {
            display: block;
        }
        
        .alert.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }
        
        .alert.warning {
            background: rgba(249, 115, 22, 0.1);
            border: 1px solid rgba(249, 115, 22, 0.3);
            color: #fb923c;
        }
        
        .alert.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }
        
        /* Result Section */
        .result-section {
            display: none;
        }
        
        .result-section.show {
            display: block;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Summary Cards */
        .summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: #1f2937;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid #374151;
        }
        
        .summary-card p {
            color: #9ca3af;
            font-size: 12px;
            margin-bottom: 6px;
        }
        
        .summary-card .value {
            font-size: 26px;
            font-weight: bold;
        }
        
        .summary-card .value.green { color: #4ade80; }
        .summary-card .value.blue { color: #60a5fa; }
        .summary-card .value.purple { color: #c084fc; }
        
        /* Comparables Section */
        .comparables-section {
            margin-top: 20px;
        }
        
        .comparables-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #4ade80;
        }
        
        .comparable-item {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        
        .comparable-item:hover {
            border-color: #4b5563;
        }
        
        .comparable-item.top3 {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.4);
            border-left: 4px solid #22c55e;
        }
        
        .comparable-left {
            flex: 1;
        }
        
        .comparable-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        
        .comparable-rank {
            font-size: 18px;
            font-weight: 700;
            color: #4ade80;
            width: 24px;
        }
        
        .comparable-link {
            color: #60a5fa;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
        }
        
        .comparable-link:hover {
            color: #93c5fd;
            text-decoration: underline;
        }
        
        .badge-top3 {
            background: #22c55e;
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px;
            text-transform: uppercase;
        }
        
        .comparable-meta {
            color: #9ca3af;
            font-size: 12px;
        }
        
        .comparable-right {
            text-align: right;
        }
        
        .comparable-price {
            font-size: 20px;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
        }
        
        .comparable-item.top3 .comparable-price {
            color: #4ade80;
        }
        
        .comparable-psm {
            color: #9ca3af;
            font-size: 13px;
        }
        
        /* Logic Box */
        .logic-box {
            background: rgba(249, 115, 22, 0.1);
            border: 1px solid rgba(249, 115, 22, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }
        
        .logic-box strong {
            color: #fb923c;
            font-size: 14px;
        }
        
        .logic-box p {
            color: #d1d5db;
            font-size: 13px;
            line-height: 1.6;
            margin-top: 8px;
        }
        
        /* Links */
        .footer-links {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #374151;
        }
        
        .footer-links a {
            color: #60a5fa;
            text-decoration: none;
            margin: 0 16px;
            font-size: 14px;
        }
        
        .footer-links a:hover {
            text-decoration: underline;
        }
        
        /* Responsive */
        @media (max-width: 900px) {
            .summary {
                grid-template-columns: repeat(2, 1fr);
            }
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 600px) {
            .summary {
                grid-template-columns: 1fr;
            }
            .tabs {
                flex-direction: column;
            }
        }

        /* History Tree Styles */
        .street-item {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .street-header {
            padding: 14px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .street-header:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .street-header.expanded {
            background: rgba(59, 130, 246, 0.15);
            border-bottom: 1px solid #374151;
        }

        .street-name {
            font-weight: 600;
            font-size: 15px;
        }

        .street-stats {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #9ca3af;
        }

        .street-content {
            display: none;
            padding: 0;
        }

        .street-content.show {
            display: block;
        }

        .building-item {
            padding: 12px 16px 12px 32px;
            border-bottom: 1px solid #2d3748;
            cursor: pointer;
            transition: background 0.2s;
        }

        .building-item:last-child {
            border-bottom: none;
        }

        .building-item:hover {
            background: rgba(34, 197, 94, 0.1);
        }

        .building-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .building-address {
            font-size: 14px;
            color: #e5e7eb;
        }

        .building-stats {
            font-size: 12px;
            color: #9ca3af;
        }

        .valuation-list {
            display: none;
            padding: 8px 16px 8px 48px;
            background: rgba(0,0,0,0.2);
        }

        .valuation-list.show {
            display: block;
        }

        .valuation-item {
            padding: 10px 12px;
            margin: 6px 0;
            background: #1f2937;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
            font-size: 13px;
        }

        .valuation-item:hover {
            background: #2d3748;
        }

        .valuation-date {
            color: #9ca3af;
            font-size: 11px;
            margin-bottom: 4px;
        }

        .valuation-prices {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .valuation-price {
            color: #4ade80;
            font-weight: 600;
        }

        .valuation-interest {
            color: #f59e0b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† –û—Ü–µ–Ω–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</h1>
            <p>–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è: –¢–û–ü-3 –Ω–∏–∑–∫–∏—Ö —Ü–µ–Ω—ã + —Ç–æ—Ä–≥ 7%</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('smart')">‚ú® –£–º–Ω—ã–π –≤–≤–æ–¥</button>
            <button class="tab" onclick="switchTab('history')">üìú –ò—Å—Ç–æ—Ä–∏—è</button>
        </div>

        <!-- Form Card -->
        <div class="card">
            <!-- Tab 0: Smart Input (AI-powered) -->
            <div id="tab-smart" class="tab-content active">
                <div class="examples" style="background: rgba(147, 51, 234, 0.1); border-color: rgba(147, 51, 234, 0.3);">
                    <h4 style="color: #a78bfa; margin-bottom: 12px;">‚ú® –£–º–Ω—ã–π –≤–≤–æ–¥</h4>
                    <p style="color: #9ca3af; font-size: 13px; margin-bottom: 8px;">
                        –í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è, –æ–ø–∏—Å–∞–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞.
                        –î–∞–Ω–Ω—ã–µ –∏–∑–≤–ª–µ–∫—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                    </p>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;">
                        <span style="background: rgba(147, 51, 234, 0.2); padding: 4px 10px; border-radius: 4px; font-size: 12px; color: #c4b5fd;">üìù –¢–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è</span>
                        <span style="background: rgba(147, 51, 234, 0.2); padding: 4px 10px; border-radius: 4px; font-size: 12px; color: #c4b5fd;">üìÑ –í—ã–ø–∏—Å–∫–∞ –ï–ì–†–ù</span>
                        <span style="background: rgba(147, 51, 234, 0.2); padding: 4px 10px; border-radius: 4px; font-size: 12px; color: #c4b5fd;">üìã –î–ö–ü</span>
                        <span style="background: rgba(147, 51, 234, 0.2); padding: 4px 10px; border-radius: 4px; font-size: 12px; color: #c4b5fd;">üñºÔ∏è –°–∫—Ä–∏–Ω—à–æ—Ç –¶–ò–ê–ù</span>
                    </div>
                </div>

                <form id="smartForm">
                    <!-- Input mode selector -->
                    <div class="form-group">
                        <label>–°–ø–æ—Å–æ–± –≤–≤–æ–¥–∞</label>
                        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 16px; background: #374151; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s;" id="modeTextLabel">
                                <input type="radio" name="inputMode" value="text" checked onchange="switchInputMode('text')" style="width: auto;">
                                <span>üìù –¢–µ–∫—Å—Ç</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 16px; background: #374151; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s;" id="modeImageLabel">
                                <input type="radio" name="inputMode" value="image" onchange="switchInputMode('image')" style="width: auto;">
                                <span>üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 16px; background: #374151; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s;" id="modeUrlLabel">
                                <input type="radio" name="inputMode" value="url" onchange="switchInputMode('url')" style="width: auto;">
                                <span>üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</span>
                            </label>
                        </div>
                    </div>

                    <!-- Text input -->
                    <div class="form-group" id="textInputGroup">
                        <label>üìù –¢–µ–∫—Å—Ç —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã</label>
                        <textarea name="smartText" rows="6" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã...

–ü—Ä–∏–º–µ—Ä:
–ü—Ä–æ–¥–∞–µ—Ç—Å—è 2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ 65 –º¬≤ –Ω–∞ 5/17 —ç—Ç–∞–∂–µ –ø–∞–Ω–µ–ª—å–Ω–æ–≥–æ –¥–æ–º–∞ 2006 –≥–æ–¥–∞ –ø–æ—Å—Ç—Ä–æ–π–∫–∏.
–ê–¥—Ä–µ—Å: —É–ª. –ö–æ—Ü—é–±–∏–Ω—Å–∫–æ–≥–æ, –¥. 10
–¶–µ–Ω–∞: 15 000 000 ‚ÇΩ"></textarea>
                        <div class="hint">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫—É—Ç—Å—è: –∞–¥—Ä–µ—Å, –ø–ª–æ—â–∞–¥—å, –∫–æ–º–Ω–∞—Ç—ã, —ç—Ç–∞–∂, —Ç–∏–ø –¥–æ–º–∞, –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏</div>
                    </div>

                    <!-- Image upload -->
                    <div class="form-group" id="imageInputGroup" style="display: none;">
                        <label>üñºÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                        <div id="dropZone" style="border: 2px dashed #4b5563; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s;">
                            <div style="color: #9ca3af; margin-bottom: 12px;">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                            </div>
                            <p style="color: #9ca3af; margin-bottom: 8px;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
                            <p style="color: #6b7280; font-size: 12px;">JPEG, PNG, WebP, PDF –¥–æ 10 –ú–ë</p>
                        </div>
                        <input type="file" id="imageFileInput" accept="image/jpeg,image/png,image/webp,application/pdf" style="display: none;">
                        <div id="imagePreview" style="display: none; margin-top: 12px;"></div>
                    </div>

                    <!-- URL input -->
                    <div class="form-group" id="urlInputGroup" style="display: none;">
                        <label>üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ (–¶–ò–ê–ù, –ê–≤–∏—Ç–æ, –Ø–Ω–¥–µ–∫—Å)</label>
                        <input type="url" name="cianUrl" placeholder="https://cian.ru/..., avito.ru/..., realty.yandex.ru/...">
                        <div class="hint">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: –¶–ò–ê–ù, –ê–≤–∏—Ç–æ, –Ø–Ω–¥–µ–∫—Å.–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</div>
                    </div>

                    <!-- Parsed data preview -->
                    <div id="parsedDataPreview" style="display: none; margin-top: 20px; padding: 16px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px;">
                        <h4 style="color: #4ade80; margin-bottom: 12px;">‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h4>
                        <div id="parsedDataContent" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 14px;"></div>
                        <div id="parsedDataNotes" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(34, 197, 94, 0.2); font-size: 12px; color: #9ca3af;"></div>
                    </div>

                    <!-- Manual corrections -->
                    <div id="manualCorrections" style="display: none; margin-top: 20px; padding: 16px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px;">
                        <h4 style="color: #fbbf24; margin-bottom: 12px;">‚úèÔ∏è –£—Ç–æ—á–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>üìê –ü–ª–æ—â–∞–¥—å (–º¬≤)</label>
                                <input type="number" step="0.1" name="correctArea" id="correctArea">
                            </div>
                            <div class="form-group">
                                <label>üè† –ö–æ–º–Ω–∞—Ç</label>
                                <input type="number" name="correctRooms" id="correctRooms" min="1" max="10">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>üè¢ –≠—Ç–∞–∂</label>
                                <input type="number" name="correctFloor" id="correctFloor" min="1">
                            </div>
                            <div class="form-group">
                                <label>üè¢ –í—Å–µ–≥–æ —ç—Ç–∞–∂–µ–π</label>
                                <input type="number" name="correctTotalFloors" id="correctTotalFloors" min="1">
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button type="button" class="btn-estimate" style="background: #8b5cf6; flex: 1;" onclick="parseSmartInput()">üîç –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å</button>
                        <button type="button" class="btn-estimate" style="flex: 1;" id="smartEstimateBtn" onclick="submitSmartEstimate()" disabled>üìä –û—Ü–µ–Ω–∏—Ç—å</button>
                    </div>
                </form>
            </div>

            <!-- Tab 1: History -->
            <div id="tab-history" class="tab-content">
                <div style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>üîç –ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É</label>
                        <input type="text" id="historySearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ —É–ª–∏—Ü—É..." oninput="debounceHistorySearch()">
                    </div>
                </div>

                <!-- Statistics -->
                <div id="historyStats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px;">
                    <div style="background: rgba(34, 197, 94, 0.1); padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 4px;">–£–ª–∏—Ü</div>
                        <div id="statsStreets" style="font-size: 24px; font-weight: bold; color: #4ade80;">-</div>
                    </div>
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 4px;">–î–æ–º–æ–≤</div>
                        <div id="statsBuildings" style="font-size: 24px; font-weight: bold; color: #60a5fa;">-</div>
                    </div>
                    <div style="background: rgba(168, 85, 247, 0.1); padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 4px;">–û—Ü–µ–Ω–æ–∫</div>
                        <div id="statsValuations" style="font-size: 24px; font-weight: bold; color: #c084fc;">-</div>
                    </div>
                </div>

                <!-- Street Tree -->
                <div id="historyTree" style="max-height: 600px; overflow-y: auto;"></div>

                <!-- Loading indicator for history -->
                <div id="historyLoader" style="display: none; text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p style="color: #9ca3af;">–ó–∞–≥—Ä—É–∂–∞—é –∏—Å—Ç–æ—Ä–∏—é...</p>
                </div>
            </div>
        </div>

        <!-- Loader -->
        <div class="loader" id="loader">
            <div class="spinner"></div>
            <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ä—ã–Ω–æ–∫...</p>
        </div>

        <!-- Alerts -->
        <div class="alert error" id="error"></div>
        <div class="alert warning" id="warning"></div>

        <!-- Results -->
        <div class="result-section" id="resultSection">
            <!-- Summary Cards -->
            <div class="summary">
                <div class="summary-card">
                    <p>üí∞ –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏</p>
                    <div class="value green" id="price">-</div>
                </div>
                <div class="summary-card">
                    <p>üíé –¶–µ–Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞</p>
                    <div class="value" style="color: #f59e0b;" id="interestPrice">-</div>
                </div>
                <div class="summary-card">
                    <p>üìä –¶–µ–Ω–∞ –∑–∞ –º¬≤</p>
                    <div class="value blue" id="pricePerSqm">-</div>
                </div>
                <div class="summary-card">
                    <p>üèóÔ∏è –¢–∏–ø –¥–æ–º–∞</p>
                    <div class="value" style="font-size: 18px; color: #f59e0b;" id="buildingTypeDisplay">-</div>
                </div>
                <div class="summary-card">
                    <p>üéØ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</p>
                    <div class="value purple" id="confidence">-</div>
                </div>
                <div class="summary-card">
                    <p>üìâ –°–∫–∏–¥–∫–∞ –æ—Ç —Ä—ã–Ω–∫–∞</p>
                    <div class="value" style="color: #ef4444;" id="discountFromMarket">-</div>
                </div>
                <div class="summary-card">
                    <p>üíµ –ù–∞—à–∞ –ø—Ä–∏–±—ã–ª—å</p>
                    <div class="value purple" id="ourProfit">-</div>
                </div>
                <div class="summary-card" id="renovationProfitCard" style="display: none;">
                    <p>üîß –ü—Ä–æ—Ñ–∏—Ç –æ—Ç —Ä–µ–º–æ–Ω—Ç–∞</p>
                    <div class="value" style="color: #22c55e;" id="renovationProfit">-</div>
                </div>
            </div>

            <!-- Price Source Selector -->
            <div id="priceSourceSelector" style="margin-top: 15px; padding: 15px; background: rgba(59, 130, 246, 0.08); border-radius: 10px; border: 1px solid rgba(59, 130, 246, 0.2); display: none;">
                <div style="font-weight: 600; color: #3b82f6; font-size: 14px; margin-bottom: 12px;">üìä –ò—Å—Ç–æ—á–Ω–∏–∫ —Ü–µ–Ω</div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <div id="ps_combined" onclick="updatePriceSource('combined')" style="cursor:pointer; padding:10px 14px; border-radius:8px; border:2px solid #8b5cf6; background:rgba(139,92,246,0.2);">
                        <div style="font-weight:600; font-size:13px; color:#8b5cf6;">–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</div>
                        <div style="font-size:10px; opacity:0.7;">40% –¶–ò–ê–ù + 60% –†–æ—Å—Ä–µ–µ—Å—Ç—Ä</div>
                    </div>
                    <div id="ps_cian" onclick="updatePriceSource('cian')" style="cursor:pointer; padding:10px 14px; border-radius:8px; border:2px solid transparent; background:rgba(0,0,0,0.2);">
                        <div style="font-weight:600; font-size:13px; color:#22c55e;">–¶–ò–ê–ù</div>
                        <div style="font-size:10px; opacity:0.7;">–æ–±—ä—è–≤–ª–µ–Ω–∏—è -7%</div>
                    </div>
                    <div id="ps_rosreestr" onclick="updatePriceSource('rosreestr')" style="cursor:pointer; padding:10px 14px; border-radius:8px; border:2px solid transparent; background:rgba(0,0,0,0.2);">
                        <div style="font-weight:600; font-size:13px; color:#f59e0b;">–†–æ—Å—Ä–µ–µ—Å—Ç—Ä</div>
                        <div style="font-size:10px; opacity:0.7;">—Ä–µ–∞–ª—å–Ω—ã–µ —Å–¥–µ–ª–∫–∏</div>
                    </div>
                </div>
            </div>

            <!-- Price Adjustment Section -->
            <div id="priceAdjustmentSection" style="margin-top: 15px; padding: 15px; background: rgba(239, 68, 68, 0.08); border-radius: 10px; border: 1px solid rgba(239, 68, 68, 0.2); display: none;">
                <div style="font-weight: 600; color: #ef4444; font-size: 14px; margin-bottom: 12px;">üìù –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Ü–µ–Ω—ã</div>
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px; align-items: start;">
                    <div>
                        <label style="font-size: 12px; color: #9ca3af; display: block; margin-bottom: 4px;">–°—É–º–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" id="priceAdjustment" placeholder="-500000"
                                style="width: 140px; padding: 10px; border-radius: 6px; border: 1px solid rgba(239, 68, 68, 0.3); background: rgba(0,0,0,0.3); color: white; font-size: 14px;"
                                onchange="applyPriceAdjustment()">
                            <span style="color: #9ca3af; font-size: 13px;">‚ÇΩ</span>
                        </div>
                        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ = —Å–∫–∏–¥–∫–∞</div>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #9ca3af; display: block; margin-bottom: 4px;">–ü—Ä–∏—á–∏–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏</label>
                        <input type="text" id="adjustmentNote" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –æ–∫–Ω–∞ –Ω–∞ –∫–æ–∑—ã—Ä—ë–∫, —à—É–º–Ω–∞—è —É–ª–∏—Ü–∞"
                            style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(239, 68, 68, 0.3); background: rgba(0,0,0,0.3); color: white; font-size: 14px;"
                            onchange="applyPriceAdjustment()">
                    </div>
                </div>

                <!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —ç—Ç–∞–∂—É -->
                <div id="floorAdjustmentBlock" style="margin-top: 12px; padding: 10px; background: rgba(245, 158, 11, 0.1); border-radius: 6px; border: 1px solid rgba(245, 158, 11, 0.3); display: none;">
                    <div style="font-size: 12px; color: #f59e0b; margin-bottom: 8px; font-weight: 500;">
                        ‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω –æ—Å–æ–±—ã–π —ç—Ç–∞–∂
                    </div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                        <label id="firstFloorChip" style="display: none; align-items: center; gap: 8px; padding: 8px 14px; background: rgba(239, 68, 68, 0.15); border-radius: 20px; cursor: pointer; font-size: 14px; color: #fca5a5;">
                            <input type="checkbox" id="applyFirstFloorDiscount" onchange="applyFloorDiscount()" style="cursor: pointer; width: 16px; height: 16px;">
                            üè† –ü–µ—Ä–≤—ã–π —ç—Ç–∞–∂: -20%
                        </label>
                        <label id="lastFloorChip" style="display: none; align-items: center; gap: 8px; padding: 8px 14px; background: rgba(245, 158, 11, 0.15); border-radius: 20px; cursor: pointer; font-size: 14px; color: #fcd34d;">
                            <input type="checkbox" id="applyLastFloorDiscount" onchange="applyFloorDiscount()" style="cursor: pointer; width: 16px; height: 16px;">
                            üè¢ –ü–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–∂: -2%
                        </label>
                    </div>
                </div>

                <div id="adjustedPriceDisplay" style="margin-top: 12px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #9ca3af; font-size: 13px;">–°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏:</span>
                        <span id="adjustedSalePrice" style="color: #ef4444; font-weight: 600; font-size: 16px;">-</span>
                    </div>
                </div>
            </div>

            <!-- Investment Analysis Section -->
            <div id="investmentSection" style="margin-top: 20px; padding: 20px; background: rgba(245, 158, 11, 0.05); border-radius: 12px; border-left: 4px solid #f59e0b; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #f59e0b; font-size: 18px;">üíº –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h3>
                    <button onclick="toggleInvestment()" style="background: none; border: none; color: #f59e0b; cursor: pointer; font-size: 14px;">–°–≤–µ—Ä–Ω—É—Ç—å ‚ñ≤</button>
                </div>
                <div id="investmentContent"></div>
            </div>
            
            <!-- Show Investment Button -->
            <div id="showInvestmentBtn" style="margin-top: 20px; text-align: center; display: none;">
                <button onclick="toggleInvestment()" style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                    üíº –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑
                </button>
            </div>

            <!-- Property Details -->
            <div class="property-details" id="propertyDetails" style="margin-top: 20px; padding: 15px; background: rgba(59, 130, 246, 0.05); border-radius: 8px; border-left: 3px solid #3b82f6; display: none;">
                <div style="font-size: 13px; color: #9ca3af; margin-bottom: 8px;">üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ü–µ–Ω–∫–∏</div>
                <div id="detectedParams" style="font-size: 14px; color: #e5e7eb;"></div>
            </div>

            <!-- Comparables -->
            <div class="comparables-section" id="comparablesSection"></div>

            <!-- Detailed Breakdown -->
            <div id="breakdownSection" style="margin-top: 30px; padding: 20px; background: rgba(59, 130, 246, 0.05); border-radius: 12px; border-left: 4px solid #3b82f6; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #3b82f6; font-size: 18px;">üìä –î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –æ—Ü–µ–Ω–∫–∏</h3>
                    <button onclick="toggleBreakdown()" style="background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 14px;">–°–≤–µ—Ä–Ω—É—Ç—å ‚ñ≤</button>
                </div>
                <div id="breakdownContent"></div>
            </div>

            <!-- Show Breakdown Button -->
            <div id="showBreakdownBtn" style="margin-top: 20px; text-align: center; display: none;">
                <button onclick="toggleBreakdown()" style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                    üìä –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É
                </button>
            </div>

            <!-- Logic Explanation -->
            <div class="logic-box">
                <strong>üí° –ö–∞–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ü–µ–Ω–∫–∞:</strong>
                <p>1. –ù–∞—Ö–æ–¥–∏–º 10 <strong>—Å–∞–º—ã—Ö –±–ª–∏–∑–∫–∏—Ö –∏ –ø–æ—Ö–æ–∂–∏—Ö</strong> –∫–≤–∞—Ä—Ç–∏—Ä –≤ —Ä–∞–¥–∏—É—Å–µ 5 –∫–º<br>
                2. –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ <strong>—Ü–µ–Ω–µ –∑–∞ –º¬≤</strong> ‚Äî –æ—Ç <span style="color: #22c55e; font-weight: 600;">–°–ê–ú–´–• –î–ï–®–ï–í–´–•</span> –∫ –¥–æ—Ä–æ–≥–∏–º<br>
                3. –ë–µ—Ä–µ–º <span style="color: #22c55e; font-weight: 600;">–¢–û–ü-3 –°–ê–ú–´–• –î–ï–®–ï–í–´–•</span> (–Ω–∏–∑ —Ä—ã–Ω–∫–∞) üìâ<br>
                4. –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –Ω–∞ —Ä–∞–∑–Ω–∏—Ü—É –≤ –ø–ª–æ—â–∞–¥–∏ (¬±0.2% –Ω–∞ 1–º¬≤)<br>
                5. –°—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ—Ä–≥ 7% (√ó0.93)<br>
                6. –£–º–Ω–æ–∂–∞–µ–º –Ω–∞ –ø–ª–æ—â–∞–¥—å –≤–∞—à–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã<br>
                <br>
                –†–µ–∑—É–ª—å—Ç–∞—Ç: <strong style="color: #22c55e;">–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è</strong> ‚Äî –±–µ—Ä–µ–º —Å–∞–º—ã–µ –Ω–∏–∑–∫–∏–µ —Ü–µ–Ω—ã + —Ç–æ—Ä–≥</p>
            </div>
        </div>

        <!-- Valuation History Section -->
        <div id="historySection" style="margin-top: 40px; display: none;">
            <div style="background: rgba(34, 197, 94, 0.05); border-radius: 12px; border-left: 4px solid #22c55e; padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #22c55e; font-size: 20px;">üìà –ò—Å—Ç–æ—Ä–∏—è –æ—Ü–µ–Ω–æ–∫ –¥–ª—è —ç—Ç–æ–≥–æ –∞–¥—Ä–µ—Å–∞</h3>
                    <button onclick="toggleHistory()" style="background: none; border: none; color: #22c55e; cursor: pointer; font-size: 14px;">–°–≤–µ—Ä–Ω—É—Ç—å ‚ñ≤</button>
                </div>

                <!-- Price Trend Chart -->
                <div id="chartContainer" style="margin-bottom: 30px; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px;">
                    <canvas id="priceChart" style="max-height: 300px;"></canvas>
                </div>

                <!-- History List -->
                <div id="historyList"></div>
            </div>
        </div>

        <!-- Show History Button -->
        <div id="showHistoryBtn" style="margin-top: 20px; text-align: center; display: none;">
            <button onclick="loadHistory()" style="padding: 12px 24px; background: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                üìà –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ—Ü–µ–Ω–æ–∫
            </button>
        </div>

        <!-- Footer - API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ -->
    </div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
        // –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        // –î–µ—Ñ–æ–ª—Ç—ã –¥–ª—è —Ç–∏–ø–∞ –ø—Ä–æ–µ–∫—Ç–∞ 'own' (—Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π)
        window.investmentCheckboxes = {
            param_state_fee: true,    // –ì–æ—Å–ø–æ—à–ª–∏–Ω–∞
            param_agency: true,       // –ê–≥–µ–Ω—Ç—Å–∫–∏–µ
            param_pip: true,          // –ü–ò–ü
            param_utilities: true,    // –ñ–ö–•
            param_serbsky: true,      // –°–µ—Ä–±—Å–∫–æ–≥–æ
            param_tax: true,          // –ù–∞–ª–æ–≥ 6%
            param_notary: false,
            param_renovation: false,
            param_foreman: false,
            param_eviction: false,
            param_registrators_transfer: false,
            param_registrators_mortgage: false,
            param_contur: false
        };
        window.currentProjectType = 'own';

        function getCheckboxState(id, defaultValue = false) {
            if (window.investmentCheckboxes.hasOwnProperty(id)) {
                return window.investmentCheckboxes[id];
            }
            return defaultValue;
        }

        function saveAllCheckboxStates() {
            const checkboxIds = [
                'param_notary', 'param_state_fee', 'param_pip', 'param_agency',
                'param_renovation', 'param_foreman', 'param_eviction',
                'param_registrators_transfer', 'param_registrators_mortgage', 'param_contur',
                'param_utilities', 'param_serbsky', 'param_tax'
            ];
            checkboxIds.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    window.investmentCheckboxes[id] = checkbox.checked;
                }
            });
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ—Ñ–æ–ª—Ç–æ–≤ —á–µ–∫–±–æ–∫—Å–æ–≤ –ø–æ —Ç–∏–ø—É –ø—Ä–æ–µ–∫—Ç–∞
        function setProjectTypeDefaults(projectType) {
            // –ú–∞—Ç—Ä–∏—Ü–∞ –¥–µ—Ñ–æ–ª—Ç–æ–≤:
            // | –†–∞—Å—Ö–æ–¥              | own | partner | partner_flip | bank_flip |
            // |---------------------|:---:|:-------:|:------------:|:---------:|
            // | –ì–æ—Å–ø–æ—à–ª–∏–Ω–∞          | ‚úÖ  | ‚úÖ      | ‚úÖ           | ‚úÖ        |
            // | –ê–≥–µ–Ω—Ç—Å–∫–∏–µ 200K      | ‚úÖ  | ‚ùå      | ‚ùå           | ‚ùå        |
            // | –ü–ò–ü (1K —Ñ–∏–∫—Å)       | ‚úÖ  | ‚úÖ      | ‚ùå           | ‚ùå        |
            // | –ñ–ö–• 3–º–µ—Å            | ‚úÖ  | ‚úÖ      | ‚úÖ           | ‚úÖ        |
            // | –°–µ—Ä–±—Å–∫–æ–≥–æ 27K       | ‚úÖ  | ‚úÖ      | ‚úÖ           | ‚úÖ        |
            // | –ù–∞–ª–æ–≥ 6%            | ‚úÖ  | ‚úÖ      | ‚úÖ           | ‚úÖ        |
            // | –†–µ–º–æ–Ω—Ç              | ‚ùå  | ‚ùå      | ‚úÖ           | ‚úÖ        |
            // | –ü—Ä–æ—Ä–∞–±              | ‚ùå  | ‚ùå      | ‚úÖ           | ‚úÖ        |

            const defaults = {
                'own': {
                    param_state_fee: true, param_agency: true, param_pip: true,
                    param_utilities: true, param_serbsky: true, param_tax: true,
                    param_renovation: false, param_foreman: false
                },
                'partner': {
                    param_state_fee: true, param_agency: false, param_pip: true,
                    param_utilities: true, param_serbsky: true, param_tax: true,
                    param_renovation: false, param_foreman: false
                },
                'partner_flip': {
                    param_state_fee: true, param_agency: false, param_pip: false,
                    param_utilities: true, param_serbsky: true, param_tax: true,
                    param_renovation: true, param_foreman: true
                },
                'bank_flip': {
                    param_state_fee: true, param_agency: false, param_pip: false,
                    param_utilities: true, param_serbsky: true, param_tax: true,
                    param_renovation: true, param_foreman: true
                }
            };

            const typeDefaults = defaults[projectType] || defaults['own'];
            Object.entries(typeDefaults).forEach(([id, value]) => {
                window.investmentCheckboxes[id] = value;
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = value;
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ä–æ–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
        function updateProjectPeriodDisplay() {
            const period = window.projectPeriodMonths || 3;
            const utilitiesLabel = document.getElementById('utilities_label');
            if (utilitiesLabel) {
                const utilitiesTotal = period * 11500;
                utilitiesLabel.textContent = `üè† –ñ–ö–• (${period} –º–µ—Å √ó 11,500 ‚ÇΩ = ${utilitiesTotal.toLocaleString('ru-RU')} ‚ÇΩ)`;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ä–æ–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
        window.projectPeriodMonths = 3;

        function switchTab(tabName) {
            // –£–±—Ä–∞—Ç—å active —Å–æ –≤—Å–µ—Ö —Ç–∞–±–æ–≤ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            // –ù–∞–π—Ç–∏ –Ω—É–∂–Ω—É—é –∫–Ω–æ–ø–∫—É —Ç–∞–±–∞ –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => {
                if (t.onclick && t.onclick.toString().includes(`'${tabName}'`)) {
                    t.classList.add('active');
                }
            });

            // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç —Ç–∞–±–∞
            const tabContent = document.getElementById('tab-' + tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }

            // Load history when switching to history tab
            if (tabName === 'history' && !historyData) {
                loadHistoryStreets();
            }
        }

        // ============ SMART INPUT (AI-POWERED) ============

        let currentInputMode = 'text';
        let parsedSmartData = null;
        let selectedImageFile = null;

        function switchInputMode(mode) {
            currentInputMode = mode;

            // Update visual state of labels
            document.getElementById('modeTextLabel').style.borderColor = mode === 'text' ? '#8b5cf6' : 'transparent';
            document.getElementById('modeImageLabel').style.borderColor = mode === 'image' ? '#8b5cf6' : 'transparent';
            document.getElementById('modeUrlLabel').style.borderColor = mode === 'url' ? '#8b5cf6' : 'transparent';

            // Show/hide input groups
            document.getElementById('textInputGroup').style.display = mode === 'text' ? 'block' : 'none';
            document.getElementById('imageInputGroup').style.display = mode === 'image' ? 'block' : 'none';
            document.getElementById('urlInputGroup').style.display = mode === 'url' ? 'block' : 'none';

            // Reset parsed data
            hideParsedData();
        }

        function hideParsedData() {
            document.getElementById('parsedDataPreview').style.display = 'none';
            document.getElementById('manualCorrections').style.display = 'none';
            document.getElementById('smartEstimateBtn').disabled = true;
            parsedSmartData = null;
        }

        async function parseSmartInput() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ –†–∞—Å–ø–æ–∑–Ω–∞—é...';
            btn.disabled = true;

            try {
                let result;

                if (currentInputMode === 'text') {
                    const text = document.querySelector('[name="smartText"]').value.trim();
                    if (!text) {
                        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è');
                        return;
                    }
                    result = await parseText(text);
                } else if (currentInputMode === 'image') {
                    if (!selectedImageFile) {
                        alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è');
                        return;
                    }
                    result = await parseImage(selectedImageFile);
                } else if (currentInputMode === 'url') {
                    const url = document.querySelector('[name="cianUrl"]').value.trim();
                    if (!url) {
                        alert('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ');
                        return;
                    }
                    result = await parseUrl(url);
                }

                if (result) {
                    parsedSmartData = result;
                    displayParsedData(result);
                }
            } catch (error) {
                console.error('Parse error:', error);
                alert('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ' + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function parseText(text) {
            const response = await fetch('/parse/text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Parse failed');
            }

            return response.json();
        }

        async function parseImage(file) {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/parse/image', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Parse failed');
            }

            return response.json();
        }

        async function parseUrl(url) {
            const response = await fetch('/parse/url?url=' + encodeURIComponent(url), {
                method: 'POST'
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Parse failed');
            }

            return response.json();
        }

        function displayParsedData(data) {
            const container = document.getElementById('parsedDataContent');
            const notes = document.getElementById('parsedDataNotes');

            const fields = [
                { key: 'address', label: 'üìç –ê–¥—Ä–µ—Å' },
                { key: 'area_total', label: 'üìê –ü–ª–æ—â–∞–¥—å', suffix: ' –º¬≤' },
                { key: 'rooms', label: 'üè† –ö–æ–º–Ω–∞—Ç' },
                { key: 'floor', label: 'üè¢ –≠—Ç–∞–∂' },
                { key: 'total_floors', label: 'üè¢ –í—Å–µ–≥–æ —ç—Ç–∞–∂–µ–π' },
                { key: 'building_type', label: 'üèóÔ∏è –¢–∏–ø –¥–æ–º–∞' },
                { key: 'building_year', label: 'üìÖ –ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏' },
                { key: 'price', label: 'üí∞ –¶–µ–Ω–∞', format: v => formatPrice(v) },
            ];

            const buildingTypes = {
                'panel': '–ü–∞–Ω–µ–ª—å–Ω—ã–π',
                'brick': '–ö–∏—Ä–ø–∏—á–Ω—ã–π',
                'monolithic': '–ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π',
                'block': '–ë–ª–æ—á–Ω—ã–π',
                'wood': '–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π',
                'other': '–î—Ä—É–≥–æ–µ'
            };

            let html = '';
            let hasRequiredData = !!data.area_total && (!!data.lat || !!data.address);

            fields.forEach(field => {
                let value = data[field.key];
                if (value !== null && value !== undefined) {
                    if (field.format) {
                        value = field.format(value);
                    } else if (field.key === 'building_type') {
                        value = buildingTypes[value] || value;
                    } else if (field.suffix) {
                        value = value + field.suffix;
                    }
                    html += `<div><span style="color: #9ca3af;">${field.label}:</span> <strong>${value}</strong></div>`;
                }
            });

            if (data.lat && data.lon) {
                html += `<div><span style="color: #9ca3af;">üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</span> <strong>${data.lat.toFixed(4)}, ${data.lon.toFixed(4)}</strong></div>`;
            }

            html += `<div><span style="color: #9ca3af;">üéØ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</span> <strong>${data.confidence}%</strong></div>`;

            container.innerHTML = html;

            // Show notes
            if (data.parse_notes) {
                notes.innerHTML = `<em>üí° ${data.parse_notes}</em>`;
            } else {
                notes.innerHTML = '';
            }

            // Fill correction fields
            document.getElementById('correctArea').value = data.area_total || '';
            document.getElementById('correctRooms').value = data.rooms || '';
            document.getElementById('correctFloor').value = data.floor || '';
            document.getElementById('correctTotalFloors').value = data.total_floors || '';

            // Show preview and corrections
            document.getElementById('parsedDataPreview').style.display = 'block';
            document.getElementById('manualCorrections').style.display = 'block';

            // Enable estimate button if we have enough data
            document.getElementById('smartEstimateBtn').disabled = !hasRequiredData;

            if (!hasRequiredData) {
                notes.innerHTML += `<br><span style="color: #f59e0b;">‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö. –£–∫–∞–∂–∏—Ç–µ –ø–ª–æ—â–∞–¥—å –∏ –∞–¥—Ä–µ—Å.</span>`;
            }
        }

        async function submitSmartEstimate() {
            if (!parsedSmartData) {
                alert('–°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ');
                return;
            }

            const btn = document.getElementById('smartEstimateBtn');
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ –û—Ü–µ–Ω–∏–≤–∞—é...';
            btn.disabled = true;

            const loader = document.getElementById('loader');
            const error = document.getElementById('error');
            const warning = document.getElementById('warning');
            const resultSection = document.getElementById('resultSection');

            resultSection.classList.remove('show');
            error.classList.remove('show');
            warning.classList.remove('show');
            loader.classList.add('show');
            loader.querySelector('p').textContent = '–û—Ü–µ–Ω–∏–≤–∞—é –∫–≤–∞—Ä—Ç–∏—Ä—É...';

            try {
                // Apply corrections from form
                const area = parseFloat(document.getElementById('correctArea').value) || parsedSmartData.area_total;
                const rooms = parseInt(document.getElementById('correctRooms').value) || parsedSmartData.rooms;
                const floor = parseInt(document.getElementById('correctFloor').value) || parsedSmartData.floor;
                const totalFloors = parseInt(document.getElementById('correctTotalFloors').value) || parsedSmartData.total_floors;

                // Build data object for estimateProperty (same format as addressForm)
                // NOTE: Don't send building_type/building_year from parsed data -
                // let auto-detection work from database (more reliable than Claude parsing)
                const data = {
                    address: parsedSmartData.address,
                    lat: parsedSmartData.lat,
                    lon: parsedSmartData.lon,
                    area_total: area,
                    rooms: rooms,
                    floor: floor,
                    total_floors: totalFloors,
                    building_type: null,  // Auto-detect from DB
                    building_year: null   // Auto-detect from DB
                };

                // If no coordinates from parsing, try to get them from address lookup
                if (!data.lat || !data.lon) {
                    loader.querySelector('p').textContent = '–ò—â—É –∞–¥—Ä–µ—Å –Ω–∞ –∫–∞—Ä—Ç–µ...';
                    try {
                        const coords = await geocodeAddress(data.address);
                        data.lat = coords.lat;
                        data.lon = coords.lon;
                    } catch (geoErr) {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã. ' + geoErr.message);
                    }
                }

                // Use existing estimateProperty function (handles all display logic)
                await estimateProperty(data);

            } catch (err) {
                loader.classList.remove('show');
                error.textContent = '‚ùå –û—à–∏–±–∫–∞ –æ—Ü–µ–Ω–∫–∏: ' + err.message;
                error.classList.add('show');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // Image upload handling
        document.addEventListener('DOMContentLoaded', function() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('imageFileInput');
            const imagePreview = document.getElementById('imagePreview');

            if (dropZone) {
                dropZone.addEventListener('click', () => fileInput.click());

                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = '#8b5cf6';
                    dropZone.style.background = 'rgba(139, 92, 246, 0.1)';
                });

                dropZone.addEventListener('dragleave', () => {
                    dropZone.style.borderColor = '#4b5563';
                    dropZone.style.background = 'transparent';
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.style.borderColor = '#4b5563';
                    dropZone.style.background = 'transparent';

                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleImageFile(files[0]);
                    }
                });
            }

            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleImageFile(e.target.files[0]);
                    }
                });
            }

            // Initialize text mode visual state
            switchInputMode('text');
        });

        function handleImageFile(file) {
            if (!file.type.match(/^image\/(jpeg|png|webp|gif)$/)) {
                alert('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ JPEG, PNG, WebP —Ñ–æ—Ä–º–∞—Ç—ã');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                alert('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 10 –ú–ë');
                return;
            }

            selectedImageFile = file;

            // Show preview
            const imagePreview = document.getElementById('imagePreview');
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #374151; border-radius: 8px;">
                        <img src="${e.target.result}" style="max-width: 100px; max-height: 100px; border-radius: 4px;">
                        <div>
                            <div style="font-weight: 500;">${file.name}</div>
                            <div style="color: #9ca3af; font-size: 12px;">${(file.size / 1024).toFixed(1)} –ö–ë</div>
                            <button type="button" onclick="clearImage()" style="margin-top: 8px; padding: 4px 8px; font-size: 12px; background: #ef4444; border: none; color: white; border-radius: 4px; cursor: pointer;">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                `;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);

            // Update dropzone
            document.getElementById('dropZone').style.display = 'none';
        }

        function clearImage() {
            selectedImageFile = null;
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('dropZone').style.display = 'block';
            document.getElementById('imageFileInput').value = '';
            hideParsedData();
        }

        // ============ RECENT QUERIES MANAGEMENT ============

        function getRecentQueries() {
            try {
                const stored = localStorage.getItem('recentQueries');
                return stored ? JSON.parse(stored) : [];
            } catch {
                return [];
            }
        }

        function saveRecentQuery(query) {
            const queries = getRecentQueries();
            // Create unique key based on address (normalized)
            const normalizedAddr = query.address.toLowerCase().replace(/[,.\s]+/g, ' ').trim();

            // Remove existing query with same address
            const filtered = queries.filter(q => {
                const existing = q.address.toLowerCase().replace(/[,.\s]+/g, ' ').trim();
                return existing !== normalizedAddr;
            });

            // Add new query to the beginning
            filtered.unshift({
                address: query.address,
                area_total: query.area_total,
                rooms: query.rooms,
                floor: query.floor || null,
                total_floors: query.total_floors || null,
                building_type: query.building_type || null,
                timestamp: Date.now()
            });

            // Keep only 5 most recent unique queries
            const limited = filtered.slice(0, 5);

            try {
                localStorage.setItem('recentQueries', JSON.stringify(limited));
            } catch (e) {
                console.warn('Could not save recent queries:', e);
            }

            displayRecentQueries();
        }

        // NOTE: Recent queries feature removed (was part of address tab)
        function displayRecentQueries() {
            const container = document.getElementById('recentQueriesList');
            if (!container) return; // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–¥–∞–ª—ë–Ω –≤–º–µ—Å—Ç–µ —Å –≤–∫–ª–∞–¥–∫–æ–π

            const queries = getRecentQueries();
            if (queries.length === 0) {
                container.innerHTML = '<span style="color: #6b7280; font-size: 13px;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</span>';
                return;
            }

            let html = '';
            queries.forEach((q, idx) => {
                let shortAddr = q.address.replace(/^–ú–æ—Å–∫–≤–∞,?\s*/i, '');
                if (shortAddr.length > 25) shortAddr = shortAddr.substring(0, 25) + '...';
                html += `<button class="example-btn" onclick="fillFromRecent(${idx})" title="${q.address} | ${q.area_total}–º¬≤ | ${q.rooms} –∫–æ–º–Ω">
                    ${shortAddr} ‚Ä¢ ${q.area_total}–º¬≤ ‚Ä¢ ${q.rooms}–∫
                </button>`;
            });
            container.innerHTML = html;
        }

        function fillFromRecent(index) {
            // NOTE: –í–∫–ª–∞–¥–∫–∞ address —É–¥–∞–ª–µ–Ω–∞, —Ñ—É–Ω–∫—Ü–∏—è –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
            console.log('fillFromRecent: address tab removed');
        }

        function clearRecentQueries() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –Ω–µ–¥–∞–≤–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤?')) {
                localStorage.removeItem('recentQueries');
                displayRecentQueries();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            displayRecentQueries();
        });

        function normalizeAddress(rawAddress) {
            let addr = rawAddress.trim();
            // Remove city prefix
            addr = addr.replace(/^–≥\.\s*–ú–æ—Å–∫–≤–∞[,\s]*/i, '');
            addr = addr.replace(/^–ú–æ—Å–∫–≤–∞[,\s]*/i, '');
            // Remove apartment (–∫–≤–∞—Ä—Ç–∏—Ä–∞)
            addr = addr.replace(/[,\s]+–∫–≤\.\s*\d+/gi, '');
            addr = addr.replace(/[,\s]+–∫–≤–∞—Ä—Ç–∏—Ä–∞\s*\d+/gi, '');
            // Remove building/corpus/stroenie (after comma only!)
            addr = addr.replace(/,\s*–∫\.\s*\d+/gi, '');
            addr = addr.replace(/,\s*–∫–æ—Ä–ø\.\s*\d+/gi, '');
            addr = addr.replace(/,\s*–∫–æ—Ä–ø—É—Å\s*\d+/gi, '');
            addr = addr.replace(/,\s*—Å—Ç—Ä\.\s*\d+/gi, '');
            addr = addr.replace(/,\s*—Å—Ç—Ä–æ–µ–Ω–∏–µ\s*\d+/gi, '');
            // Remove "–¥." prefix from house number
            addr = addr.replace(/\s–¥\.\s*/gi, ' ');
            addr = addr.replace(/,\s*–¥\.\s*/gi, ', ');
            // Clean up spaces and commas
            addr = addr.replace(/\s+/g, ' ').replace(/,+/g, ',').trim();
            addr = addr.replace(/^,|,$/g, '');
            // Add city prefix if missing
            if (!addr.toLowerCase().includes('–º–æ—Å–∫–≤–∞')) {
                addr = '–ú–æ—Å–∫–≤–∞, ' + addr;
            }
            return addr;
        }

        async function geocodeAddress(address) {
            const normalized = normalizeAddress(address);
            const addressInfo = document.getElementById('addressInfo');
            addressInfo.textContent = `üîÑ –ò—â—É: ${normalized}`;
            addressInfo.classList.add('show');
            
            // Step 1: Search in our database first
            try {
                const dbResponse = await fetch(`/search-address?q=${encodeURIComponent(normalized)}`);
                const dbData = await dbResponse.json();
                
                if (dbData.results && dbData.results.length > 0) {
                    const match = dbData.results[0];
                    addressInfo.textContent = `‚úÖ –ù–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ: ${match.address} (${match.listing_count} –æ–±—ä—è–≤–ª–µ–Ω–∏–π)`;
                    return {
                        lat: match.lat,
                        lon: match.lon,
                        display_name: match.address,
                        source: 'database'
                    };
                }
            } catch (err) {
                console.log('DB search failed, trying Nominatim:', err);
            }
            
            // Step 2: Fallback to Nominatim (OpenStreetMap)
            addressInfo.textContent = `üîÑ –ò—â—É –≤ OpenStreetMap: ${normalized}`;
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(normalized)}&limit=1&countrycodes=ru`;
            const response = await fetch(url, {
                headers: {'User-Agent': 'RealEstateValuation/1.0'}
            });
            const data = await response.json();
            
            if (data && data.length > 0) {
                addressInfo.textContent = `‚úÖ –ù–∞–π–¥–µ–Ω–æ: ${data[0].display_name}`;
                return {
                    lat: parseFloat(data[0].lat),
                    lon: parseFloat(data[0].lon),
                    display_name: data[0].display_name
                };
            }
            
            const streetOnly = normalized.replace(/,?\s*\d+.*$/, '');
            if (streetOnly !== normalized) {
                addressInfo.textContent = `üîÑ –ù–µ –Ω–∞–π–¥–µ–Ω —Ç–æ—á–Ω—ã–π –¥–æ–º, –∏—â—É —É–ª–∏—Ü—É: ${streetOnly}`;
                const url2 = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(streetOnly)}&limit=1&countrycodes=ru`;
                const response2 = await fetch(url2, {headers: {'User-Agent': 'RealEstateValuation/1.0'}});
                const data2 = await response2.json();
                
                if (data2 && data2.length > 0) {
                    addressInfo.textContent = `‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É–ª–∏—Ü—ã: ${data2[0].display_name}`;
                    return {
                        lat: parseFloat(data2[0].lat),
                        lon: parseFloat(data2[0].lon),
                        display_name: data2[0].display_name,
                        approximate: true
                    };
                }
            }
            
            // Step 3: Try Yandex Geocoder as last resort
            try {
                addressInfo.textContent = `üîÑ –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã...`;
                const yandexUrl = `https://geocode-maps.yandex.ru/1.x/?format=json&geocode=–ú–æ—Å–∫–≤–∞, ${encodeURIComponent(normalized)}`;
                const yandexResponse = await fetch(yandexUrl);
                const yandexData = await yandexResponse.json();
                
                if (yandexData?.response?.GeoObjectCollection?.featureMember?.length > 0) {
                    const geo = yandexData.response.GeoObjectCollection.featureMember[0].GeoObject;
                    const coords = geo.Point.pos.split(' ');
                    addressInfo.textContent = `‚úÖ –ù–∞–π–¥–µ–Ω–æ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å: ${geo.name}`;
                    return {
                        lat: parseFloat(coords[1]),
                        lon: parseFloat(coords[0]),
                        display_name: geo.metaDataProperty.GeocoderMetaData.text,
                        source: 'yandex'
                    };
                }
            } catch (err) {
                console.log('Yandex geocoding failed:', err);
            }
            
            throw new Error('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –≤ –æ–¥–Ω–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∞–¥—Ä–µ—Å –∏–ª–∏ –≤—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è.');
        }

        // NOTE: addressForm –∏ paramsForm –≤–∫–ª–∞–¥–∫–∏ —É–¥–∞–ª–µ–Ω—ã, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
        // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ "–£–º–Ω—ã–π –≤–≤–æ–¥"

        async function estimateProperty(data) {
            const loader = document.getElementById('loader');
            const resultSection = document.getElementById('resultSection');
            const error = document.getElementById('error');

            const response = await fetch('/estimate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            loader.classList.remove('show');

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `–û—à–∏–±–∫–∞ ${response.status}`);
            }

            const estimate = await response.json();
            
            // Save estimate for investment analysis
            window.lastEstimate = estimate;
            window.lastEstimate.area_total = data.area_total; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–æ—â–∞–¥—å –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞
            window.lastEstimate.floor = data.floor; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —ç—Ç–∞–∂ –¥–ª—è –¥–∏—Å–∫–æ–Ω—Ç–æ–≤
            window.lastEstimate.total_floors = data.total_floors || estimate.total_floors_detected; // –≠—Ç–∞–∂–Ω–æ—Å—Ç—å –¥–æ–º–∞
            window.currentValuationId = estimate.valuation_id; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞

            document.getElementById('addressInfo').classList.remove('show');

            // Calculate BOTTOM-3 price (conservative buyer estimate)
            // Sort by price_per_sqm and take 3 cheapest, apply 7% bargain
            const sortedComparables = [...estimate.comparables].sort((a, b) => a.price_per_sqm - b.price_per_sqm);
            const bottom3 = sortedComparables.slice(0, 3);
            const avgBottom3Psm = bottom3.reduce((sum, c) => sum + c.price_per_sqm, 0) / bottom3.length;
            const bottom3PsmWithBargain = avgBottom3Psm * 0.93; // 7% —Ç–æ—Ä–≥
            const bottom3Price = bottom3PsmWithBargain * data.area_total;

            // Use BOTTOM-3 price as the main display price
            const displayPrice = bottom3Price;
            const displayPricePerSqm = bottom3PsmWithBargain;

            // Save for investment analysis
            window.lastEstimate.bottom3_price = bottom3Price;
            window.lastEstimate.bottom3_price_per_sqm = bottom3PsmWithBargain;
            // –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–æ–≤
            window.lastEstimate.original_bottom3_price = bottom3Price;
            window.lastEstimate.displayed_sale_price = null; // Reset
            // Save original CIAN prices for price source selector
            window.lastEstimate.cian_price = bottom3Price;
            window.lastEstimate.cian_psm = bottom3PsmWithBargain;

            // Early calculation of Rosreestr and Combined prices for price source selector
            const hasRosreestrDeals = estimate.rosreestr_deals && estimate.rosreestr_deals.length > 0;
            if (hasRosreestrDeals) {
                // Calculate Rosreestr price (same logic as in generateInvestmentAnalysis)
                const validDeals = estimate.rosreestr_deals.filter(d => d.price_per_sqm > 0 && d.area > 0);
                const rosreestrPrices = validDeals.map(d => d.price_per_sqm).sort((a, b) => a - b);
                const rosreestrMedian = rosreestrPrices.length > 0 ? rosreestrPrices[Math.floor(rosreestrPrices.length / 2)] : 0;
                const filteredDeals = validDeals.filter(d => d.price_per_sqm >= rosreestrMedian * 0.7);

                // Score and sort by relevance
                const targetArea = data.area_total;
                const targetYear = estimate.building_year || 2000;
                const scoredDeals = filteredDeals.map(d => {
                    let score = 100;
                    score -= Math.abs(targetArea - d.area) * 2;
                    if (d.year_build && targetYear) {
                        score -= Math.abs(targetYear - d.year_build) * 1;
                    }
                    if (d.area >= targetArea * 0.8 && d.area <= targetArea * 1.2) {
                        score += 20;
                    }
                    return { ...d, relevance_score: score };
                });
                const rosreestrTop3 = scoredDeals.sort((a, b) => b.relevance_score - a.relevance_score).slice(0, 3);

                if (rosreestrTop3.length > 0) {
                    const avgRosreestrPsm = rosreestrTop3.reduce((sum, d) => sum + d.price_per_sqm, 0) / rosreestrTop3.length;
                    const rosreestrPrice = avgRosreestrPsm * data.area_total;
                    window.lastEstimate.rosreestr_price = rosreestrPrice;
                    window.lastEstimate.rosreestr_psm = avgRosreestrPsm;

                    // Combined price (40% CIAN + 60% Rosreestr)
                    const combinedPsm = bottom3PsmWithBargain * 0.4 + avgRosreestrPsm * 0.6;
                    const combinedPrice = combinedPsm * data.area_total;
                    window.lastEstimate.combined_price = combinedPrice;
                    window.lastEstimate.combined_psm = combinedPsm;
                }
            }

            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ü–µ–Ω—É (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞), –∏–Ω–∞—á–µ –¶–ò–ê–ù
            let finalDisplayPrice = displayPrice;
            let finalDisplayPsm = displayPricePerSqm;
            if (window.lastEstimate.combined_price && window.lastEstimate.combined_psm) {
                finalDisplayPrice = window.lastEstimate.combined_price;
                finalDisplayPsm = window.lastEstimate.combined_psm;
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–∫–∂–µ bottom3_price –∏ original –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ—Å—á—ë—Ç–∞
                window.lastEstimate.bottom3_price = finalDisplayPrice;
                window.lastEstimate.bottom3_price_per_sqm = finalDisplayPsm;
                window.lastEstimate.original_bottom3_price = finalDisplayPrice;
            }

            const priceInMillions = (finalDisplayPrice / 1000000).toFixed(2);
            document.getElementById('price').innerHTML =
                `${priceInMillions} –º–ª–Ω ‚ÇΩ<br><span style="font-size: 14px; opacity: 0.7; font-weight: normal;">${Math.round(finalDisplayPrice).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
            document.getElementById('pricePerSqm').textContent =
                Math.round(finalDisplayPsm).toLocaleString('ru-RU') + ' ‚ÇΩ';
            
            // Display building type
            const typeNames = {
                'panel': '–ü–∞–Ω–µ–ª—å',
                'brick': '–ö–∏—Ä–ø–∏—á',
                'monolithic': '–ú–æ–Ω–æ–ª–∏—Ç',
                'block': '–ë–ª–æ—á–Ω—ã–π',
                'wood': '–î–µ—Ä–µ–≤–æ',
                'other': '–î—Ä—É–≥–æ–µ'
            };
            const buildingTypeElem = document.getElementById('buildingTypeDisplay');
            if (estimate.building_type_detected) {
                const typeName = typeNames[estimate.building_type_detected] || estimate.building_type_detected;
                const isAuto = estimate.building_type_source !== 'manual';
                const sourceEmoji = isAuto ? 'ü§ñ' : '‚úã';
                buildingTypeElem.innerHTML = `${typeName}<br><span style="font-size: 12px; opacity: 0.7; font-weight: normal;">${sourceEmoji} ${isAuto ? '–∞–≤—Ç–æ' : '–≤—Ä—É—á–Ω—É—é'}</span>`;
            } else {
                buildingTypeElem.innerHTML = '<span style="opacity: 0.5;">–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω</span>';
            }
            
            document.getElementById('confidence').textContent = 
                estimate.confidence + '%';
            
            // Display interest price (investment analysis)
            // Recalculate interest price based on BOTTOM-3 price
            const interestPriceElem = document.getElementById('interestPrice');
            // Interest price = BOTTOM-3 price minus expected profit margin (~15%)
            const recalcInterestPrice = bottom3Price * 0.85; // 15% margin for investor
            if (recalcInterestPrice > 0) {
                const interestMillions = (recalcInterestPrice / 1000000).toFixed(2);
                const discount = ((bottom3Price - recalcInterestPrice) / bottom3Price * 100).toFixed(1);
                interestPriceElem.innerHTML =
                    `${interestMillions} –º–ª–Ω ‚ÇΩ<br><span style="font-size: 12px; opacity: 0.7; font-weight: normal;">‚Üì ${discount}% –æ—Ç —Ä—ã–Ω–∫–∞</span>`;
                window.lastEstimate.interest_price = recalcInterestPrice;

                // Update discount from market card
                const discountAmount = bottom3Price - recalcInterestPrice;
                document.getElementById('discountFromMarket').innerHTML =
                    `${discount}%<br><span style="font-size: 12px; opacity: 0.7; font-weight: normal;">${(discountAmount / 1000000).toFixed(2)} –º–ª–Ω ‚ÇΩ</span>`;

                // Calculate initial profit (simple: 15% margin * price, adjusted later by recalculateInterestPrice)
                const initialProfit = discountAmount * 0.5; // –ü—Ä–∏–º–µ—Ä–Ω–æ –ø–æ–ª–æ–≤–∏–Ω–∞ —Å–∫–∏–¥–∫–∏ ‚Äî –Ω–∞—à–∞ –ø—Ä–∏–±—ã–ª—å (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
                document.getElementById('ourProfit').innerHTML =
                    `${(initialProfit / 1000000).toFixed(2)} –º–ª–Ω ‚ÇΩ<br><span style="font-size: 12px; opacity: 0.7; font-weight: normal;">—Ä–∞—Å—á—ë—Ç –Ω–∏–∂–µ</span>`;

                // Store for later use
                window.lastEstimate.discount_percent = parseFloat(discount);
                window.lastEstimate.discount_amount = discountAmount;

                // Show investment button
                document.getElementById('showInvestmentBtn').style.display = 'block';
            } else {
                interestPriceElem.innerHTML = '<span style="opacity: 0.5; font-size: 14px;">–Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞</span>';
                document.getElementById('discountFromMarket').innerHTML = '-';
                document.getElementById('ourProfit').innerHTML = '-';
                document.getElementById('showInvestmentBtn').style.display = 'none';
            }

            // Show price source selector if Rosreestr prices were calculated
            const priceSourceSelector = document.getElementById('priceSourceSelector');
            if (priceSourceSelector) {
                // Only show if rosreestr price was actually calculated
                if (window.lastEstimate.rosreestr_price && window.lastEstimate.rosreestr_psm) {
                    priceSourceSelector.style.display = 'block';
                    // Reset to CIAN by default
                    window.currentPriceSource = 'cian';
                    // Don't call updatePriceSource here - it would override the initial display
                } else {
                    priceSourceSelector.style.display = 'none';
                }
            }

            // Show price adjustment section
            const priceAdjustmentSection = document.getElementById('priceAdjustmentSection');
            if (priceAdjustmentSection) {
                priceAdjustmentSection.style.display = 'block';
                // Reset adjustment values
                document.getElementById('priceAdjustment').value = '';
                document.getElementById('adjustmentNote').value = '';
                document.getElementById('adjustmentNote').dataset.autoGenerated = '';
                document.getElementById('adjustedPriceDisplay').style.display = 'none';
                window.currentPriceAdjustment = 0;
                window.adjustmentNote = '';

                // Check for floor-based discounts (1st floor -20%, last floor -5%)
                checkFloorDiscounts();
            }

            // Display detected parameters
            const propertyDetails = document.getElementById('propertyDetails');
            const detectedParams = document.getElementById('detectedParams');
            if (propertyDetails && detectedParams) {
                let paramsHtml = '';
                
                // Add external map links if coordinates available
                if (data.lat && data.lon) {
                    paramsHtml += `<div style="margin-bottom: 12px; padding: 10px; background: rgba(34, 197, 94, 0.1); border-radius: 6px;">`;
                    paramsHtml += `<div style="margin-bottom: 6px; font-weight: 600; color: #22c55e;">üó∫Ô∏è –î–∞–Ω–Ω—ã–µ –æ –¥–æ–º–µ –Ω–∞ –∫–∞—Ä—Ç–∞—Ö:</div>`;
                    paramsHtml += `<div style="display: flex; gap: 12px; flex-wrap: wrap; font-size: 13px;">`;
                    
                    // –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã
                    const yandexUrl = `https://yandex.ru/maps/?ll=${data.lon},${data.lat}&z=18&l=map`;
                    paramsHtml += `<a href="${yandexUrl}" target="_blank" style="color: #60a5fa; text-decoration: none; padding: 6px 12px; background: rgba(96, 165, 250, 0.1); border-radius: 4px; border: 1px solid rgba(96, 165, 250, 0.3);">üìç –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã</a>`;
                    
                    // Google Maps
                    const googleUrl = `https://www.google.com/maps/@${data.lat},${data.lon},18z`;
                    paramsHtml += `<a href="${googleUrl}" target="_blank" style="color: #60a5fa; text-decoration: none; padding: 6px 12px; background: rgba(96, 165, 250, 0.1); border-radius: 4px; border: 1px solid rgba(96, 165, 250, 0.3);">üåç Google Maps</a>`;
                    
                    // OpenStreetMap
                    const osmUrl = `https://www.openstreetmap.org/?mlat=${data.lat}&mlon=${data.lon}&zoom=18`;
                    paramsHtml += `<a href="${osmUrl}" target="_blank" style="color: #60a5fa; text-decoration: none; padding: 6px 12px; background: rgba(96, 165, 250, 0.1); border-radius: 4px; border: 1px solid rgba(96, 165, 250, 0.3);">üó∫Ô∏è OpenStreetMap</a>`;
                    
                    // –†–µ—Ñ–æ—Ä–º–∞ –ñ–ö–• (mingkh.ru) - –ø–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É
                    if (data.address) {
                        const mingkhUrl = `https://www.reformagkh.ru/search/houses?search=${encodeURIComponent(data.address)}`;
                        paramsHtml += `<a href="${mingkhUrl}" target="_blank" style="color: #f59e0b; text-decoration: none; padding: 6px 12px; background: rgba(245, 158, 11, 0.1); border-radius: 4px; border: 1px solid rgba(245, 158, 11, 0.3);">üè¢ –†–µ—Ñ–æ—Ä–º–∞ –ñ–ö–•</a>`;
                    }
                    
                    paramsHtml += `</div>`;
                    paramsHtml += `<div style="margin-top: 6px; font-size: 11px; opacity: 0.7;">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∏–ø –¥–æ–º–∞, –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Å—Ç–µ–Ω –Ω–∞ –∫–∞—Ä—Ç–∞—Ö</div>`;
                    paramsHtml += `</div>`;
                }
                
                if (estimate.building_type_detected) {
                    const typeNames = {
                        'panel': '–ü–∞–Ω–µ–ª—å',
                        'brick': '–ö–∏—Ä–ø–∏—á',
                        'monolithic': '–ú–æ–Ω–æ–ª–∏—Ç',
                        'block': '–ë–ª–æ—á–Ω—ã–π',
                        'wood': '–î–µ—Ä–µ–≤–æ',
                        'other': '–î—Ä—É–≥–æ–µ'
                    };
                    const typeName = typeNames[estimate.building_type_detected] || estimate.building_type_detected;
                    const isAuto = estimate.building_type_source !== 'manual';
                    const sourceEmoji = isAuto ? 'ü§ñ' : '‚úã';
                    const sourceText = isAuto ? '–∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ' : '—É–∫–∞–∑–∞–Ω –≤—Ä—É—á–Ω—É—é';
                    paramsHtml += `<div style="margin-bottom: 6px;">üèóÔ∏è  –¢–∏–ø –¥–æ–º–∞: <strong>${typeName}</strong> ${sourceEmoji} <span style="opacity: 0.7; font-size: 12px;">(${sourceText})</span></div>`;
                    
                    // Show sources for verification
                    if (estimate.building_type_sources && estimate.building_type_sources.length > 0) {
                        paramsHtml += `<div style="margin-left: 24px; margin-top: 4px; font-size: 12px; opacity: 0.8;">`;
                        paramsHtml += `<div style="margin-bottom: 4px;">üîó –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ –ø–æ—Ö–æ–∂–∏—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏—è—Ö:</div>`;
                        estimate.building_type_sources.forEach((source, idx) => {
                            const idShort = source.url ? source.url.split('/').filter(s => s).pop() : source.id;
                            const distanceText = source.distance_m ? ` (${source.distance_m}–º)` : '';
                            paramsHtml += `<div style="margin-left: 8px;">`;
                            if (source.url) {
                                paramsHtml += `‚Ä¢ <a href="${source.url}" target="_blank" style="color: #60a5fa;">ID ${idShort}</a>${distanceText}`;
                            } else {
                                paramsHtml += `‚Ä¢ ID ${source.id}${distanceText}`;
                            }
                            paramsHtml += `</div>`;
                        });
                        paramsHtml += `</div>`;
                    }
                }
                
                if (estimate.district_id) {
                    paramsHtml += `<div>üìç –†–∞–π–æ–Ω ID: <strong>${estimate.district_id}</strong></div>`;
                }

                // Show building info warning if available
                if (estimate.building_info_warning) {
                    paramsHtml += `
                        <div style="margin-top: 12px; padding: 12px; background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.4); border-radius: 6px;">
                            <div style="color: #f59e0b; font-weight: 600; margin-bottom: 6px;">‚ö†Ô∏è –í–∞–∂–Ω–æ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –æ—Ü–µ–Ω–∫–∏</div>
                            <div style="font-size: 13px; color: #fbbf24;">${estimate.building_info_warning}</div>
                            <div style="font-size: 12px; color: #9ca3af; margin-top: 8px;">
                                üí° –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∞–Ω–∞–ª–æ–≥–æ–≤ –ø–æ —ç—Ç–∞–∂–Ω–æ—Å—Ç–∏ –∏ –≥–æ–¥—É –ø–æ—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –±–µ–∑ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö.
                                –•—Ä—É—â–µ–≤–∫–∏ –º–æ–≥—É—Ç –ø–æ–ø–∞—Å—Ç—å –≤ –∞–Ω–∞–ª–æ–≥–∏ –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–æ–º–æ–≤.
                            </div>
                        </div>
                    `;
                }

                // Show Rosreestr summary if available
                if (estimate.rosreestr_count && estimate.rosreestr_count > 0) {
                    paramsHtml += `<div style="margin-top: 8px;">üìã –°–¥–µ–ª–∫–∏ –†–æ—Å—Ä–µ–µ—Å—Ç—Ä–∞: <strong style="color: #f59e0b;">${estimate.rosreestr_count}</strong> –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥</div>`;
                }

                if (paramsHtml) {
                    detectedParams.innerHTML = paramsHtml;
                    propertyDetails.style.display = 'block';
                } else {
                    propertyDetails.style.display = 'none';
                }
            }

            // Display comparables
            const comparablesSection = document.getElementById('comparablesSection');
            if (estimate.comparables && estimate.comparables.length > 0) {
                const sorted = [...estimate.comparables].sort((a, b) => a.price_per_sqm - b.price_per_sqm);
                window.currentComparables = sorted;

                let compHtml = '<div class="comparables-title">üèÜ –ü–æ—Ö–æ–∂–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã (–ø–æ —Ü–µ–Ω–µ –∑–∞ –º¬≤):</div>';
                compHtml += `<div style="margin-bottom: 10px; font-size: 12px; color: #9ca3af;">–û—Ç–º–µ—Ç—å—Ç–µ —á–µ–∫–±–æ–∫—Å –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è. ID –æ—Ü–µ–Ω–∫–∏: <strong style="color: #22c55e;">${estimate.valuation_id || '–ù–ï–¢'}</strong></div>`;

                sorted.forEach((comp, i) => {
                    const isTop3 = i < 3;
                    const idShort = comp.url ? comp.url.split('/').filter(s => s).pop() : comp.listing_id;

                    compHtml += `
                        <div class="comparable-item ${isTop3 ? 'top3' : ''}" id="comp-${comp.listing_id}">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="exclude-${comp.listing_id}" class="exclude-checkbox" data-listing-id="${comp.listing_id}" style="width: 18px; height: 18px; cursor: pointer;">
                                <div class="comparable-left">
                                    <div class="comparable-header">
                                        <span class="comparable-rank">${i + 1}.</span>
                                        <span class="comparable-link" onclick="showListingModal(${comp.listing_id})" style="cursor: pointer;">ID ${idShort} üìÅ</span>
                                        ${comp.url ? `<a href="${comp.url}" target="_blank" style="color: #60a5fa; font-size: 12px; margin-left: 8px;">–¶–ò–ê–ù ‚Üó</a>` : ''}
                                        ${comp.listing_id ? `<a href="https://realestate.ourdocs.org/listing/${comp.listing_id}" target="_blank" style="color: #22c55e; font-size: 12px; margin-left: 8px;">–ù–∞—à–∞ –ë–î ‚Üó</a>` : ''}
                                        ${isTop3 ? '<span class="badge-top3">–¢–û–ü-3</span>' : ''}
                                    </div>
                                    <div class="comparable-meta">
                                        ${comp.distance_km.toFixed(1)} –∫–º ‚Ä¢ ${comp.rooms || '?'} –∫–æ–º–Ω ‚Ä¢ ${comp.area_total}–º¬≤ ‚Ä¢ —Å—Ö–æ–∂–µ—Å—Ç—å ${Math.round(comp.similarity_score)}%
                                    </div>
                                </div>
                            </div>
                            <div class="comparable-right">
                                <div class="comparable-price">${comp.price.toLocaleString('ru-RU')} ‚ÇΩ</div>
                                <div class="comparable-psm">${Math.round(comp.price_per_sqm).toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤</div>
                            </div>
                        </div>
                    `;
                });

                compHtml += `
                    <div id="refineSection" style="margin-top: 15px; display: none; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3);">
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 13px; color: #f87171;">–ü—Ä–∏—á–∏–Ω–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è:</label>
                            <input type="text" id="exclusionReason" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ω–µ—Ç–∏–ø–æ–≤–∞—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞, –∑–∞–≤—ã—à–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞..." style="margin-top: 5px; font-size: 13px;">
                        </div>
                        <button onclick="refineValuation()" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –±–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
                        </button>
                    </div>
                `;

                // Add Rosreestr deals section if available
                if (estimate.rosreestr_deals && estimate.rosreestr_deals.length > 0) {
                    compHtml += `
                        <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div class="comparables-title" style="color: #f59e0b;">üìã –°–¥–µ–ª–∫–∏ –†–æ—Å—Ä–µ–µ—Å—Ç—Ä–∞ (${estimate.rosreestr_count})</div>
                            <div style="margin-bottom: 10px; font-size: 12px; color: #9ca3af;">–†–µ–∞–ª—å–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥ —Ä—è–¥–æ–º —Å –æ–±—ä–µ–∫—Ç–æ–º</div>
                    `;

                    estimate.rosreestr_deals.forEach((deal, i) => {
                        const dealDate = deal.deal_date ? new Date(deal.deal_date).toLocaleDateString('ru-RU') : '–¥–∞—Ç–∞ –Ω–µ–∏–∑–≤.';
                        compHtml += `
                            <div class="comparable-item" style="border-left: 3px solid #f59e0b;">
                                <div class="comparable-left">
                                    <div class="comparable-header">
                                        <span class="comparable-rank" style="color: #f59e0b;">${i + 1}.</span>
                                        <span style="font-size: 13px;">${deal.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
                                        <span style="font-size: 11px; color: #9ca3af; margin-left: 8px;">üìÖ ${dealDate}</span>
                                    </div>
                                    <div class="comparable-meta">
                                        ${(deal.distance_m / 1000).toFixed(1)} –∫–º ‚Ä¢ ${deal.area}–º¬≤ ‚Ä¢ ${deal.floor ? '—ç—Ç–∞–∂ ' + deal.floor : ''} ${deal.year_build ? '‚Ä¢ ' + deal.year_build + ' –≥.' : ''}
                                    </div>
                                </div>
                                <div class="comparable-right">
                                    <div class="comparable-price" style="color: #fbbf24;">${deal.deal_price.toLocaleString('ru-RU')} ‚ÇΩ</div>
                                    <div class="comparable-psm" style="color: #f59e0b;">${deal.price_per_sqm ? Math.round(deal.price_per_sqm).toLocaleString('ru-RU') + ' ‚ÇΩ/–º¬≤' : ''}</div>
                                </div>
                            </div>
                        `;
                    });

                    compHtml += `</div>`;
                }

                comparablesSection.innerHTML = compHtml;
                console.log('Comparables HTML set, length:', compHtml.length);
                console.log('Checkboxes found:', document.querySelectorAll('.exclude-checkbox').length);

                // Add event listeners for checkboxes
                document.querySelectorAll('.exclude-checkbox').forEach(cb => {
                    cb.addEventListener('change', function() {
                        console.log('Checkbox changed:', this.dataset.listingId, this.checked);
                        updateRefineSection();
                    });
                });
            }

            // Generate detailed breakdown
            generateBreakdown(estimate, data);
            
            // Show breakdown button
            document.getElementById('showBreakdownBtn').style.display = 'block';
            
            // Save address for history and show history button
            window.currentAddress = data.address || 'Unknown';
            window.currentLat = data.lat;
            window.currentLon = data.lon;
            document.getElementById('showHistoryBtn').style.display = 'block';

            resultSection.classList.add('show');
        }

        function toggleBreakdown() {
            const section = document.getElementById('breakdownSection');
            const btn = document.getElementById('showBreakdownBtn');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                btn.style.display = 'none';
            } else {
                section.style.display = 'none';
                btn.style.display = 'block';
            }
        }

        function generateBreakdown(estimate, requestData) {
            const content = document.getElementById('breakdownContent');
            const sorted = [...estimate.comparables].sort((a, b) => a.price_per_sqm - b.price_per_sqm);
            const top3 = sorted.slice(0, 3);

            let html = '';

            // Step 1: Search parameters
            html += `<div style="margin-bottom: 25px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">`;
            html += `<h4 style="margin: 0 0 12px 0; color: #60a5fa; font-size: 16px;">–®–∞–≥ 1: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</h4>`;
            html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 14px;">`;
            html += `<div>üìç –†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞: <strong>5 –∫–º</strong></div>`;
            html += `<div>üìÖ –í–æ–∑—Ä–∞—Å—Ç: <strong>–¥–æ 90 –¥–Ω–µ–π</strong></div>`;
            html += `<div>üè† –ö–æ–º–Ω–∞—Ç: <strong>${requestData.rooms || '?'}</strong></div>`;
            html += `<div>üìè –ü–ª–æ—â–∞–¥—å: <strong>${requestData.area_total}–º¬≤</strong></div>`;
            html += `<div>üîç –ù–∞–π–¥–µ–Ω–æ: <strong>${estimate.comparables_count} –∞–Ω–∞–ª–æ–≥–æ–≤ –¶–ò–ê–ù</strong></div>`;
            if (estimate.rosreestr_count > 0) {
                html += `<div>üìã –°–¥–µ–ª–æ–∫ –†–æ—Å—Ä–µ–µ—Å—Ç—Ä–∞: <strong>${estimate.rosreestr_count}</strong></div>`;
            }

            // Add building type info
            if (estimate.building_type_detected) {
                const typeNames = {'panel': '–ü–∞–Ω–µ–ª—å', 'brick': '–ö–∏—Ä–ø–∏—á', 'monolithic': '–ú–æ–Ω–æ–ª–∏—Ç', 'block': '–ë–ª–æ—á–Ω—ã–π', 'wood': '–î–µ—Ä–µ–≤–æ', 'other': '–î—Ä—É–≥–æ–µ'};
                const typeName = typeNames[estimate.building_type_detected] || estimate.building_type_detected;
                const isAuto = estimate.building_type_source !== 'manual';
                const sourceEmoji = isAuto ? 'ü§ñ' : '‚úã';
                const sourceText = isAuto ? '–∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ' : '—É–∫–∞–∑–∞–Ω –≤—Ä—É—á–Ω—É—é';
                html += `<div>üèóÔ∏è –¢–∏–ø –¥–æ–º–∞: <strong>${typeName}</strong> ${sourceEmoji} <span style="font-size: 12px; opacity: 0.7;">(${sourceText})</span></div>`;
            }

            html += `</div></div>`;

            // Step 2: Area filters
            html += `<div style="margin-bottom: 25px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">`;
            html += `<h4 style="margin: 0 0 12px 0; color: #60a5fa; font-size: 16px;">–®–∞–≥ 2: –ì–∏–±–∫–∏–π –ø–æ–¥–±–æ—Ä –ø–æ –ø–ª–æ—â–∞–¥–∏</h4>`;
            html += `<p style="margin: 0 0 10px 0; font-size: 14px; opacity: 0.9;">`;
            html += `–î–ª—è ${requestData.rooms}-–∫–æ–º–Ω ${requestData.area_total}–º¬≤ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è:`;
            html += `</p>`;
            html += `<ul style="margin: 0; padding-left: 20px; font-size: 14px; opacity: 0.9;">`;
            html += `<li>${requestData.rooms}-–∫–æ–º–Ω –ª—é–±–æ–π –ø–ª–æ—â–∞–¥–∏</li>`;
            html += `<li>${requestData.rooms + 1}-–∫–æ–º–Ω —Å –ø–ª–æ—â–∞–¥—å—é ${requestData.area_total}-${requestData.area_total + 10}–º¬≤</li>`;
            if (requestData.rooms > 1) {
                html += `<li>${requestData.rooms - 1}-–∫–æ–º–Ω —Å –ø–ª–æ—â–∞–¥—å—é ${requestData.area_total - 10}-${requestData.area_total}–º¬≤</li>`;
            }
            html += `</ul></div>`;

            // Step 3: Area corrections
            html += `<div style="margin-bottom: 25px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">`;
            html += `<h4 style="margin: 0 0 12px 0; color: #60a5fa; font-size: 16px;">–®–∞–≥ 3: –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ —Ä–∞–∑–Ω–∏—Ü—É –ø–ª–æ—â–∞–¥–∏</h4>`;
            html += `<p style="margin: 0 0 10px 0; font-size: 14px; opacity: 0.9;">`;
            html += `–ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç <strong>0.2% –Ω–∞ –∫–∞–∂–¥—ã–π 1–º¬≤</strong> —Ä–∞–∑–Ω–∏—Ü—ã:`;
            html += `</p>`;
            html += `<div style="font-size: 13px; opacity: 0.85; margin-top: 10px;">`;
            html += `<div style="margin-bottom: 8px;">‚Ä¢ –ù–∞—à–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞ <strong>–±–æ–ª—å—à–µ</strong> –∞–Ω–∞–ª–æ–≥–∞ ‚Üí –µ–≥–æ ‚ÇΩ/–º¬≤ –∑–∞–≤—ã—à–µ–Ω–∞ ‚Üí –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º <span style="color: #f87171;">–≤–Ω–∏–∑</span></div>`;
            html += `<div>‚Ä¢ –ù–∞—à–∞ –∫–≤–∞—Ä—Ç–∏—Ä–∞ <strong>–º–µ–Ω—å—à–µ</strong> –∞–Ω–∞–ª–æ–≥–∞ ‚Üí –µ–≥–æ ‚ÇΩ/–º¬≤ –∑–∞–Ω–∏–∂–µ–Ω–∞ ‚Üí –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º <span style="color: #4ade80;">–≤–≤–µ—Ä—Ö</span></div>`;
            html += `</div></div>`;

            // Step 4: CIAN TOP-3
            html += `<div style="margin-bottom: 25px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">`;
            html += `<h4 style="margin: 0 0 12px 0; color: #22c55e; font-size: 16px;">–®–∞–≥ 4: –¢–û–ü-3 –¶–ò–ê–ù üìâ –°–ê–ú–´–ï –î–ï–®–ï–í–´–ï</h4>`;
            html += `<p style="margin: 0 0 15px 0; font-size: 14px; opacity: 0.9;">`;
            html += `–°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ ${estimate.comparables_count} –∞–Ω–∞–ª–æ–≥–æ–≤ –¶–ò–ê–ù –ø–æ <strong>—Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ü–µ–Ω–µ –∑–∞ –º¬≤</strong> `;
            html += `<span style="color: #22c55e; font-weight: 600;">–æ—Ç –î–ï–®–ï–í–´–• –∫ –¥–æ—Ä–æ–≥–∏–º</span>:`;
            html += `</p>`;
            html += `<div style="font-size: 14px;">`;

            top3.forEach((comp, i) => {
                const areaDiff = requestData.area_total - comp.area_total;
                const correctionPct = -0.2 * areaDiff;
                const originalPsm = comp.price / comp.area_total;

                html += `<div style="padding: 12px; margin-bottom: 10px; background: rgba(34, 197, 94, 0.1); border-left: 3px solid #22c55e; border-radius: 6px;">`;
                html += `<div style="font-weight: 600; margin-bottom: 6px;">${i + 1}. ${comp.rooms}-–∫–æ–º–Ω, ${comp.area_total}–º¬≤</div>`;
                html += `<div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;">`;
                html += `–†–∞–∑–Ω–∏—Ü–∞ –ø–ª–æ—â–∞–¥–∏: <strong>${areaDiff > 0 ? '+' : ''}${areaDiff.toFixed(1)}–º¬≤</strong> ‚Üí `;
                html += `–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞: <strong style="color: ${correctionPct < 0 ? '#f87171' : '#4ade80'}">${correctionPct > 0 ? '+' : ''}${correctionPct.toFixed(1)}%</strong>`;
                html += `</div>`;
                html += `<div style="font-size: 13px; opacity: 0.9;">`;
                html += `–ò—Å—Ö–æ–¥–Ω–∞—è: ${Math.round(originalPsm).toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤ ‚Üí `;
                html += `<strong>–°–∫–æ—Ä—Ä.: ${Math.round(comp.price_per_sqm).toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤</strong>`;
                html += `</div>`;
                html += `</div>`;
            });

            const avgCianTop3 = top3.reduce((sum, c) => sum + c.price_per_sqm, 0) / top3.length;
            html += `<div style="margin-top: 12px; padding: 10px; background: rgba(34, 197, 94, 0.15); border-radius: 6px; font-size: 14px;">`;
            html += `<strong>–°—Ä–µ–¥–Ω–µ–µ –¢–û–ü-3 –¶–ò–ê–ù:</strong> ${Math.round(avgCianTop3).toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤`;
            html += `</div>`;
            html += `</div></div>`;

            // Step 5: Rosreestr TOP-3
            let avgRosreestrTop3 = 0;
            let hasRosreestr = estimate.rosreestr_deals && estimate.rosreestr_deals.length > 0;

            html += `<div style="margin-bottom: 25px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">`;
            html += `<h4 style="margin: 0 0 12px 0; color: #f59e0b; font-size: 16px;">–®–∞–≥ 5: –¢–û–ü-3 –†–æ—Å—Ä–µ–µ—Å—Ç—Ä üìã –†–ï–ê–õ–¨–ù–´–ï –°–î–ï–õ–ö–ò</h4>`;

            if (hasRosreestr) {
                // –£–º–Ω—ã–π –æ—Ç–±–æ—Ä –∞–Ω–∞–ª–æ–≥–æ–≤ –†–æ—Å—Ä–µ–µ—Å—Ç—Ä–∞ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
                const validDeals = estimate.rosreestr_deals.filter(d => d.price_per_sqm > 0 && d.area > 0);

                // 1. –í—ã—á–∏—Å–ª—è–µ–º –º–µ–¥–∏–∞–Ω—É —Ü–µ–Ω –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤—ã–±—Ä–æ—Å–æ–≤
                const prices = validDeals.map(d => d.price_per_sqm).sort((a, b) => a - b);
                const medianPsm = prices.length > 0 ? prices[Math.floor(prices.length / 2)] : 0;

                // 2. –§–∏–ª—å—Ç—Ä—É–µ–º –≤—ã–±—Ä–æ—Å—ã: –∏—Å–∫–ª—é—á–∞–µ–º < 70% –º–µ–¥–∏–∞–Ω—ã (–Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞)
                const filtered = validDeals.filter(d => d.price_per_sqm >= medianPsm * 0.7);

                // 3. –û—Ü–µ–Ω–∏–≤–∞–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–π —Å–¥–µ–ª–∫–∏
                const targetArea = requestData.area_total;
                const targetYear = estimate.building_year || 2000;

                const scored = filtered.map(d => {
                    let score = 100;
                    // –®—Ç—Ä–∞—Ñ –∑–∞ —Ä–∞–∑–Ω–∏—Ü—É –ø–ª–æ—â–∞–¥–∏: -2 –±–∞–ª–ª–∞ –∑–∞ –∫–∞–∂–¥—ã–π –º¬≤ —Ä–∞–∑–Ω–∏—Ü—ã
                    const areaDiff = Math.abs(targetArea - d.area);
                    score -= areaDiff * 2;
                    // –®—Ç—Ä–∞—Ñ –∑–∞ —Ä–∞–∑–Ω–∏—Ü—É –≥–æ–¥–∞: -1 –±–∞–ª–ª –∑–∞ –∫–∞–∂–¥—ã–π –≥–æ–¥
                    if (d.year_build && targetYear) {
                        const yearDiff = Math.abs(targetYear - d.year_build);
                        score -= yearDiff * 1;
                    }
                    // –ë–æ–Ω—É—Å –µ—Å–ª–∏ –ø–ª–æ—â–∞–¥—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö ¬±20%
                    if (d.area >= targetArea * 0.8 && d.area <= targetArea * 1.2) {
                        score += 20;
                    }
                    return { ...d, relevance_score: score };
                });

                // 4. –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (–≤—ã—Å—à–∏–π –±–∞–ª–ª = –ª—É—á—à–µ)
                const rosreestrTop3 = scored
                    .sort((a, b) => b.relevance_score - a.relevance_score)
                    .slice(0, 3);

                html += `<p style="margin: 0 0 15px 0; font-size: 14px; opacity: 0.9;">`;
                html += `–û—Ç–±–∏—Ä–∞–µ–º –∏–∑ ${validDeals.length} —Å–¥–µ–ª–æ–∫ <strong>–Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ</strong> `;
                html += `(–∏—Å–∫–ª—é—á–µ–Ω—ã ${validDeals.length - filtered.length} –≤—ã–±—Ä–æ—Å–æ–≤ &lt;70% –º–µ–¥–∏–∞–Ω—ã):`;
                html += `</p>`;
                html += `<div style="font-size: 14px;">`;

                rosreestrTop3.forEach((deal, i) => {
                    const dealDate = deal.deal_date ? new Date(deal.deal_date).toLocaleDateString('ru-RU') : '–¥–∞—Ç–∞ –Ω–µ–∏–∑–≤.';
                    const areaDiff = requestData.area_total - deal.area;
                    const correctionPct = -0.2 * areaDiff;
                    const correctedPsm = deal.price_per_sqm * (1 - 0.002 * areaDiff);
                    const yearInfo = deal.year_build ? `, ${deal.year_build} –≥.` : '';
                    const relevance = deal.relevance_score ? Math.round(deal.relevance_score) : '-';

                    html += `<div style="padding: 12px; margin-bottom: 10px; background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b; border-radius: 6px;">`;
                    html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">`;
                    html += `<div style="font-weight: 600;">${i + 1}. ${deal.area}–º¬≤${yearInfo} ‚Äî ${dealDate}</div>`;
                    html += `<div style="font-size: 11px; padding: 2px 6px; background: rgba(245,158,11,0.3); border-radius: 4px;">—Ä–µ–ª–µ–≤: ${relevance}</div>`;
                    html += `</div>`;
                    html += `<div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;">`;
                    html += `Œî –ø–ª–æ—â–∞–¥—å: <strong>${areaDiff > 0 ? '+' : ''}${areaDiff.toFixed(1)}–º¬≤</strong> ‚Üí `;
                    html += `–∫–æ—Ä—Ä: <strong style="color: ${correctionPct < 0 ? '#f87171' : '#4ade80'}">${correctionPct > 0 ? '+' : ''}${correctionPct.toFixed(1)}%</strong>`;
                    html += `</div>`;
                    html += `<div style="font-size: 13px; opacity: 0.9;">`;
                    html += `${Math.round(deal.price_per_sqm).toLocaleString('ru-RU')} ‚Üí <strong>${Math.round(correctedPsm).toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤</strong>`;
                    html += `</div>`;
                    html += `</div>`;
                });

                // Calculate average with area correction
                avgRosreestrTop3 = rosreestrTop3.reduce((sum, d) => {
                    const areaDiff = requestData.area_total - d.area;
                    return sum + d.price_per_sqm * (1 - 0.002 * areaDiff);
                }, 0) / rosreestrTop3.length;

                html += `<div style="margin-top: 12px; padding: 10px; background: rgba(245, 158, 11, 0.15); border-radius: 6px; font-size: 14px;">`;
                html += `<strong>–°—Ä–µ–¥–Ω–µ–µ –¢–û–ü-3 –†–æ—Å—Ä–µ–µ—Å—Ç—Ä:</strong> ${Math.round(avgRosreestrTop3).toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤`;
                html += `</div>`;
                html += `</div>`;
            } else {
                html += `<div style="padding: 20px; text-align: center; opacity: 0.6;">`;
                html += `<div style="font-size: 32px; margin-bottom: 8px;">üìã</div>`;
                html += `<div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–¥–µ–ª–∫–∞—Ö –†–æ—Å—Ä–µ–µ—Å—Ç—Ä–∞ —Ä—è–¥–æ–º</div>`;
                html += `</div>`;
            }
            html += `</div>`;

            // Step 6: Final calculation (separate estimates for each source)
            const withBargainCian = avgCianTop3 * 0.93; // –¶–ò–ê–ù: -7% —Ç–æ—Ä–≥
            const finalPriceCian = withBargainCian * requestData.area_total;
            // –†–æ—Å—Ä–µ–µ—Å—Ç—Ä: –ë–ï–ó —Ç–æ—Ä–≥–∞ - —ç—Ç–æ —É–∂–µ —Å–æ–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏
            const finalPriceRosreestr = avgRosreestrTop3 * requestData.area_total;

            html += `<div style="padding: 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(34, 197, 94, 0.15)); border-radius: 8px; border: 2px solid #3b82f6;">`;
            html += `<h4 style="margin: 0 0 15px 0; color: #3b82f6; font-size: 16px;">–®–∞–≥ 6: –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç</h4>`;

            // CIAN estimate
            html += `<div style="padding: 15px; background: rgba(34, 197, 94, 0.1); border-left: 3px solid #22c55e; border-radius: 6px; margin-bottom: 12px;">`;
            html += `<div style="font-size: 14px; color: #22c55e; font-weight: 600; margin-bottom: 8px;">üìä –û—Ü–µ–Ω–∫–∞ –ø–æ –¶–ò–ê–ù (–æ–±—ä—è–≤–ª–µ–Ω–∏—è)</div>`;
            html += `<div style="font-size: 14px; margin-bottom: 4px;">–°—Ä–µ–¥–Ω–µ–µ –¢–û–ü-3: ${Math.round(avgCianTop3).toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤ √ó 0.93 (—Ç–æ—Ä–≥ 7%) = <strong>${Math.round(withBargainCian).toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤</strong></div>`;
            html += `<div style="font-size: 14px;">${Math.round(withBargainCian).toLocaleString('ru-RU')} √ó ${requestData.area_total}–º¬≤ = <strong style="color: #22c55e; font-size: 18px;">${Math.round(finalPriceCian).toLocaleString('ru-RU')} ‚ÇΩ</strong></div>`;
            html += `</div>`;

            // Rosreestr estimate - –ë–ï–ó —Ç–æ—Ä–≥–∞
            if (hasRosreestr && avgRosreestrTop3 > 0) {
                html += `<div style="padding: 15px; background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b; border-radius: 6px; margin-bottom: 12px;">`;
                html += `<div style="font-size: 14px; color: #f59e0b; font-weight: 600; margin-bottom: 8px;">üìã –û—Ü–µ–Ω–∫–∞ –ø–æ –†–æ—Å—Ä–µ–µ—Å—Ç—Ä—É (—Ä–µ–∞–ª—å–Ω—ã–µ —Å–¥–µ–ª–∫–∏)</div>`;
                html += `<div style="font-size: 14px; margin-bottom: 4px;">–°—Ä–µ–¥–Ω–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö: <strong>${Math.round(avgRosreestrTop3).toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤</strong> <span style="opacity: 0.7;">(—Ç–æ—Ä–≥ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è)</span></div>`;
                html += `<div style="font-size: 14px;">${Math.round(avgRosreestrTop3).toLocaleString('ru-RU')} √ó ${requestData.area_total}–º¬≤ = <strong style="color: #f59e0b; font-size: 18px;">${Math.round(finalPriceRosreestr).toLocaleString('ru-RU')} ‚ÇΩ</strong></div>`;
                html += `</div>`;
            }

            // –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å –æ–±–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞)
            if (hasRosreestr && avgRosreestrTop3 > 0) {
                const weightCian = 0.4;
                const weightRosreestr = 0.6;
                const combinedPsm = withBargainCian * weightCian + avgRosreestrTop3 * weightRosreestr;
                const combinedPrice = combinedPsm * requestData.area_total;

                html += `<div style="margin-top: 15px; padding: 18px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2)); border: 2px solid #8b5cf6; border-radius: 8px;">`;
                html += `<div style="font-size: 15px; color: #a78bfa; font-weight: 600; margin-bottom: 10px;">‚öñÔ∏è –ö–û–ú–ë–ò–ù–ò–†–û–í–ê–ù–ù–ê–Ø –û–¶–ï–ù–ö–ê</div>`;
                html += `<div style="font-size: 13px; margin-bottom: 8px; opacity: 0.9;">`;
                html += `–¶–ò–ê–ù (${Math.round(weightCian * 100)}%): ${Math.round(withBargainCian).toLocaleString('ru-RU')} √ó ${weightCian} = ${Math.round(withBargainCian * weightCian).toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤<br>`;
                html += `–†–æ—Å—Ä–µ–µ—Å—Ç—Ä (${Math.round(weightRosreestr * 100)}%): ${Math.round(avgRosreestrTop3).toLocaleString('ru-RU')} √ó ${weightRosreestr} = ${Math.round(avgRosreestrTop3 * weightRosreestr).toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤`;
                html += `</div>`;
                html += `<div style="font-size: 14px; margin-bottom: 6px;">–°—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è: <strong>${Math.round(combinedPsm).toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤</strong></div>`;
                html += `<div style="font-size: 20px; font-weight: 700; color: #a78bfa;">${Math.round(combinedPsm).toLocaleString('ru-RU')} √ó ${requestData.area_total}–º¬≤ = ${Math.round(combinedPrice).toLocaleString('ru-RU')} ‚ÇΩ</div>`;
                html += `</div>`;

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ü–µ–Ω—É
                window.lastEstimate.combined_price = combinedPrice;
                window.lastEstimate.combined_psm = combinedPsm;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–Ω—ã –†–æ—Å—Ä–µ–µ—Å—Ç—Ä–∞
            if (hasRosreestr && avgRosreestrTop3 > 0) {
                window.lastEstimate.rosreestr_price = finalPriceRosreestr;
                window.lastEstimate.rosreestr_psm = avgRosreestrTop3;
            }

            html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 14px;">`;
            html += `<div style="color: #60a5fa; font-weight: 600; margin-bottom: 6px;">üí° –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è:</div>`;
            html += `<div style="opacity: 0.9; font-size: 13px;">`;
            html += `‚Ä¢ <strong>–¶–ò–ê–ù</strong> ‚Äî —Ü–µ–Ω—ã –æ–±—ä—è–≤–ª–µ–Ω–∏–π ‚Üí –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ—Ä–≥ 7%<br>`;
            if (hasRosreestr) {
                html += `‚Ä¢ <strong>–†–æ—Å—Ä–µ–µ—Å—Ç—Ä</strong> ‚Äî —Ä–µ–∞–ª—å–Ω—ã–µ —Å–¥–µ–ª–∫–∏ ‚Üí —Ç–æ—Ä–≥ —É–∂–µ —É—á—Ç—ë–Ω<br>`;
                html += `‚Ä¢ <strong>–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</strong> ‚Äî 40% –¶–ò–ê–ù + 60% –†–æ—Å—Ä–µ–µ—Å—Ç—Ä<br>`;
            }
            html += `‚Ä¢ –í—ã–±–∏—Ä–∞–µ–º –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏ –ø–æ –ø–ª–æ—â–∞–¥–∏ –∏ –≥–æ–¥—É`;
            html += `</div></div>`;
            html += `</div>`;

            content.innerHTML = html;
        }

        // ========== HISTORY FUNCTIONS ==========
        
        let chartInstance = null;
        
        async function loadHistory() {
            const historySection = document.getElementById('historySection');
            const historyList = document.getElementById('historyList');
            const showHistoryBtn = document.getElementById('showHistoryBtn');
            
            try {
                // Use coordinates to find address in DB
                let searchAddress = window.currentAddress || 'Unknown';
                
                if (window.currentLat && window.currentLon) {
                    const searchResponse = await fetch(`/search-address?q=${encodeURIComponent(searchAddress)}`);
                    if (searchResponse.ok) {
                        const searchData = await searchResponse.json();
                        if (searchData.results && searchData.results.length > 0) {
                            searchAddress = searchData.results[0].address;
                        }
                    }
                }
                
                const response = await fetch(`/history/${encodeURIComponent(searchAddress)}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load history');
                }
                
                const data = await response.json();
                
                if (data.count === 0) {
                    historyList.innerHTML = `
                        <div style="text-align: center; padding: 40px; opacity: 0.6;">
                            <div style="font-size: 48px; margin-bottom: 12px;">üìä</div>
                            <div style="font-size: 16px;">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞ –ø—É—Å—Ç–∞</div>
                            <div style="font-size: 13px; margin-top: 8px;">–°–¥–µ–ª–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ü–µ–Ω–æ–∫, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–∏–Ω–∞–º–∏–∫—É</div>
                        </div>
                    `;
                    historySection.style.display = 'block';
                    showHistoryBtn.style.display = 'none';
                    return;
                }
                
                displayHistory(data);
                historySection.style.display = 'block';
                showHistoryBtn.style.display = 'none';
                
            } catch (error) {
                console.error('Error loading history:', error);
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${error.message}
                    </div>
                `;
                historySection.style.display = 'block';
                showHistoryBtn.style.display = 'none';
            }
        }
        
        function displayHistory(data) {
            const historyList = document.getElementById('historyList');
            
            // Draw chart
            drawPriceChart(data.history);
            
            // Display history list
            let html = '<div style="margin-top: 20px;">';
            html += `<h4 style="margin: 0 0 15px 0; color: #60a5fa; font-size: 16px;">üìã –í—Å–µ –æ—Ü–µ–Ω–∫–∏ (${data.count})</h4>`;
            
            data.history.forEach((item, index) => {
                const date = new Date(item.created_at);
                const dateStr = date.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const buildingTypeNames = {
                    'panel': '–ü–∞–Ω–µ–ª—å',
                    'brick': '–ö–∏—Ä–ø–∏—á',
                    'monolithic': '–ú–æ–Ω–æ–ª–∏—Ç',
                    'block': '–ë–ª–æ—á–Ω—ã–π',
                    'wood': '–î–µ—Ä–µ–≤–æ',
                    'other': '–î—Ä—É–≥–æ–µ'
                };
                const buildingType = buildingTypeNames[item.building_type] || item.building_type || '<span style="opacity: 0.5;" title="–¢–∏–ø –¥–æ–º–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω">–Ω–µ —É–∫–∞–∑–∞–Ω</span>';
                
                const isLatest = index === 0;
                const bgColor = isLatest ? 'rgba(34, 197, 94, 0.1)' : 'rgba(255,255,255,0.03)';
                const borderColor = isLatest ? '#22c55e' : 'rgba(255,255,255,0.1)';
                
                html += `<div style="margin-bottom: 15px; padding: 15px; background: ${bgColor}; border-left: 3px solid ${borderColor}; border-radius: 8px;">`;
                html += `<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">`;
                html += `<div>`;
                html += `<div style="font-size: 14px; color: #9ca3af; margin-bottom: 4px;">${dateStr} ${isLatest ? '<span style="color: #22c55e; font-weight: 600;">‚Ä¢ –ü–û–°–õ–ï–î–ù–Ø–Ø</span>' : ''}</div>`;
                html += `<div style="font-size: 12px; color: #9ca3af;">`;
                html += `${item.params.area_total}–º¬≤ ‚Ä¢ ${item.params.rooms || '?'} –∫–æ–º–Ω ‚Ä¢ ${buildingType}`;
                if (item.params.floor) html += ` ‚Ä¢ ${item.params.floor}/${item.params.total_floors || '?'} —ç—Ç–∞–∂`;
                html += `</div>`;
                html += `</div>`;
                html += `<div style="text-align: right;">`;
                html += `<div style="font-size: 16px; font-weight: 700; color: ${isLatest ? '#22c55e' : '#3b82f6'};">${(item.estimated_price / 1000000).toFixed(2)} –º–ª–Ω ‚ÇΩ</div>`;
                html += `<div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px;">${Math.round(item.estimated_price_per_sqm).toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤</div>`;
                if (item.interest_price) {
                    html += `<div style="font-size: 14px; font-weight: 600; color: #f59e0b; margin-top: 4px;">üíé ${(item.interest_price / 1000000).toFixed(2)} –º–ª–Ω ‚ÇΩ</div>`;
                    html += `<div style="font-size: 10px; color: #9ca3af;">—Ü–µ–Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞</div>`;
                }
                html += `</div>`;
                html += `</div>`;
                html += `<div style="display: flex; gap: 15px; font-size: 12px; color: #9ca3af; margin-bottom: 10px;">`;
                html += `<div>üéØ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: <strong style="color: #e5e7eb;">${item.confidence}%</strong></div>`;
                html += `<div>üìä –ú–µ—Ç–æ–¥: <strong style="color: #e5e7eb;">${item.method_used}</strong></div>`;
                html += `<div>üè† –ê–Ω–∞–ª–æ–≥–∏: <strong style="color: #e5e7eb;">${item.comparables_count}</strong></div>`;
                html += `</div>`;
                html += `<button onclick="loadHistoryComparables(${item.valuation_id})" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;">`;
                html += `üìã –ü–æ–∫–∞–∑–∞—Ç—å –∞–Ω–∞–ª–æ–≥–∏`;
                html += `</button>`;
                html += `<div id="comparables-${item.valuation_id}" style="display: none; margin-top: 15px;"></div>`;
                html += `</div>`;
            });
            
            html += '</div>';
            historyList.innerHTML = html;
        }
        
        function drawPriceChart(history) {
            if (history.length === 0) return;
            
            const ctx = document.getElementById('priceChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Prepare data (reverse to show chronological order)
            const reversedHistory = [...history].reverse();
            const labels = reversedHistory.map(item => {
                const date = new Date(item.created_at);
                return date.toLocaleDateString('ru-RU', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
            });
            const prices = reversedHistory.map(item => Math.round(item.estimated_price / 1000000 * 10) / 10); // –º–ª–Ω ‚ÇΩ
            const pricePerSqm = reversedHistory.map(item => Math.round(item.estimated_price_per_sqm / 1000)); // —Ç—ã—Å ‚ÇΩ/–º¬≤
            const interestPrices = reversedHistory.map(item => item.interest_price ? Math.round(item.interest_price / 1000000 * 10) / 10 : null); // –º–ª–Ω ‚ÇΩ
            
            const datasets = [
                {
                    label: '–†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ (–º–ª–Ω ‚ÇΩ)',
                    data: prices,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: true,
                    yAxisID: 'y'
                },
                {
                    label: '–¶–µ–Ω–∞ –∑–∞ –º¬≤ (—Ç—ã—Å ‚ÇΩ)',
                    data: pricePerSqm,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: false,
                    yAxisID: 'y1'
                }
            ];
            
            // Add interest price if available
            if (interestPrices.some(p => p !== null)) {
                datasets.push({
                    label: '–¶–µ–Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞ (–º–ª–Ω ‚ÇΩ)',
                    data: interestPrices,
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: false,
                    borderDash: [5, 5],
                    yAxisID: 'y'
                });
            }
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e5e7eb',
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleColor: '#e5e7eb',
                            bodyColor: '#e5e7eb',
                            borderColor: '#374151',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#9ca3af', font: { size: 11 } },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { 
                                color: '#22c55e',
                                font: { size: 11 },
                                callback: function(value) { return value + ' –º–ª–Ω'; }
                            },
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            title: {
                                display: true,
                                text: '–¶–µ–Ω–∞ (–º–ª–Ω ‚ÇΩ)',
                                color: '#22c55e'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { 
                                color: '#3b82f6',
                                font: { size: 11 },
                                callback: function(value) { return value + 'k'; }
                            },
                            grid: { display: false },
                            title: {
                                display: true,
                                text: '–¶–µ–Ω–∞ –∑–∞ –º¬≤ (—Ç—ã—Å ‚ÇΩ)',
                                color: '#3b82f6'
                            }
                        }
                    }
                }
            });
        }
        
        async function loadHistoryComparables(valuationId) {
            console.log('loadHistoryComparables called with:', valuationId);
            const container = document.getElementById(`comparables-${valuationId}`);
            console.log('Container found:', container);

            if (container.style.display === 'block') {
                container.style.display = 'none';
                return;
            }

            try {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                container.style.display = 'block';

                const response = await fetch(`/history/details/${valuationId}`);
                console.log('API response status:', response.status);
                if (!response.ok) throw new Error('Failed to load details');
                
                const data = await response.json();
                
                if (!data.comparables || data.comparables.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af;">–ê–Ω–∞–ª–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }
                
                // Sort by price per sqm
                const sorted = [...data.comparables].sort((a, b) => parseFloat(a.price_per_sqm) - parseFloat(b.price_per_sqm));
                
                let html = '<div style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">';
                html += `<h5 style="margin: 0 0 15px 0; color: #60a5fa; font-size: 14px;">üèÜ –ê–Ω–∞–ª–æ–≥–∏ –¥–ª—è —ç—Ç–æ–π –æ—Ü–µ–Ω–∫–∏ (${sorted.length})</h5>`;
                
                // Store current valuation ID for refinement
                window.currentHistoryValuationId = valuationId;

                // Dynamically determine TOP-3 from non-excluded items
                const nonExcluded = sorted.filter(c => c.excluded !== true);
                const top3Ids = nonExcluded.slice(0, 3).map(c => c.listing_id);

                sorted.forEach((comp, i) => {
                    const isExcluded = comp.excluded === true;
                    const isTop3 = !isExcluded && top3Ids.includes(comp.listing_id);
                    const bgColor = isExcluded ? 'rgba(239, 68, 68, 0.1)' : (isTop3 ? 'rgba(34, 197, 94, 0.1)' : 'rgba(255,255,255,0.02)');
                    const borderColor = isExcluded ? '#ef4444' : (isTop3 ? '#22c55e' : 'rgba(255,255,255,0.05)');

                    html += `<div style="margin-bottom: 10px; padding: 12px; background: ${bgColor}; border-left: 3px solid ${borderColor}; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; ${isExcluded ? 'opacity: 0.5;' : ''}">`;
                    html += `<div style="display: flex; align-items: center; gap: 10px;">`;
                    html += `<input type="checkbox" class="history-exclude-checkbox" data-listing-id="${comp.listing_id}" data-valuation-id="${valuationId}" style="width: 18px; height: 18px; cursor: pointer;" ${isExcluded ? 'checked disabled' : ''}>`;
                    html += `<div>`;
                    html += `<div style="font-size: 13px; font-weight: 600; margin-bottom: 4px;">`;
                    html += `${i + 1}. `;
                    if (comp.url) {
                        const idShort = comp.url.split('/').filter(s => s).pop();
                        html += `<span onclick="showListingModal(${comp.listing_id})" style="color: #60a5fa; cursor: pointer;">ID ${idShort} üìÅ</span>`;
                        html += ` <a href="${comp.url}" target="_blank" style="color: #60a5fa; font-size: 11px; margin-left: 4px;">–¶–ò–ê–ù ‚Üó</a>`;
                        if (comp.listing_id) html += ` <a href="https://realestate.ourdocs.org/listing/${comp.listing_id}" target="_blank" style="color: #22c55e; font-size: 11px; margin-left: 4px;">–ë–î ‚Üó</a>`;
                    } else {
                        html += `<span onclick="showListingModal(${comp.listing_id})" style="color: #60a5fa; cursor: pointer;">ID ${comp.listing_id} üìÅ</span>`;
                        if (comp.listing_id) html += ` <a href="https://realestate.ourdocs.org/listing/${comp.listing_id}" target="_blank" style="color: #22c55e; font-size: 11px; margin-left: 4px;">–ë–î ‚Üó</a>`;
                    }
                    if (isTop3) html += ` <span style="background: #22c55e; color: white; font-size: 9px; padding: 2px 6px; border-radius: 8px; margin-left: 6px;">–¢–û–ü-3</span>`;
                    if (isExcluded) html += ` <span style="background: #ef4444; color: white; font-size: 9px; padding: 2px 6px; border-radius: 8px; margin-left: 6px;">–ò–°–ö–õ–Æ–ß–Å–ù</span>`;
                    html += `</div>`;
                    html += `<div style="font-size: 11px; color: #9ca3af;">`;
                    if (comp.distance_km) html += `${parseFloat(comp.distance_km).toFixed(1)} –∫–º ‚Ä¢ `;
                    if (comp.rooms) html += `${comp.rooms} –∫–æ–º–Ω ‚Ä¢ `;
                    if (comp.area_total) html += `${parseFloat(comp.area_total).toFixed(0)}–º¬≤`;
                    if (comp.similarity_score) html += ` ‚Ä¢ —Å—Ö–æ–∂–µ—Å—Ç—å ${Math.round(parseFloat(comp.similarity_score))}%`;
                    html += `</div>`;
                    html += `</div>`;
                    html += `</div>`;
                    html += `<div style="text-align: right;">`;
                    html += `<div style="font-size: 15px; font-weight: 700; color: ${isTop3 ? '#22c55e' : '#3b82f6'};">${parseInt(comp.price).toLocaleString('ru-RU')} ‚ÇΩ</div>`;
                    html += `<div style="font-size: 11px; color: #9ca3af;">${Math.round(parseFloat(comp.price_per_sqm)).toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤</div>`;
                    html += `</div>`;
                    html += `</div>`;
                });

                // Add refinement section
                html += `
                    <div id="historyRefineSection-${valuationId}" style="margin-top: 15px; display: none; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3);">
                        <div style="margin-bottom: 10px;">
                            <label style="font-size: 13px; color: #f87171;">–ü—Ä–∏—á–∏–Ω–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è:</label>
                            <input type="text" id="historyExclusionReason-${valuationId}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ω–µ—Ç–∏–ø–æ–≤–∞—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞, –∑–∞–≤—ã—à–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞..." style="width: 100%; margin-top: 5px; padding: 8px; font-size: 13px; background: #1f2937; border: 1px solid #374151; border-radius: 6px; color: white;">
                        </div>
                        <button onclick="refineHistoryValuation(${valuationId})" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –±–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
                        </button>
                    </div>
                `;

                html += '</div>';
                console.log('Setting innerHTML, html length:', html.length);
                container.innerHTML = html;
                console.log('Checkboxes found after innerHTML:', container.querySelectorAll('.history-exclude-checkbox').length);

                // Add event listeners for checkboxes
                container.querySelectorAll('.history-exclude-checkbox:not([disabled])').forEach(cb => {
                    cb.addEventListener('change', () => updateHistoryRefineSection(valuationId));
                });
                console.log('Event listeners attached');
                
            } catch (error) {
                console.error('Error loading comparables:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–æ–≥–æ–≤</div>';
            }
        }

        function updateHistoryRefineSection(valuationId) {
            const container = document.getElementById(`comparables-${valuationId}`);
            const checked = container.querySelectorAll('.history-exclude-checkbox:checked:not([disabled])');
            const refineSection = document.getElementById(`historyRefineSection-${valuationId}`);

            if (checked.length > 0) {
                refineSection.style.display = 'block';
            } else {
                refineSection.style.display = 'none';
            }
        }

        async function refineHistoryValuation(valuationId) {
            const container = document.getElementById(`comparables-${valuationId}`);
            const checked = container.querySelectorAll('.history-exclude-checkbox:checked:not([disabled])');
            const reason = document.getElementById(`historyExclusionReason-${valuationId}`)?.value || '';

            if (checked.length === 0) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∞–Ω–∞–ª–æ–≥–∏ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è', 'error');
                return;
            }

            const excludedIds = Array.from(checked).map(cb => parseInt(cb.dataset.listingId));

            try {
                const response = await fetch('/valuation/refine', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        valuation_id: valuationId,
                        excluded_listing_ids: excludedIds,
                        reason: reason
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á—ë—Ç–∞');
                }

                showNotification(`‚úÖ ${result.message} –ù–æ–≤–∞—è —Ü–µ–Ω–∞: ${(result.new_estimated_price / 1000000).toFixed(2)} –º–ª–Ω ‚ÇΩ`, 'success');

                // Reload comparables to show updated state
                const containerEl = document.getElementById(`comparables-${valuationId}`);
                containerEl.style.display = 'none';
                await loadHistoryComparables(valuationId);

            } catch (error) {
                console.error('Refine error:', error);
                showNotification('‚ùå ' + error.message, 'error');
            }
        }

        function toggleHistory() {
            const section = document.getElementById('historySection');
            const btn = document.getElementById('showHistoryBtn');

            if (section.style.display === 'block') {
                section.style.display = 'none';
                btn.style.display = 'block';
            } else {
                section.style.display = 'block';
                btn.style.display = 'none';
            }
        }

        function toggleInvestment() {
            const section = document.getElementById('investmentSection');
            const btn = document.getElementById('showInvestmentBtn');

            if (section.style.display === 'none') {
                // Generate content on first open
                if (!section.dataset.loaded) {
                    generateInvestmentAnalysis(window.lastEstimate);
                    section.dataset.loaded = 'true';
                }
                section.style.display = 'block';
                btn.style.display = 'none';
            } else {
                section.style.display = 'none';
                btn.style.display = 'block';
            }
        }

        function getProjectTypeName(type) {
            const names = {
                'own': '–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π',
                'partner': '–ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π 50/50',
                'partner_flip': '–ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π –§–ª–∏–ø',
                'bank_flip': '–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –§–ª–∏–ø'
            };
            return names[type] || '–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π';
        }

        function generateInvestmentAnalysis(estimate) {
            if (!estimate || !estimate.interest_price) return;

            const content = document.getElementById('investmentContent');

            // –¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞ –∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ API
            const projectType = estimate.project_type || window.currentProjectType || 'own';
            const projectTypeName = estimate.project_type_name || getProjectTypeName(projectType);

            // –¶–µ–Ω—ã –∏–∑ —Ä–∞—Å—á–µ—Ç–∞ BOTTOM-3
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º displayed_sale_price –µ—Å–ª–∏ –µ—Å—Ç—å (–≤–∫–ª—é—á–∞–µ—Ç —Ä–µ–º–æ–Ω—Ç), –∏–Ω–∞—á–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É
            const salePrice = estimate.displayed_sale_price || estimate.bottom3_price || estimate.market_price || estimate.estimated_price;
            const interestPrice = estimate.interest_price;
            const areaTotal = estimate.area_total || parseFloat(document.getElementById('area')?.value) || 50;

            // –ü—Ä–∏–±—ã–ª—å –∏–∑ API
            const ourProfit = estimate.our_profit || estimate.expected_profit || 0;
            const partnerProfit = estimate.partner_profit || 0;
            const totalProfit = estimate.expected_profit || (ourProfit + partnerProfit);

            // –ü—Ä–æ—Ü–µ–Ω—Ç—ã
            const ourMonthlyRate = estimate.our_monthly_rate || estimate.monthly_profit_rate || 0;
            const projectMonths = estimate.project_months || 3;

            // –ò–ø–æ—Ç–µ–∫–∞ (–¥–ª—è bank_flip)
            const mortgageAmount = estimate.mortgage_amount || 0;
            const mortgageMonthly = estimate.mortgage_monthly_payment || 0;
            const mortgagePrepay = estimate.mortgage_prepayment || 0;

            // –†–µ–º–æ–Ω—Ç
            const renovationCost = estimate.renovation_cost || 0;
            const renovationBonus = estimate.renovation_bonus || 0;
            const renovationProfit = estimate.renovation_profit || 0;

            const discount = salePrice - interestPrice;
            const discountPercent = (discount / salePrice * 100).toFixed(1);

            let html = '<div style="display: grid; gap: 20px;">';

            // Update summary cards with calculated values
            const isFlip = projectType === 'partner_flip' || projectType === 'bank_flip';

            // Update summary cards (they now contain the main info)
            document.getElementById('discountFromMarket').innerHTML =
                `${discountPercent}%<br><span style="font-size: 12px; opacity: 0.7; font-weight: normal;">${(discount / 1000000).toFixed(2)} –º–ª–Ω ‚ÇΩ</span>`;
            document.getElementById('ourProfit').innerHTML =
                `${(ourProfit / 1000000).toFixed(2)} –º–ª–Ω ‚ÇΩ<br><span style="font-size: 12px; opacity: 0.7; font-weight: normal;">${(ourMonthlyRate * 100).toFixed(2)}%/–º–µ—Å –∑–∞ ${projectMonths} –º–µ—Å</span>`;

            // Additional metrics for partner/bank projects only
            const hasAdditionalMetrics = (projectType !== 'own' && partnerProfit > 0) || (projectType === 'bank_flip' && mortgageAmount > 0);

            if (hasAdditionalMetrics) {
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">';

                // –ü—Ä–∏–±—ã–ª—å –ø–∞—Ä—Ç–Ω–µ—Ä–∞ (–µ—Å–ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π –ø—Ä–æ–µ–∫—Ç)
                if (projectType !== 'own' && partnerProfit > 0) {
                    html += `<div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">`;
                    html += `<div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">ü§ù –ü—Ä–∏–±—ã–ª—å –ø–∞—Ä—Ç–Ω–µ—Ä–∞</div>`;
                    html += `<div style="font-size: 20px; font-weight: 600; color: #3b82f6;">${(partnerProfit / 1000000).toFixed(2)} –º–ª–Ω ‚ÇΩ</div>`;
                    html += `<div style="font-size: 11px; opacity: 0.6; margin-top: 3px;">50% –æ—Ç –æ–±—â–µ–π –ø—Ä–∏–±—ã–ª–∏</div>`;
                    html += `</div>`;
                }

                // –ò–ø–æ—Ç–µ–∫–∞ (–¥–ª—è bank_flip)
                if (projectType === 'bank_flip' && mortgageAmount > 0) {
                    html += `<div style="background: rgba(234, 179, 8, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(234, 179, 8, 0.3);">`;
                    html += `<div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">üè¶ –°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞</div>`;
                    html += `<div style="font-size: 20px; font-weight: 600; color: #eab308;">${(mortgageAmount / 1000000).toFixed(2)} –º–ª–Ω ‚ÇΩ</div>`;
                    html += `<div style="font-size: 11px; opacity: 0.6; margin-top: 3px;">${Math.round(mortgageMonthly).toLocaleString('ru-RU')} ‚ÇΩ/–º–µ—Å</div>`;
                    html += `</div>`;
                }

                html += '</div>';
            }
            
            // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ø—Ä–æ–µ–∫—Ç–∞
            const currentProjectType = window.currentProjectType || 'own';
            html += '<div style="margin-top: 20px; padding: 20px; background: rgba(139, 92, 246, 0.1); border-radius: 12px; border: 1px solid rgba(139, 92, 246, 0.3);">';
            html += '<div style="font-weight: 600; color: #8b5cf6; font-size: 16px; margin-bottom: 15px;">–¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞</div>';
            html += '<div style="display: flex; gap: 8px; flex-wrap: wrap;">';
            html += '<div id="pt_own" onclick="window.currentProjectType=\'own\'; setProjectTypeDefaults(\'own\'); recalculateInterestPrice()" style="cursor:pointer; padding:10px 14px; border-radius:8px; border:2px solid ' + (currentProjectType === 'own' ? '#22c55e' : 'transparent') + '; background:' + (currentProjectType === 'own' ? 'rgba(34,197,94,0.2)' : 'rgba(0,0,0,0.2)') + ';"><div style="font-weight:600; font-size:13px; color:#22c55e;">–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π</div><div style="font-size:10px; opacity:0.7;">100% –ø—Ä–∏–±—ã–ª–∏</div></div>';
            html += '<div id="pt_partner" onclick="window.currentProjectType=\'partner\'; setProjectTypeDefaults(\'partner\'); recalculateInterestPrice()" style="cursor:pointer; padding:10px 14px; border-radius:8px; border:2px solid ' + (currentProjectType === 'partner' ? '#3b82f6' : 'transparent') + '; background:' + (currentProjectType === 'partner' ? 'rgba(59,130,246,0.2)' : 'rgba(0,0,0,0.2)') + ';"><div style="font-weight:600; font-size:13px; color:#3b82f6;">–ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π</div><div style="font-size:10px; opacity:0.7;">50/50</div></div>';
            html += '<div id="pt_partner_flip" onclick="window.currentProjectType=\'partner_flip\'; setProjectTypeDefaults(\'partner_flip\'); recalculateInterestPrice()" style="cursor:pointer; padding:10px 14px; border-radius:8px; border:2px solid ' + (currentProjectType === 'partner_flip' ? '#f59e0b' : 'transparent') + '; background:' + (currentProjectType === 'partner_flip' ? 'rgba(245,158,11,0.2)' : 'rgba(0,0,0,0.2)') + ';"><div style="font-weight:600; font-size:13px; color:#f59e0b;">–ü–∞—Ä—Ç. –§–ª–∏–ø</div><div style="font-size:10px; opacity:0.7;">50/50 + —Ä–µ–º–æ–Ω—Ç</div></div>';
            html += '<div id="pt_bank_flip" onclick="window.currentProjectType=\'bank_flip\'; setProjectTypeDefaults(\'bank_flip\'); recalculateInterestPrice()" style="cursor:pointer; padding:10px 14px; border-radius:8px; border:2px solid ' + (currentProjectType === 'bank_flip' ? '#ef4444' : 'transparent') + '; background:' + (currentProjectType === 'bank_flip' ? 'rgba(239,68,68,0.2)' : 'rgba(0,0,0,0.2)') + ';"><div style="font-weight:600; font-size:13px; color:#ef4444;">–ë–∞–Ω–∫. –§–ª–∏–ø</div><div style="font-size:10px; opacity:0.7;">–ò–ø–æ—Ç–µ–∫–∞ 50/50</div></div>';
            html += '</div>';
            html += '</div>';

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (—á–µ–∫–±–æ–∫—Å—ã)
            html += '<div style="margin-top: 20px; padding: 20px; background: rgba(59, 130, 246, 0.05); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.2);">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">';
            html += '<div style="font-weight: 600; color: #3b82f6; font-size: 16px;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</div>';
            html += '<div style="display: flex; gap: 10px;">';
            html += '<button onclick="recalculateInterestPrice()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button>';
            html += '<button onclick="saveInvestmentParams()" id="saveInvestBtn" style="padding: 8px 16px; background: #22c55e; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>';
            html += '</div>';
            html += '</div>';

            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; font-size: 14px;">';

            // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤
            const cb = window.investmentCheckboxes || {};

            // –°—Ç–∏–ª–∏ –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
            const yellowStyle = 'background: rgba(245,158,11,0.15); border: 1px solid rgba(245,158,11,0.3);';
            const yellowHoverIn = "this.style.background='rgba(245,158,11,0.25)'";
            const yellowHoverOut = "this.style.background='rgba(245,158,11,0.15)'";
            const darkStyle = 'background: rgba(0,0,0,0.2);';
            const darkHoverIn = "this.style.background='rgba(0,0,0,0.3)'";
            const darkHoverOut = "this.style.background='rgba(0,0,0,0.2)'";

            // –ê–≥–µ–Ω—Ç—Å–∫–∏–µ - –∂—ë–ª—Ç—ã–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ
            const isOwnProject = currentProjectType === 'own';
            const agencyStyle = isOwnProject ? yellowStyle : darkStyle;
            const agencyHoverIn = isOwnProject ? yellowHoverIn : darkHoverIn;
            const agencyHoverOut = isOwnProject ? yellowHoverOut : darkHoverOut;

            // –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (—á–µ–∫–±–æ–∫—Å—ã)
            html += `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; ${darkStyle} border-radius: 6px; transition: all 0.2s;" onmouseover="${darkHoverIn}" onmouseout="${darkHoverOut}">`;
            html += `<input type="checkbox" id="param_notary" style="width: 18px; height: 18px; cursor: pointer;" ${cb.param_notary ? 'checked' : ''}>`;
            html += `<span>üìù –ù–æ—Ç–∞—Ä–∏—É—Å (50,000 ‚ÇΩ)</span>`;
            html += `</label>`;

            // –ì–æ—Å–ø–æ—à–ª–∏–Ω–∞ - –í–°–ï–ì–î–ê –∂—ë–ª—Ç–∞—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤)
            html += `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; ${yellowStyle} border-radius: 6px; transition: all 0.2s;" onmouseover="${yellowHoverIn}" onmouseout="${yellowHoverOut}">`;
            html += `<input type="checkbox" id="param_state_fee" style="width: 18px; height: 18px; cursor: pointer;" ${cb.param_state_fee ? 'checked' : ''}>`;
            html += `<span>üèõÔ∏è –ì–æ—Å–ø–æ—à–ª–∏–Ω–∞ (4,000 ‚ÇΩ)</span>`;
            html += `</label>`;

            html += `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; ${darkStyle} border-radius: 6px; transition: all 0.2s;" onmouseover="${darkHoverIn}" onmouseout="${darkHoverOut}">`;
            html += `<input type="checkbox" id="param_pip" style="width: 18px; height: 18px; cursor: pointer;" ${cb.param_pip ? 'checked' : ''}>`;
            html += `<span>üìê –ü–ò–ü (1,000 ‚ÇΩ)</span>`;
            html += `</label>`;

            // –ê–≥–µ–Ω—Ç—Å–∫–∏–µ - –∂—ë–ª—Ç—ã–µ –¥–ª—è –°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ
            html += `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; ${agencyStyle} border-radius: 6px; transition: all 0.2s;" onmouseover="${agencyHoverIn}" onmouseout="${agencyHoverOut}">`;
            html += `<input type="checkbox" id="param_agency" style="width: 18px; height: 18px; cursor: pointer;" ${cb.param_agency ? 'checked' : ''}>`;
            html += `<span>ü§ù –ê–≥–µ–Ω—Ç—Å–∫–∏–µ (200,000 ‚ÇΩ)</span>`;
            html += `</label>`;

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã - –¥–ª—è —Ñ–ª–∏–ø–æ–≤ –≤—ã–¥–µ–ª—è–µ–º –∂—ë–ª—Ç—ã–º (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ)
            const isFlipProject = currentProjectType === 'partner_flip' || currentProjectType === 'bank_flip';
            const flipStyle = isFlipProject ? yellowStyle : darkStyle;
            const flipHoverIn = isFlipProject ? yellowHoverIn : darkHoverIn;
            const flipHoverOut = isFlipProject ? yellowHoverOut : darkHoverOut;

            html += `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; ${flipStyle} border-radius: 6px; transition: all 0.2s;" onmouseover="${flipHoverIn}" onmouseout="${flipHoverOut}">`;
            html += `<input type="checkbox" id="param_renovation" style="width: 18px; height: 18px; cursor: pointer;" ${cb.param_renovation ? 'checked' : ''}>`;
            html += `<span>üèóÔ∏è –†–µ–º–æ–Ω—Ç</span>`;
            html += `<input type="number" id="renovation_rate" value="60000" min="10000" max="200000" step="5000" style="width: 90px; padding: 4px 8px; margin-left: auto; border-radius: 4px; border: 1px solid #374151; background: rgba(0,0,0,0.3); color: white; font-size: 12px;" onclick="event.stopPropagation()">`;
            html += `<span style="font-size: 11px; color: #9ca3af;">‚ÇΩ/–º¬≤</span>`;
            html += `</label>`;

            html += `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; ${flipStyle} border-radius: 6px; transition: all 0.2s;" onmouseover="${flipHoverIn}" onmouseout="${flipHoverOut}">`;
            html += `<input type="checkbox" id="param_foreman" style="width: 18px; height: 18px; cursor: pointer;" ${cb.param_foreman ? 'checked' : ''}>`;
            html += `<span>üë∑ –ü—Ä–æ—Ä–∞–± (100,000 ‚ÇΩ)</span>`;
            html += `</label>`;

            html += `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.3)'" onmouseout="this.style.background='rgba(0,0,0,0.2)'">`;
            html += `<input type="checkbox" id="param_eviction" style="width: 18px; height: 18px; cursor: pointer;" ${cb.param_eviction ? 'checked' : ''}>`;
            html += `<span>üö™ –í—ã—Å–µ–ª–µ–Ω–∏–µ (150,000 ‚ÇΩ, —Å—Ä–æ–∫ 12 –º–µ—Å)</span>`;
            html += `</label>`;

            html += `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.3)'" onmouseout="this.style.background='rgba(0,0,0,0.2)'">`;
            html += `<input type="checkbox" id="param_registrators_transfer" style="width: 18px; height: 18px; cursor: pointer;" ${cb.param_registrators_transfer ? 'checked' : ''}>`;
            html += `<span>üìã –†–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –ø–µ—Ä–µ—Ö–æ–¥ (15,000 ‚ÇΩ)</span>`;
            html += `</label>`;

            html += `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.3)'" onmouseout="this.style.background='rgba(0,0,0,0.2)'">`;
            html += `<input type="checkbox" id="param_registrators_mortgage" style="width: 18px; height: 18px; cursor: pointer;" ${cb.param_registrators_mortgage ? 'checked' : ''}>`;
            html += `<span>üè¶ –†–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∏–ø–æ—Ç–µ–∫–∞ (10,000 ‚ÇΩ)</span>`;
            html += `</label>`;

            html += `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.3)'" onmouseout="this.style.background='rgba(0,0,0,0.2)'">`;
            html += `<input type="checkbox" id="param_contur" style="width: 18px; height: 18px; cursor: pointer;" ${cb.param_contur ? 'checked' : ''}>`;
            html += `<span>üìÑ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ö–æ–Ω—Ç—É—Ä (4,000 ‚ÇΩ)</span>`;
            html += `</label>`;

            // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (—Ç–∞–∫–∂–µ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏)
            // –ñ–ö–• —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º —Å—Ä–æ–∫–æ–º
            const periodForDisplay = window.projectPeriodMonths || 3;
            const utilitiesTotal = periodForDisplay * 11500;
            html += `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: rgba(245,158,11,0.15); border-radius: 6px; border: 1px solid rgba(245,158,11,0.3); transition: all 0.2s;" onmouseover="this.style.background='rgba(245,158,11,0.25)'" onmouseout="this.style.background='rgba(245,158,11,0.15)'">`;
            html += `<input type="checkbox" id="param_utilities" style="width: 18px; height: 18px; cursor: pointer;" ${cb.param_utilities !== false ? 'checked' : ''}>`;
            html += `<span id="utilities_label">üè† –ñ–ö–• (${periodForDisplay} –º–µ—Å √ó 11,500 ‚ÇΩ = ${utilitiesTotal.toLocaleString('ru-RU')} ‚ÇΩ)</span>`;
            html += `</label>`;

            html += `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: rgba(245,158,11,0.15); border-radius: 6px; border: 1px solid rgba(245,158,11,0.3); transition: all 0.2s;" onmouseover="this.style.background='rgba(245,158,11,0.25)'" onmouseout="this.style.background='rgba(245,158,11,0.15)'">`;
            html += `<input type="checkbox" id="param_serbsky" style="width: 18px; height: 18px; cursor: pointer;" ${cb.param_serbsky !== false ? 'checked' : ''}>`;
            html += `<span>üè• –û—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –°–µ—Ä–±—Å–∫–æ–≥–æ (27,000 ‚ÇΩ)</span>`;
            html += `</label>`;

            html += `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: rgba(245,158,11,0.15); border-radius: 6px; border: 1px solid rgba(245,158,11,0.3); transition: all 0.2s;" onmouseover="this.style.background='rgba(245,158,11,0.25)'" onmouseout="this.style.background='rgba(245,158,11,0.15)'">`;
            html += `<input type="checkbox" id="param_tax" style="width: 18px; height: 18px; cursor: pointer;" ${cb.param_tax !== false ? 'checked' : ''}>`;
            html += `<span>üí∞ –ù–∞–ª–æ–≥ 6% (–æ—Ç –ø—Ä–æ–¥–∞–∂–∏)</span>`;
            html += `</label>`;

            // –°—Ä–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞ (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π, –≤—Å–µ–≥–¥–∞ –∂—ë–ª—Ç—ã–π)
            const savedPeriod = window.projectPeriodMonths || 3;
            html += `<label style="display: flex; align-items: center; gap: 8px; padding: 10px; ${yellowStyle} border-radius: 6px; transition: all 0.2s;" onmouseover="${yellowHoverIn}" onmouseout="${yellowHoverOut}">`;
            html += `<span>üìÖ –°—Ä–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞</span>`;
            html += `<input type="number" id="project_period_input" value="${savedPeriod}" min="1" max="24" step="1" style="width: 60px; padding: 4px 8px; margin-left: auto; border-radius: 4px; border: 1px solid rgba(245,158,11,0.5); background: rgba(0,0,0,0.3); color: white; font-size: 14px; text-align: center;" onclick="event.stopPropagation()" onchange="window.projectPeriodMonths = parseInt(this.value) || 3; updateProjectPeriodDisplay();">`;
            html += `<span style="font-size: 13px; color: #fcd34d;">–º–µ—Å</span>`;
            html += `</label>`;

            html += '</div>';
            html += '<div style="margin-top: 12px; font-size: 12px; opacity: 0.7; text-align: center;">üí° –û—Ç–º–µ—Ç—å—Ç–µ –Ω—É–∂–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å"</div>';
            html += '</div>';


            // Breakdown of costs
            if (estimate.investment_breakdown) {
                html += '<div style="margin-top: 20px; padding: 15px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">';
                html += '<div style="font-weight: 600; margin-bottom: 12px; color: #f59e0b;">üìä –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤:</div>';
                html += '<div style="display: grid; gap: 8px;" id="costBreakdownList">';

                for (const [name, amount] of Object.entries(estimate.investment_breakdown)) {
                    html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 4px;">`;
                    html += `<span>${name}</span>`;
                    html += `<span style="font-weight: 600;">${Math.round(amount).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                    html += `</div>`;
                }

                html += '</div></div>';
            }

            // –î–µ—Ç–∞–ª–∏ –∏–ø–æ—Ç–µ–∫–∏ (–¥–ª—è bank_flip)
            if (projectType === 'bank_flip' && mortgageAmount > 0) {
                const cbrKeyRate = estimate.cbr_key_rate || 16;
                const bankRateYearly = estimate.bank_rate_yearly || 21.5;
                const bankRateMonthly = estimate.bank_rate_monthly || 1.79;

                html += '<div style="margin-top: 20px; padding: 15px; background: rgba(234, 179, 8, 0.1); border-radius: 8px; border: 1px solid rgba(234, 179, 8, 0.3);">';
                html += '<div style="font-weight: 600; margin-bottom: 12px; color: #eab308;">üè¶ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–ø–æ—Ç–µ–∫–∏:</div>';
                html += '<div style="display: grid; gap: 8px;">';

                // –°—Ç–∞–≤–∫–∞ –¶–ë
                html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(139, 92, 246, 0.2); border-radius: 4px;">`;
                html += `<span>üí∞ –°—Ç–∞–≤–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è</span>`;
                html += `<span style="font-weight: 600; color: #8b5cf6;">${bankRateYearly.toFixed(1)}% –≥–æ–¥–æ–≤—ã—Ö (–¶–ë ${cbrKeyRate}% + 5.5%)</span>`;
                html += `</div>`;

                html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 4px;">`;
                html += `<span>–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞ (100% –æ—Ç —Ü–µ–Ω—ã)</span>`;
                html += `<span style="font-weight: 600;">${Math.round(mortgageAmount).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                html += `</div>`;

                html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 4px;">`;
                html += `<span>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂ (${bankRateMonthly.toFixed(1)}%/–º–µ—Å)</span>`;
                html += `<span style="font-weight: 600;">${Math.round(mortgageMonthly).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                html += `</div>`;

                const prepayPeriod = window.projectPeriodMonths || 3;
                html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(59, 130, 246, 0.2); border-radius: 4px;">`;
                html += `<span>üí∞ –ü–∞—Ä—Ç–Ω–µ—Ä –ø–ª–∞—Ç–∏—Ç –≤–ø–µ—Ä–µ–¥ (${prepayPeriod} –º–µ—Å %)</span>`;
                html += `<span style="font-weight: 600; color: #3b82f6;">${Math.round(mortgagePrepay).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                html += `</div>`;

                const mortgageIssue = estimate.mortgage_issue_cost || 0;
                if (mortgageIssue > 0) {
                    html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(59, 130, 246, 0.2); border-radius: 4px;">`;
                    html += `<span>üí∞ –ü–∞—Ä—Ç–Ω–µ—Ä –ø–ª–∞—Ç–∏—Ç –∑–∞ –≤—ã–¥–∞—á—É (0.75%)</span>`;
                    html += `<span style="font-weight: 600; color: #3b82f6;">${Math.round(mortgageIssue).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                    html += `</div>`;
                }

                const renovationIncomeDisplay = estimate.renovation_income || 0;
                const renovationPeriod = window.projectPeriodMonths || 3;
                if (renovationIncomeDisplay > 0) {
                    html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(139, 92, 246, 0.2); border-radius: 4px;">`;
                    html += `<span>üíµ –ù–∞—à –¥–æ—Ö–æ–¥ –Ω–∞ —Ä–µ–º–æ–Ω—Ç (4%/–º–µ—Å √ó ${renovationPeriod} –º–µ—Å)</span>`;
                    html += `<span style="font-weight: 600; color: #8b5cf6;">${Math.round(renovationIncomeDisplay).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                    html += `</div>`;
                }

                // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∏–Ω–∏–º—É–º
                const minGuaranteed = estimate.min_guaranteed || 0;
                const minGuaranteedSource = estimate.min_guaranteed_source || '';
                if (minGuaranteed > 0) {
                    html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(245, 158, 11, 0.2); border-radius: 4px; margin-top: 8px;">`;
                    html += `<span>‚ö° –ì–∞—Ä–∞–Ω—Ç. –º–∏–Ω–∏–º—É–º (${minGuaranteedSource})</span>`;
                    html += `<span style="font-weight: 600; color: #f59e0b;">${Math.round(minGuaranteed).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                    html += `</div>`;
                }

                html += '</div></div>';
            }

            // –î–µ—Ç–∞–ª–∏ —Ä–µ–º–æ–Ω—Ç–∞ (–¥–ª—è —Ñ–ª–∏–ø–æ–≤)
            if (isFlip && renovationCost > 0) {
                const renovationRate = parseInt(document.getElementById('renovation_rate')?.value) || 60000;
                const areaTotal = estimate.area_total || 0;
                const renovationIncome = estimate.renovation_income || 0;
                const roiRenovation = renovationCost > 0 ? ((renovationProfit / renovationCost) * 100).toFixed(0) : 0;

                html += '<div style="margin-top: 20px; padding: 15px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.3);">';
                html += '<div style="font-weight: 600; margin-bottom: 12px; color: #f59e0b;">üî® –ü–ê–†–ê–ú–ï–¢–†–´ –†–ï–ú–û–ù–¢–ê:</div>';
                html += '<div style="display: grid; gap: 8px;">';

                html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 4px;">`;
                html += `<span>üìê –ü–ª–æ—â–∞–¥—å</span>`;
                html += `<span style="font-weight: 600;">${areaTotal.toFixed(1)} –º¬≤</span>`;
                html += `</div>`;

                html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 4px;">`;
                html += `<span>üí∞ –°—Ç–∞–≤–∫–∞</span>`;
                html += `<span style="font-weight: 600;">${renovationRate.toLocaleString('ru-RU')} ‚ÇΩ/–º¬≤</span>`;
                html += `</div>`;

                html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 4px;">`;
                html += `<span>üîß –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–º–æ–Ω—Ç–∞</span>`;
                html += `<span style="font-weight: 600;">${Math.round(renovationCost).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                html += `</div>`;

                html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 4px;">`;
                html += `<span>üìä –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø—Ä–∏–±–∞–≤–∫–∏</span>`;
                html += `<span style="font-weight: 600;">√ó1.6</span>`;
                html += `</div>`;

                html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(34, 197, 94, 0.2); border-radius: 4px;">`;
                html += `<span>‚ú® –ü—Ä–∏–±–∞–≤–∫–∞ –∫ —Ü–µ–Ω–µ</span>`;
                html += `<span style="font-weight: 600; color: #22c55e;">+${Math.round(renovationBonus).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                html += `</div>`;

                html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(34, 197, 94, 0.15); border-radius: 4px;">`;
                html += `<span>üìà –ü—Ä–æ—Ñ–∏—Ç –æ—Ç —Ä–µ–º–æ–Ω—Ç–∞ (–ø—Ä–∏–±–∞–≤–∫–∞ - –∑–∞—Ç—Ä–∞—Ç—ã)</span>`;
                html += `<span style="font-weight: 600; color: #22c55e;">${Math.round(renovationProfit).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                html += `</div>`;

                html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(34, 197, 94, 0.1); border-radius: 4px;">`;
                html += `<span>üìä ROI —Ä–µ–º–æ–Ω—Ç–∞</span>`;
                html += `<span style="font-weight: 600; color: #22c55e;">+${roiRenovation}%</span>`;
                html += `</div>`;

                if (renovationIncome > 0) {
                    const renoPeriod = window.projectPeriodMonths || 3;
                    html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(139, 92, 246, 0.2); border-radius: 4px; margin-top: 8px;">`;
                    html += `<span>üíµ –î–æ—Ö–æ–¥ –Ω–∞ —Ä–µ–º–æ–Ω—Ç (4%/–º–µ—Å √ó ${renoPeriod} –º–µ—Å)</span>`;
                    html += `<span style="font-weight: 600; color: #8b5cf6;">${Math.round(renovationIncome).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                    html += `</div>`;
                }

                // –î–æ—Ö–æ–¥ –Ω–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ (–¥–ª—è partner_flip)
                const investmentIncome = estimate.investment_income || 0;
                if (investmentIncome > 0) {
                    html += `<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(34, 197, 94, 0.2); border-radius: 4px; margin-top: 8px;">`;
                    html += `<span>üí∞ –î–æ—Ö–æ–¥ –Ω–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ (—Ü–µ–Ω–∞ √ó 4%/–º–µ—Å √ó ${projectMonths} –º–µ—Å)</span>`;
                    html += `<span style="font-weight: 600; color: #22c55e;">${Math.round(investmentIncome).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                    html += `</div>`;
                }

                html += '</div></div>';
            }

            // –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á—ë—Ç–∞ 50/50 –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
            if (projectType === 'partner' || projectType === 'partner_flip' || projectType === 'bank_flip') {
                const purchasePrice = estimate.interest_price || 0;
                const salePrice = estimate.expected_sale_price || estimate.displayed_sale_price || 0;
                // –°—É–º–º–∏—Ä—É–µ–º –≤—Å–µ —Ä–∞—Å—Ö–æ–¥—ã –∏–∑ breakdown (–∫—Ä–æ–º–µ –¥–æ—Ö–æ–¥–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π)
                const breakdown = estimate.cost_breakdown || estimate.investment_breakdown || {};
                let totalCosts = 0;
                for (const [key, value] of Object.entries(breakdown)) {
                    if (value > 0 && !key.includes('–î–æ—Ö–æ–¥')) {
                        totalCosts += value;
                    }
                }
                const totalProfit = estimate.expected_profit || 0;
                const ourProfit = estimate.our_profit || 0;
                const partnerProfit = estimate.partner_profit || 0;
                const renovationIncome = estimate.renovation_income || 0;
                const minGuaranteed = estimate.min_guaranteed || 0;

                html += '<div style="margin-top: 20px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">';
                html += '<div style="font-weight: 600; margin-bottom: 12px; color: #60a5fa;">üìä –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–û–ï–ö–¢–ê 50/50:</div>';
                html += '<div style="display: grid; gap: 8px; font-size: 13px;">';

                // –î–û–•–û–î–´
                html += '<div style="font-weight: 600; color: #4ade80; margin-top: 4px;">–î–û–•–û–î–´:</div>';
                html += `<div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(0,0,0,0.2); border-radius: 4px;">`;
                html += `<span>üí∞ –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ (–ø–æ—Å–ª–µ —Ç–æ—Ä–≥–∞ -7%)</span>`;
                html += `<span style="font-weight: 600; color: #4ade80;">${(salePrice / 1000000).toFixed(2)} –º–ª–Ω ‚ÇΩ</span>`;
                html += `</div>`;

                // –†–ê–°–•–û–î–´
                html += '<div style="font-weight: 600; color: #f87171; margin-top: 8px;">–†–ê–°–•–û–î–´:</div>';
                html += `<div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(0,0,0,0.2); border-radius: 4px;">`;
                html += `<span>üè† –¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏</span>`;
                html += `<span style="font-weight: 600;">${(purchasePrice / 1000000).toFixed(2)} –º–ª–Ω ‚ÇΩ</span>`;
                html += `</div>`;

                // –î–µ—Ç–∞–ª–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ (breakdown —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤—ã—à–µ)
                for (const [key, value] of Object.entries(breakdown)) {
                    if (value > 0 && !key.includes('–î–æ—Ö–æ–¥ –Ω–∞ —Ä–µ–º–æ–Ω—Ç')) {
                        html += `<div style="display: flex; justify-content: space-between; padding: 4px 8px; opacity: 0.8;">`;
                        html += `<span style="padding-left: 16px;">‚Ä¢ ${key}</span>`;
                        html += `<span>${Math.round(value).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                        html += `</div>`;
                    }
                }

                html += `<div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(239, 68, 68, 0.2); border-radius: 4px; margin-top: 4px;">`;
                html += `<span style="font-weight: 600;">–ò–¢–û–ì–û —Ä–∞—Å—Ö–æ–¥–æ–≤</span>`;
                html += `<span style="font-weight: 600; color: #f87171;">${(totalCosts / 1000000).toFixed(2)} –º–ª–Ω ‚ÇΩ</span>`;
                html += `</div>`;

                // –ü–†–ò–ë–´–õ–¨
                html += '<div style="font-weight: 600; color: #a78bfa; margin-top: 8px;">–†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–†–ò–ë–´–õ–ò:</div>';
                html += `<div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(0,0,0,0.2); border-radius: 4px;">`;
                html += `<span>üìà –û–±—â–∏–π –ø—Ä–æ—Ñ–∏—Ç –ø—Ä–æ–µ–∫—Ç–∞</span>`;
                html += `<span style="font-weight: 600;">${Math.round(totalProfit).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                html += `</div>`;

                if (renovationIncome > 0) {
                    html += `<div style="display: flex; justify-content: space-between; padding: 4px 8px; opacity: 0.8;">`;
                    html += `<span style="padding-left: 16px;">‚Ä¢ –î–æ—Ö–æ–¥ –Ω–∞ —Ä–µ–º–æ–Ω—Ç (–Ω–∞–º)</span>`;
                    html += `<span>${Math.round(renovationIncome).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                    html += `</div>`;
                    html += `<div style="display: flex; justify-content: space-between; padding: 4px 8px; opacity: 0.8;">`;
                    html += `<span style="padding-left: 16px;">‚Ä¢ –î–µ–ª–∏–º–∞—è —á–∞—Å—Ç—å 50/50</span>`;
                    html += `<span>${Math.round(totalProfit - renovationIncome).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                    html += `</div>`;
                }

                html += `<div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(34, 197, 94, 0.2); border-radius: 4px;">`;
                html += `<span>‚úÖ –ù–ê–®–ê –¥–æ–ª—è</span>`;
                html += `<span style="font-weight: 600; color: #22c55e;">${Math.round(ourProfit).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                html += `</div>`;

                html += `<div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(59, 130, 246, 0.2); border-radius: 4px;">`;
                html += `<span>üë§ –î–æ–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞</span>`;
                html += `<span style="font-weight: 600; color: #3b82f6;">${Math.round(partnerProfit).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                html += `</div>`;

                if (minGuaranteed > 0 && ourProfit <= minGuaranteed * 1.1) {
                    html += `<div style="margin-top: 8px; padding: 8px; background: rgba(245, 158, 11, 0.15); border-radius: 4px; font-size: 12px; color: #fbbf24;">`;
                    html += `‚ö†Ô∏è –ü—Ä–∏–º–µ–Ω—ë–Ω –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∏–Ω–∏–º—É–º: ${Math.round(minGuaranteed).toLocaleString('ru-RU')} ‚ÇΩ`;
                    html += `</div>`;
                }

                html += '</div></div>';
            }

            // –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
            html += '<div style="margin-top: 25px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">';
            html += `<button onclick="downloadPDFReport()" style="padding: 14px 28px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">`;
            html += `üìÑ –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç PDF`;
            html += `</button>`;
            html += `<button onclick="showTelegramModal()" style="padding: 14px 28px; background: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">`;
            html += `üì≤ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram`;
            html += `</button>`;
            html += '</div>';
            
            // Explanation - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø—Ä–æ–µ–∫—Ç–∞
            html += '<div style="margin-top: 20px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid #3b82f6;">';
            html += `<div style="font-weight: 600; margin-bottom: 8px; color: #3b82f6;">üí° ${projectTypeName}: –∫–∞–∫ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è?</div>`;
            html += '<div style="font-size: 13px; line-height: 1.6; opacity: 0.9;">';

            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å—Ä–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞
            const helpPeriod = window.projectPeriodMonths || 3;
            const helpRenoRate = 4 * helpPeriod;  // 4%/–º–µ—Å √ó –∫–æ–ª-–≤–æ –º–µ—Å—è—Ü–µ–≤

            if (projectType === 'own') {
                html += '<strong>–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç</strong> ‚Äî 100% –ø—Ä–∏–±—ã–ª–∏ –Ω–∞—à–∞.<br><br>';
                html += '‚Ä¢ –¢–æ—Ä–≥ —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º: 7%<br>';
                html += '‚Ä¢ –¶–µ–ª–µ–≤–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å: 4%/–º–µ—Å<br>';
                html += '‚Ä¢ –ù–∞–ª–æ–≥: 6% –æ—Ç –ø—Ä–∏–±—ã–ª–∏<br>';
                html += `‚Ä¢ –°—Ä–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞: ${helpPeriod} –º–µ—Å<br><br>`;
                html += `<strong>–¶–µ–Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞</strong> ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏ –¥–ª—è ${helpRenoRate}% –ø—Ä–∏–±—ã–ª–∏ –∑–∞ ${helpPeriod} –º–µ—Å.`;
            } else if (projectType === 'partner') {
                html += '<strong>–ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π 50/50</strong> ‚Äî –ø—Ä–∏–±—ã–ª—å –¥–µ–ª–∏—Ç—Å—è –ø–æ–ø–æ–ª–∞–º.<br><br>';
                html += '‚Ä¢ –ù–∞—à–∞ –¥–æ–ª—è: 50% –æ—Ç –ø—Ä–∏–±—ã–ª–∏<br>';
                html += '‚Ä¢ –ú–∏–Ω–∏–º—É–º: 4%/–º–µ—Å –æ—Ç –≤–ª–æ–∂–µ–Ω–∏–π –ò–õ–ò 1 –º–ª–Ω ‚ÇΩ<br>';
                html += '‚Ä¢ –ù–∞–ª–æ–≥: 6% –æ—Ç –æ–±—â–µ–π –ø—Ä–∏–±—ã–ª–∏<br>';
                html += `‚Ä¢ –°—Ä–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞: ${helpPeriod} –º–µ—Å<br><br>`;
                html += '<strong>–¶–µ–Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞</strong> ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π –Ω–∞—à–∞ –¥–æ–ª—è ‚â• 4%/–º–µ—Å.';
            } else if (projectType === 'partner_flip') {
                html += '<strong>–ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π –§–ª–∏–ø</strong> ‚Äî 50/50 + —Ä–µ–º–æ–Ω—Ç.<br><br>';
                html += '‚Ä¢ –ü—Ä–∏–±—ã–ª—å –æ—Ç –ø–æ–∫—É–ø–∫–∏: 50/50<br>';
                html += `‚Ä¢ –î–æ—Ö–æ–¥ –Ω–∞ —Ä–µ–º–æ–Ω—Ç: 4%/–º–µ—Å √ó ${helpPeriod} –º–µ—Å = ${helpRenoRate}% (–∏–¥—ë—Ç –Ω–∞–º)<br>`;
                html += '‚Ä¢ –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏: +1.6√ó –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–µ–º–æ–Ω—Ç–∞<br>';
                html += '‚Ä¢ –ì–∞—Ä–∞–Ω—Ç. –º–∏–Ω–∏–º—É–º: max(2% –æ—Ç –≤–ª–æ–∂–µ–Ω–∏–π, 1 –º–ª–Ω ‚ÇΩ)<br>';
                html += `‚Ä¢ –°—Ä–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞: ${helpPeriod} –º–µ—Å<br><br>`;
                html += '<strong>–¶–µ–Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞</strong> ‚Äî —Å —É—á–µ—Ç–æ–º –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –∏ –Ω–∞ –ø–æ–∫—É–ø–∫—É, –∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç.';
            } else if (projectType === 'bank_flip') {
                html += '<strong>–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –§–ª–∏–ø</strong> ‚Äî –∏–ø–æ—Ç–µ–∫–∞ + –ø–∞—Ä—Ç–Ω–µ—Ä.<br><br>';
                html += '‚Ä¢ –ò–ø–æ—Ç–µ–∫–∞: 80% –æ—Ç —Ü–µ–Ω—ã, 2%/–º–µ—Å<br>';
                html += `‚Ä¢ –ü–∞—Ä—Ç–Ω–µ—Ä –ø–ª–∞—Ç–∏—Ç: ${helpPeriod} –º–µ—Å % –≤–ø–µ—Ä–µ–¥ + 0.75% –∑–∞ –≤—ã–¥–∞—á—É<br>`;
                html += '‚Ä¢ –ü—Ä–∏–±—ã–ª—å 50/50<br>';
                html += `‚Ä¢ –î–æ—Ö–æ–¥ –Ω–∞ —Ä–µ–º–æ–Ω—Ç: 4%/–º–µ—Å √ó ${helpPeriod} –º–µ—Å = ${helpRenoRate}% (–∏–¥—ë—Ç –Ω–∞–º)<br>`;
                html += '‚Ä¢ –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏: +1.6√ó –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–µ–º–æ–Ω—Ç–∞<br>';
                html += '‚Ä¢ –ì–∞—Ä–∞–Ω—Ç. –º–∏–Ω–∏–º—É–º: max(2% –æ—Ç –≤–ª–æ–∂–µ–Ω–∏–π, 1 –º–ª–Ω ‚ÇΩ)<br>';
                html += `‚Ä¢ –°—Ä–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞: ${helpPeriod} –º–µ—Å<br><br>`;
                html += '<strong>–¶–µ–Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞</strong> ‚Äî —Å —É—á–µ—Ç–æ–º –∏–ø–æ—Ç–µ–∫–∏ –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–∏–Ω–∏–º—É–º–∞.';
            }

            html += '</div></div>';

            html += '</div>';

            content.innerHTML = html;
        }

        // ========== PRICE ADJUSTMENT ==========
        window.currentPriceAdjustment = 0;
        window.adjustmentNote = '';

        // Floor discount constants
        const FIRST_FLOOR_DISCOUNT = 0.20;  // -20% –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–∂–∞
        const LAST_FLOOR_DISCOUNT = 0.02;   // -2% –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç—Ç–∞–∂–∞

        function checkFloorDiscounts() {
            const floor = window.lastEstimate?.floor;
            const totalFloors = window.lastEstimate?.total_floors;
            const salePrice = window.lastEstimate?.original_bottom3_price ||
                              window.lastEstimate?.bottom3_price ||
                              window.lastEstimate?.estimated_price;

            const floorBlock = document.getElementById('floorAdjustmentBlock');
            const firstChip = document.getElementById('firstFloorChip');
            const lastChip = document.getElementById('lastFloorChip');
            const firstCheckbox = document.getElementById('applyFirstFloorDiscount');
            const lastCheckbox = document.getElementById('applyLastFloorDiscount');

            if (!floorBlock || !floor) return;

            // Reset
            firstChip.style.display = 'none';
            lastChip.style.display = 'none';
            if (firstCheckbox) firstCheckbox.checked = false;
            if (lastCheckbox) lastCheckbox.checked = false;

            let showBlock = false;

            // –ü–µ—Ä–≤—ã–π —ç—Ç–∞–∂
            if (floor === 1) {
                firstChip.style.display = 'inline-flex';
                firstCheckbox.checked = true;
                showBlock = true;
            }

            // –ü–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–∂
            if (totalFloors && floor === totalFloors) {
                lastChip.style.display = 'inline-flex';
                lastCheckbox.checked = true;
                showBlock = true;
            }

            floorBlock.style.display = showBlock ? 'block' : 'none';

            if (showBlock) {
                applyFloorDiscount(); // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            }
        }

        function applyFloorDiscount() {
            const salePrice = window.lastEstimate?.original_bottom3_price ||
                              window.lastEstimate?.bottom3_price ||
                              window.lastEstimate?.estimated_price;

            if (!salePrice) return;

            let totalDiscount = 0;
            let notes = [];

            const firstCheckbox = document.getElementById('applyFirstFloorDiscount');
            const lastCheckbox = document.getElementById('applyLastFloorDiscount');

            if (firstCheckbox?.checked) {
                totalDiscount += salePrice * FIRST_FLOOR_DISCOUNT;
                notes.push('–ø–µ—Ä–≤—ã–π —ç—Ç–∞–∂ -20%');
            }

            if (lastCheckbox?.checked) {
                totalDiscount += salePrice * LAST_FLOOR_DISCOUNT;
                notes.push('–ø–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–∂ -2%');
            }

            // –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
            const adjustmentInput = document.getElementById('priceAdjustment');
            if (adjustmentInput) {
                adjustmentInput.value = totalDiscount > 0 ? -Math.round(totalDiscount) : '';
            }

            // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ (–µ—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–ª–∏ –ø—É—Å—Ç–æ–µ)
            const noteField = document.getElementById('adjustmentNote');
            if (noteField) {
                if (!noteField.value || noteField.dataset.autoGenerated === 'true') {
                    noteField.value = notes.join(', ');
                    noteField.dataset.autoGenerated = notes.length > 0 ? 'true' : '';
                }
            }

            // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å
            applyPriceAdjustment();
        }

        function applyPriceAdjustment() {
            const adjustmentInput = document.getElementById('priceAdjustment');
            const noteInput = document.getElementById('adjustmentNote');
            const displayDiv = document.getElementById('adjustedPriceDisplay');
            const adjustedPriceSpan = document.getElementById('adjustedSalePrice');

            const adjustment = parseFloat(adjustmentInput.value) || 0;
            const note = noteInput.value.trim();

            window.currentPriceAdjustment = adjustment;
            window.adjustmentNote = note;

            if (adjustment !== 0) {
                // Calculate adjusted sale price
                const originalPrice = window.lastEstimate.original_bottom3_price ||
                                     window.lastEstimate.bottom3_price ||
                                     window.lastEstimate.estimated_price;
                const adjustedPrice = originalPrice + adjustment;

                // Show adjusted price display
                displayDiv.style.display = 'block';
                adjustedPriceSpan.textContent = `${(adjustedPrice / 1000000).toFixed(2)} –º–ª–Ω ‚ÇΩ`;

                // Update the sale price card
                const salePriceElem = document.getElementById('salePrice');
                if (salePriceElem) {
                    const adjMln = (adjustedPrice / 1000000).toFixed(2);
                    const adjFormatted = Math.round(adjustedPrice).toLocaleString('ru-RU');
                    const adjSign = adjustment < 0 ? '' : '+';
                    const adjAmountK = Math.abs(adjustment / 1000).toFixed(0);
                    salePriceElem.innerHTML =
                        `${adjMln} –º–ª–Ω ‚ÇΩ<br><span style="font-size: 12px; opacity: 0.7; font-weight: normal;">${adjFormatted} ‚ÇΩ (${adjSign}${adjustment < 0 ? '-' : ''}${adjAmountK}–∫)</span>`;
                }
            } else {
                displayDiv.style.display = 'none';
                // Reset to original price
                if (window.lastEstimate) {
                    const originalPrice = window.lastEstimate.original_bottom3_price ||
                                         window.lastEstimate.bottom3_price ||
                                         window.lastEstimate.estimated_price;
                    const salePriceElem = document.getElementById('salePrice');
                    if (salePriceElem) {
                        const mln = (originalPrice / 1000000).toFixed(2);
                        const formatted = Math.round(originalPrice).toLocaleString('ru-RU');
                        salePriceElem.innerHTML = `${mln} –º–ª–Ω ‚ÇΩ<br><span style="font-size: 12px; opacity: 0.7; font-weight: normal;">${formatted} ‚ÇΩ</span>`;
                    }
                }
            }

            // Auto-recalculate interest price with new adjustment
            recalculateInterestPrice();
        }

        // ========== PRICE SOURCE SELECTOR ==========
        window.currentPriceSource = 'combined'; // default: –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞

        function updatePriceSource(source) {
            if (!window.lastEstimate) return;

            // Get price and PSM based on source
            let displayPrice, displayPsm;
            let actualSource = source;

            switch (source) {
                case 'rosreestr':
                    displayPrice = window.lastEstimate.rosreestr_price;
                    displayPsm = window.lastEstimate.rosreestr_psm;
                    break;
                case 'combined':
                    displayPrice = window.lastEstimate.combined_price;
                    displayPsm = window.lastEstimate.combined_psm;
                    break;
                case 'cian':
                default:
                    displayPrice = window.lastEstimate.cian_price;
                    displayPsm = window.lastEstimate.cian_psm;
                    actualSource = 'cian';
                    break;
            }

            // Fallback to CIAN if selected source has no data
            if (!displayPrice || !displayPsm) {
                displayPrice = window.lastEstimate.cian_price;
                displayPsm = window.lastEstimate.cian_psm;
                actualSource = 'cian';
                console.log('Price source fallback to CIAN - no data for:', source);
            }

            // Update actual source used
            window.currentPriceSource = actualSource;

            // Update selector visual state
            const sources = ['cian', 'rosreestr', 'combined'];
            const colors = {
                'cian': '#22c55e',
                'rosreestr': '#f59e0b',
                'combined': '#8b5cf6'
            };

            sources.forEach(s => {
                const elem = document.getElementById('ps_' + s);
                if (elem) {
                    if (s === actualSource) {
                        elem.style.border = '2px solid ' + colors[s];
                        elem.style.background = 'rgba(' + (s === 'cian' ? '34,197,94' : s === 'rosreestr' ? '245,158,11' : '139,92,246') + ',0.2)';
                    } else {
                        elem.style.border = '2px solid transparent';
                        elem.style.background = 'rgba(0,0,0,0.2)';
                    }
                }
            });

            // Update display (always executes now due to fallback)
            if (displayPrice && displayPsm) {
                const priceInMillions = (displayPrice / 1000000).toFixed(2);
                document.getElementById('price').innerHTML =
                    `${priceInMillions} –º–ª–Ω ‚ÇΩ<br><span style="font-size: 14px; opacity: 0.7; font-weight: normal;">${Math.round(displayPrice).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                document.getElementById('pricePerSqm').textContent =
                    Math.round(displayPsm).toLocaleString('ru-RU') + ' ‚ÇΩ';

                // Update lastEstimate for investment recalculation
                window.lastEstimate.bottom3_price = displayPrice;
                window.lastEstimate.bottom3_price_per_sqm = displayPsm;
                // –í–ê–ñ–ù–û: –ü—Ä–∏ —Å–º–µ–Ω–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Ü–µ–Ω –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É
                window.lastEstimate.original_bottom3_price = displayPrice;
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º displayed_sale_price —á—Ç–æ–±—ã –ø–µ—Ä–µ—Å—á—ë—Ç —Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
                window.lastEstimate.displayed_sale_price = null;

                // Recalculate interest price based on new source
                const interestPrice = displayPrice * 0.85;
                const interestMillions = (interestPrice / 1000000).toFixed(2);
                const discountAmount = displayPrice - interestPrice;
                const discountPercent = ((discountAmount) / displayPrice * 100).toFixed(1);

                document.getElementById('interestPrice').innerHTML =
                    `${interestMillions} –º–ª–Ω ‚ÇΩ<br><span style="font-size: 12px; opacity: 0.7; font-weight: normal;">‚Üì ${discountPercent}% –æ—Ç —Ä—ã–Ω–∫–∞</span>`;
                window.lastEstimate.interest_price = interestPrice;

                // Update discount from market card
                document.getElementById('discountFromMarket').innerHTML =
                    `${discountPercent}%<br><span style="font-size: 12px; opacity: 0.7; font-weight: normal;">${(discountAmount / 1000000).toFixed(2)} –º–ª–Ω ‚ÇΩ</span>`;

                // Store values temporarily (will be recalculated properly below)
                window.lastEstimate.discount_percent = parseFloat(discountPercent);
                window.lastEstimate.discount_amount = discountAmount;

                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ü–µ–Ω—ã –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º
                // applyPriceAdjustment() —Å–∞–º–∞ –≤—ã–∑—ã–≤–∞–µ—Ç recalculateInterestPrice() –≤ –∫–æ–Ω—Ü–µ
                applyPriceAdjustment();
            }
        }

        async function recalculateInterestPrice() {
            if (!window.lastEstimate) return;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Å—á—ë—Ç–æ–º
            saveAllCheckboxStates();

            const evictionEnabled = document.getElementById('param_eviction')?.checked || false;
            const projectType = window.currentProjectType || 'own';
            const renovationEnabled = document.getElementById('param_renovation')?.checked || false;
            const isFlip = projectType === 'partner_flip' || projectType === 'bank_flip';

            const renovationRate = parseInt(document.getElementById('renovation_rate')?.value) || 60000;

            const params = {
                // –¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞
                project_type: projectType,
                // –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
                include_notary: document.getElementById('param_notary')?.checked || false,
                include_state_fee: document.getElementById('param_state_fee')?.checked || false,
                include_pip: document.getElementById('param_pip')?.checked || false,
                include_agency: document.getElementById('param_agency')?.checked || false,
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã - —Ä–µ–º–æ–Ω—Ç –ø–æ —á–µ–∫–±–æ–∫—Å—É –¥–ª—è –í–°–ï–• —Ç–∏–ø–æ–≤ –ø—Ä–æ–µ–∫—Ç–æ–≤
                include_renovation: renovationEnabled,
                renovation_per_sqm: renovationRate,  // –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è —Å—Ç–∞–≤–∫–∞ —Ä–µ–º–æ–Ω—Ç–∞
                include_foreman: document.getElementById('param_foreman')?.checked || false,
                include_eviction: evictionEnabled,
                include_registrators_transfer: document.getElementById('param_registrators_transfer')?.checked || false,
                include_registrators_mortgage: document.getElementById('param_registrators_mortgage')?.checked || false,
                include_contur_registration: document.getElementById('param_contur')?.checked || false,
                // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (–ñ–ö–•, –°–µ—Ä–±—Å–∫–æ–≥–æ)
                include_utilities: document.getElementById('param_utilities')?.checked || false,
                include_serbsky: document.getElementById('param_serbsky')?.checked || false,
                // –ü—Ä–∏ –≤—ã—Å–µ–ª–µ–Ω–∏–∏: 12 –º–µ—Å—è—Ü–µ–≤, –∏–Ω–∞—á–µ 3 –º–µ—Å—è—Ü–∞ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤
                // –°—Ä–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞: –ø—Ä–∏ –≤—ã—Å–µ–ª–µ–Ω–∏–∏ 12 –º–µ—Å, –∏–Ω–∞—á–µ –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3)
                project_period_months: evictionEnabled ? 12 : (parseInt(document.getElementById('project_period_input')?.value) || window.projectPeriodMonths || 3),
                target_profit_rate: evictionEnabled ? 0.48 : 0.12
            };
            
            try {
                // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –û–†–ò–ì–ò–ù–ê–õ–¨–ù–£–Æ —Ü–µ–Ω—É, –∞ –Ω–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—É—é
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–∞—Å—á—ë—Ç–µ (—ç—Ç–æ —Ü–µ–Ω–∞ –£–ñ–ï —Å–æ —Å–∫–∏–¥–∫–æ–π 7%)
                if (!window.lastEstimate.original_bottom3_price) {
                    window.lastEstimate.original_bottom3_price = window.lastEstimate.bottom3_price || window.lastEstimate.estimated_price;
                }
                const originalPrice = window.lastEstimate.original_bottom3_price;

                // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É —Ü–µ–Ω—ã (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ = —Å–∫–∏–¥–∫–∞)
                const priceAdjustment = window.currentPriceAdjustment || 0;
                const adjustedSalePrice = originalPrice + priceAdjustment;

                // –í–ê–ñ–ù–û: API –æ–∂–∏–¥–∞–µ—Ç market_price –ë–ï–ó —Å–∫–∏–¥–∫–∏, –∞ –∑–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω—è–µ—Ç 7% —Ç–æ—Ä–≥
                // adjustedSalePrice —É–∂–µ –≤–∫–ª—é—á–∞–µ—Ç —Å–∫–∏–¥–∫—É 7%, –ø–æ—ç—Ç–æ–º—É –¥–µ–ª–∏–º –Ω–∞ 0.93 —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –µ—ë
                const marketPriceBeforeBargain = adjustedSalePrice / 0.93;

                const response = await fetch('/calculate-interest-price', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        market_price: marketPriceBeforeBargain,
                        area_total: window.lastEstimate.area_total || parseFloat(document.getElementById('area').value),
                        params: params,
                        // –ü–µ—Ä–µ–¥–∞—ë–º –¥–∞–Ω–Ω—ã–µ –æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
                        price_adjustment: priceAdjustment,
                        adjustment_note: window.adjustmentNote || ''
                    })
                });

                const result = await response.json();

                // –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏: –µ—Å–ª–∏ —Ä–µ–º–æ–Ω—Ç –≤–∫–ª—é—á–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º expected_sale_price (—Å –±–æ–Ω—É—Å–æ–º –æ—Ç —Ä–µ–º–æ–Ω—Ç–∞)
                // –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ü–µ–Ω—É (—Å —É—á—ë—Ç–æ–º –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
                const salePrice = (renovationEnabled && result.expected_sale_price) ? result.expected_sale_price : adjustedSalePrice;

                // –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É —Ü–µ–Ω—ã –∏–Ω—Ç–µ—Ä–µ—Å–∞ (—Å–∫–∏–¥–∫–∞ –æ—Ç —Ü–µ–Ω—ã –ø—Ä–æ–¥–∞–∂–∏)
                const interestPriceElem = document.getElementById('interestPrice');
                if (interestPriceElem && result.interest_price) {
                    const interestMillions = (result.interest_price / 1000000).toFixed(2);
                    const discount = ((salePrice - result.interest_price) / salePrice * 100).toFixed(1);
                    interestPriceElem.innerHTML =
                        `${interestMillions} –º–ª–Ω ‚ÇΩ<br><span style="font-size: 12px; opacity: 0.7; font-weight: normal;">‚Üì ${discount}% –æ—Ç —Ä—ã–Ω–∫–∞</span>`;
                }
                
                // –û–±–Ω–æ–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é —Ä–∞—Å—Ö–æ–¥–æ–≤
                const breakdownList = document.getElementById('costBreakdownList');
                if (breakdownList && result.cost_breakdown) {
                    breakdownList.innerHTML = '';
                    for (const [name, amount] of Object.entries(result.cost_breakdown)) {
                        breakdownList.innerHTML += `
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 4px;">
                                <span>${name}</span>
                                <span style="font-weight: 600;">${Math.round(amount).toLocaleString('ru-RU')} ‚ÇΩ</span>
                            </div>`;
                    }
                }
                
                // –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ
                const investContent = document.getElementById('investmentContent');
                if (investContent) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –í–°–ï –ø–æ–ª—è –∏–∑ API –æ—Ç–≤–µ—Ç–∞
                    window.lastEstimate.project_type = result.project_type;
                    window.lastEstimate.project_type_name = result.project_type_name;
                    window.lastEstimate.interest_price = result.interest_price;
                    window.lastEstimate.interest_price_per_sqm = result.interest_price_per_sqm;
                    window.lastEstimate.expected_sale_price = result.expected_sale_price;
                    window.lastEstimate.expected_profit = result.expected_profit;
                    window.lastEstimate.our_profit = result.our_profit;
                    window.lastEstimate.partner_profit = result.partner_profit;
                    window.lastEstimate.profit_rate = result.profit_rate;
                    window.lastEstimate.monthly_profit_rate = result.monthly_profit_rate;
                    window.lastEstimate.our_monthly_rate = result.our_monthly_rate;
                    window.lastEstimate.project_months = result.project_months;
                    window.lastEstimate.investment_breakdown = result.cost_breakdown;

                    // –†–µ–º–æ–Ω—Ç
                    window.lastEstimate.renovation_cost = result.renovation_cost;
                    window.lastEstimate.renovation_bonus = result.renovation_bonus;
                    window.lastEstimate.renovation_profit = result.renovation_profit;
                    window.lastEstimate.renovation_income = result.renovation_income;

                    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∏–Ω–∏–º—É–º
                    window.lastEstimate.min_guaranteed = result.min_guaranteed;
                    window.lastEstimate.min_guaranteed_source = result.min_guaranteed_source;

                    // –ò–ø–æ—Ç–µ–∫–∞ (–¥–ª—è bank_flip)
                    window.lastEstimate.mortgage_amount = result.mortgage_amount;
                    window.lastEstimate.mortgage_monthly_payment = result.mortgage_monthly_payment;
                    window.lastEstimate.mortgage_total_interest = result.mortgage_total_interest;
                    window.lastEstimate.mortgage_prepayment = result.mortgage_prepayment;
                    window.lastEstimate.mortgage_issue_cost = result.mortgage_issue_cost;

                    // –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–∏—Ç—å summary cards —Å —Ü–µ–Ω–æ–π –ø—Ä–æ–¥–∞–∂–∏
                    // salePrice = –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ + –±–æ–Ω—É—Å –æ—Ç —Ä–µ–º–æ–Ω—Ç–∞ (–µ—Å–ª–∏ —Ä–µ–º–æ–Ω—Ç –≤–∫–ª—é—á–µ–Ω)
                    const displaySalePsm = salePrice / window.lastEstimate.area_total;

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–∂–∏ –≤ summary card
                    const priceElem = document.getElementById('price');
                    if (priceElem) {
                        const priceMillions = (salePrice / 1000000).toFixed(2);
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–±–∏–≤–∫—É: –±–∞–∑–∞ + –±–æ–Ω—É—Å –æ—Ç —Ä–µ–º–æ–Ω—Ç–∞
                        if (renovationEnabled && result.renovation_bonus) {
                            const baseMln = (adjustedSalePrice / 1000000).toFixed(2);
                            const bonusMln = (result.renovation_bonus / 1000000).toFixed(2);
                            priceElem.innerHTML = `${priceMillions} –º–ª–Ω ‚ÇΩ<br><span style="font-size: 12px; opacity: 0.7; font-weight: normal;">–ë–∞–∑–∞: ${baseMln} + –†–µ–º–æ–Ω—Ç: +${bonusMln}</span>`;
                        } else {
                            priceElem.innerHTML = `${priceMillions} –º–ª–Ω ‚ÇΩ<br><span style="font-size: 14px; opacity: 0.7; font-weight: normal;">${Math.round(salePrice).toLocaleString('ru-RU')} ‚ÇΩ</span>`;
                        }
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É –∑–∞ –º¬≤
                    const psmElem = document.getElementById('pricePerSqm');
                    if (psmElem) {
                        psmElem.textContent = Math.round(displaySalePsm).toLocaleString('ru-RU') + ' ‚ÇΩ';
                    }

                    // –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É! –¢–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                    // window.lastEstimate.original_bottom3_price –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω–æ–π
                    window.lastEstimate.displayed_sale_price = salePrice;
                    window.lastEstimate.displayed_sale_psm = displaySalePsm;

                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–∞—à–∫—É "–ü—Ä–æ—Ñ–∏—Ç –æ—Ç —Ä–µ–º–æ–Ω—Ç–∞"
                    const renovationProfitCard = document.getElementById('renovationProfitCard');
                    const renovationProfitElem = document.getElementById('renovationProfit');
                    if (renovationEnabled && result.renovation_profit) {
                        if (renovationProfitCard) renovationProfitCard.style.display = 'block';
                        if (renovationProfitElem) {
                            const profitMillions = (result.renovation_profit / 1000000).toFixed(2);
                            const profitPercent = ((result.renovation_profit / result.renovation_cost) * 100).toFixed(0);
                            renovationProfitElem.innerHTML = `${profitMillions} –º–ª–Ω ‚ÇΩ<br><span style="font-size: 12px; opacity: 0.7; font-weight: normal;">+${profitPercent}% –æ—Ç –∑–∞—Ç—Ä–∞—Ç</span>`;
                        }
                    } else {
                        if (renovationProfitCard) renovationProfitCard.style.display = 'none';
                    }

                    generateInvestmentAnalysis(window.lastEstimate);
                }
                
                // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showNotification('‚úÖ –¶–µ–Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–∞!', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
            }
        }

        async function saveInvestmentParams() {
            if (!window.currentValuationId) {
                showNotification('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –æ—Ü–µ–Ω–∫—É –∫–≤–∞—Ä—Ç–∏—Ä—ã', 'warning');
                return;
            }

            if (!window.lastEstimate) {
                showNotification('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'warning');
                return;
            }

            try {
                const response = await fetch('/save-investment-params', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        valuation_id: window.currentValuationId,
                        investment_data: {
                            interest_price: window.lastEstimate.interest_price,
                            interest_price_per_sqm: window.lastEstimate.interest_price_per_sqm,
                            expected_profit: window.lastEstimate.expected_profit,
                            profit_rate: window.lastEstimate.profit_rate,
                            cost_breakdown: window.lastEstimate.investment_breakdown
                        },
                        // –î–∞–Ω–Ω—ã–µ –æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–µ —Ü–µ–Ω—ã
                        price_adjustment: window.currentPriceAdjustment || 0,
                        adjustment_note: window.adjustmentNote || ''
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (result.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã', 'error');
            }
        }

        function downloadPDFReport() {
            if (!window.currentValuationId) {
                showNotification('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –æ—Ü–µ–Ω–∫—É –∫–≤–∞—Ä—Ç–∏—Ä—ã', 'warning');
                return;
            }
            window.location.href = `/generate-report/${window.currentValuationId}`;
            showNotification('üìÑ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...', 'success');
        }
        
        function showTelegramModal() {
            const username = prompt('üì± –í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram username –∏–ª–∏ ID —á–∞—Ç–∞:\n\n–ù–∞–ø—Ä–∏–º–µ—Ä: @your_username –∏–ª–∏ 123456789');
            if (username && username.trim()) {
                sendToTelegram(username.trim());
            }
        }
        
        async function sendToTelegram(username) {
            if (!window.currentValuationId) {
                showNotification('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –æ—Ü–µ–Ω–∫—É –∫–≤–∞—Ä—Ç–∏—Ä—ã', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/send-to-telegram', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        valuation_id: window.currentValuationId,
                        telegram_username: username
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('‚úÖ –û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram!', 'success');
                } else {
                    showNotification('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:', error);
                showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.', 'error');
            }
        }
        
        function showNotification(message, type = 'info') {
            const colors = {
                success: '#22c55e',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ============ HISTORY TAB FUNCTIONS ============
        let historySearchTimeout = null;
        let historyData = null;

        function debounceHistorySearch() {
            clearTimeout(historySearchTimeout);
            historySearchTimeout = setTimeout(() => {
                loadHistoryStreets();
            }, 300);
        }

        async function loadHistoryStreets() {
            const searchInput = document.getElementById('historySearch');
            const search = searchInput ? searchInput.value.trim() : '';
            const loader = document.getElementById('historyLoader');
            const tree = document.getElementById('historyTree');

            loader.style.display = 'block';
            tree.innerHTML = '';

            try {
                let url = '/history/streets';
                if (search) {
                    url += `?search=${encodeURIComponent(search)}`;
                }

                const response = await fetch(url);
                const data = await response.json();
                historyData = data;

                // Update stats
                document.getElementById('statsStreets').textContent = data.total_streets || 0;
                document.getElementById('statsBuildings').textContent = data.total_buildings || 0;
                document.getElementById('statsValuations').textContent = data.total_valuations || 0;

                // Render tree
                renderHistoryTree(data.streets || []);
            } catch (error) {
                console.error('Error loading history:', error);
                tree.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</div>';
            } finally {
                loader.style.display = 'none';
            }
        }

        function renderHistoryTree(streets) {
            const tree = document.getElementById('historyTree');

            if (!streets || streets.length === 0) {
                tree.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Ü–µ–Ω–∫–∞—Ö</div>';
                return;
            }

            let html = '';
            streets.forEach((street, streetIdx) => {
                html += `
                    <div class="street-item">
                        <div class="street-header" onclick="toggleStreet(${streetIdx})">
                            <span class="street-name">üìç ${street.street}</span>
                            <span class="street-stats">
                                <span>üè† ${street.buildings.length} –¥–æ–º–æ–≤</span>
                                <span>üìä ${street.total_valuations} –æ—Ü–µ–Ω–æ–∫</span>
                            </span>
                        </div>
                        <div class="street-content" id="street-${streetIdx}">
                            ${street.buildings.map((bld, bldIdx) => `
                                <div class="building-item" onclick="toggleBuilding(${streetIdx}, ${bldIdx}, '${bld.address.replace(/'/g, "\\'")}'); event.stopPropagation();">
                                    <div class="building-header">
                                        <span class="building-address">${bld.address}</span>
                                        <span class="building-stats">
                                            ${bld.valuation_count} –æ—Ü–µ–Ω–æ–∫
                                            ${bld.max_price ? `| –¥–æ ${formatPrice(bld.max_price)}` : ''}
                                        </span>
                                    </div>
                                    <div class="valuation-list" id="bld-${streetIdx}-${bldIdx}"></div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            tree.innerHTML = html;
        }

        function toggleStreet(streetIdx) {
            const content = document.getElementById(`street-${streetIdx}`);
            const header = content.previousElementSibling;

            if (content.classList.contains('show')) {
                content.classList.remove('show');
                header.classList.remove('expanded');
            } else {
                content.classList.add('show');
                header.classList.add('expanded');
            }
        }

        async function toggleBuilding(streetIdx, bldIdx, address) {
            const list = document.getElementById(`bld-${streetIdx}-${bldIdx}`);

            if (list.classList.contains('show')) {
                list.classList.remove('show');
                return;
            }

            // Load valuations for this address
            list.innerHTML = '<div style="padding: 10px; color: #9ca3af;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            list.classList.add('show');

            try {
                const response = await fetch(`/history/by-address/${encodeURIComponent(address)}`);
                const data = await response.json();

                if (data.history && data.history.length > 0) {
                    list.innerHTML = data.history.map(v => `
                        <div class="valuation-item" style="cursor: default;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
                                <div style="flex: 1;">
                                    <div class="valuation-date" style="font-weight: 500; margin-bottom: 6px;">üìÖ ${formatDateTime(v.created_at)}</div>
                                    <div class="valuation-prices">
                                        <span class="valuation-price">üí∞ ${formatPrice(v.estimated_price)}</span>
                                        ${v.interest_price ? `<span class="valuation-interest">üíé ${formatPrice(v.interest_price)}</span>` : ''}
                                    </div>
                                    <div style="color: #9ca3af; font-size: 12px; margin-top: 4px;">
                                        ${v.area_total} –º¬≤ | ${v.rooms || '?'}–∫ | ${v.floor || '?'}/${v.total_floors || '?'} —ç—Ç.
                                    </div>
                                </div>
                                <button onclick="revaluateFromHistory('${address.replace(/'/g, "\\'")}', ${v.area_total}, ${v.rooms || 'null'}, ${v.floor || 'null'}, ${v.total_floors || 'null'}, ${v.lat || 'null'}, ${v.lon || 'null'}, '${v.building_type || ''}'); event.stopPropagation();"
                                    style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;">
                                    üîÑ –ü–µ—Ä–µ–æ—Ü–µ–Ω–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div style="padding: 10px; color: #9ca3af;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
                }
            } catch (error) {
                console.error('Error loading valuations:', error);
                list.innerHTML = '<div style="padding: 10px; color: #ef4444;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }

        function revaluateFromHistory(address, area, rooms, floor, totalFloors, lat, lon, buildingType, buildingYear) {
            // 1. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–£–º–Ω—ã–π –≤–≤–æ–¥"
            switchTab('smart');
            switchInputMode('text');

            // 2. –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            let text = '';
            if (address) text += `–ê–¥—Ä–µ—Å: ${address}\n`;
            if (area) text += `–ü–ª–æ—â–∞–¥—å: ${area} –º¬≤\n`;
            if (rooms) text += `–ö–æ–º–Ω–∞—Ç—ã: ${rooms}\n`;
            if (floor && totalFloors) text += `–≠—Ç–∞–∂: ${floor}/${totalFloors}\n`;
            else if (floor) text += `–≠—Ç–∞–∂: ${floor}\n`;
            if (buildingType) {
                const typeNames = {panel: '–ø–∞–Ω–µ–ª—å', brick: '–∫–∏—Ä–ø–∏—á', monolithic: '–º–æ–Ω–æ–ª–∏—Ç', block: '–±–ª–æ–∫', wood: '–¥–µ—Ä–µ–≤–æ'};
                text += `–¢–∏–ø –¥–æ–º–∞: ${typeNames[buildingType] || buildingType}\n`;
            }
            if (buildingYear) text += `–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏: ${buildingYear}\n`;

            // 3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
            const textarea = document.querySelector('#smartForm textarea[name="smartText"]');
            if (textarea) textarea.value = text.trim();

            // 4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å
            if (lat && lon) {
                window.currentLat = lat;
                window.currentLon = lon;
            }

            // 5. –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ —Ñ–æ—Ä–º–µ
            const tabContent = document.getElementById('tab-smart');
            if (tabContent) {
                tabContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            // 6. –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ "–£–º–Ω—ã–π –≤–≤–æ–¥". –ù–∞–∂–º–∏—Ç–µ "–û—Ü–µ–Ω–∏—Ç—å" –¥–ª—è –ø–µ—Ä–µ–æ—Ü–µ–Ω–∫–∏.', 'info');
        }

        async function showValuationDetails(valuationId) {
            try {
                const response = await fetch(`/history/details/${valuationId}`);
                const data = await response.json();

                if (!data.valuation) {
                    showNotification('–û—Ü–µ–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                    return;
                }

                const v = data.valuation;
                const comparables = data.comparables || [];

                // Create modal
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;

                modal.innerHTML = `
                    <div style="background: #1f2937; border-radius: 12px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #4ade80;">üìä –î–µ—Ç–∞–ª–∏ –æ—Ü–µ–Ω–∫–∏ #${v.valuation_id}</h3>
                            <button onclick="this.closest('div').parentElement.remove()" style="background: none; border: none; color: #9ca3af; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 4px;">–ê–¥—Ä–µ—Å</div>
                            <div style="font-size: 16px; font-weight: 600;">${v.address}</div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
                            <div style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 8px;">
                                <div style="color: #9ca3af; font-size: 11px;">–†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞</div>
                                <div style="color: #4ade80; font-size: 18px; font-weight: bold;">${formatPrice(v.estimated_price)}</div>
                                <div style="color: #9ca3af; font-size: 11px;">${formatPrice(v.estimated_price_per_sqm)}/–º¬≤</div>
                            </div>
                            <div style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 8px;">
                                <div style="color: #9ca3af; font-size: 11px;">–¶–µ–Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞</div>
                                <div style="color: #f59e0b; font-size: 18px; font-weight: bold;">${v.interest_price ? formatPrice(v.interest_price) : '-'}</div>
                                <div style="color: #9ca3af; font-size: 11px;">${v.interest_price_per_sqm ? formatPrice(v.interest_price_per_sqm) + '/–º¬≤' : ''}</div>
                            </div>
                            <div style="background: rgba(168, 85, 247, 0.1); padding: 12px; border-radius: 8px;">
                                <div style="color: #9ca3af; font-size: 11px;">–ü—Ä–∏–±—ã–ª—å</div>
                                <div style="color: #c084fc; font-size: 18px; font-weight: bold;">${v.expected_profit ? formatPrice(v.expected_profit) : '-'}</div>
                                <div style="color: #9ca3af; font-size: 11px;">${v.profit_rate ? (v.profit_rate * 100).toFixed(1) + '%' : ''}</div>
                            </div>
                        </div>

                        <div style="background: rgba(59, 130, 246, 0.05); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="color: #60a5fa; font-size: 14px; margin-bottom: 12px; font-weight: 600;">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 13px;">
                                <div><span style="color: #9ca3af;">–ü–ª–æ—â–∞–¥—å:</span> ${v.area_total} –º¬≤</div>
                                <div><span style="color: #9ca3af;">–ö–æ–º–Ω–∞—Ç:</span> ${v.rooms || '-'}</div>
                                <div><span style="color: #9ca3af;">–≠—Ç–∞–∂:</span> ${v.floor || '-'}/${v.total_floors || '-'}</div>
                                <div><span style="color: #9ca3af;">–¢–∏–ø:</span> ${v.building_type || '-'}</div>
                            </div>
                        </div>

                        ${comparables.length > 0 ? `
                            <div style="margin-top: 20px;">
                                <div style="color: #4ade80; font-size: 14px; margin-bottom: 12px; font-weight: 600;">–ê–Ω–∞–ª–æ–≥–∏ (${comparables.length})</div>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    ${comparables.slice(0, 10).map((c, i) => `
                                        <div style="display: flex; justify-content: space-between; padding: 8px; background: ${i < 3 ? 'rgba(34, 197, 94, 0.1)' : 'rgba(0,0,0,0.2)'}; border-radius: 4px; margin-bottom: 4px; font-size: 12px;">
                                            <span>${i < 3 ? '‚≠ê' : ''} ${c.area_total} –º¬≤ | ${c.distance_km?.toFixed(2) || '?'} –∫–º</span>
                                            <span style="color: ${i < 3 ? '#4ade80' : '#e5e7eb'}; font-weight: 600;">${formatPrice(c.price_per_sqm)}/–º¬≤</span>
                                            ${c.url ? `<a href="${c.url}" target="_blank" style="color: #60a5fa;">üîó</a>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div style="margin-top: 20px; text-align: right; color: #6b7280; font-size: 12px;">
                            –°–æ–∑–¥–∞–Ω–æ: ${formatDateTime(v.created_at)}
                        </div>
                    </div>
                `;

                modal.onclick = (e) => {
                    if (e.target === modal) modal.remove();
                };

                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading valuation details:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π', 'error');
            }
        }

        function formatPrice(value) {
            if (!value && value !== 0) return '-';
            return Math.round(value).toLocaleString('ru-RU') + ' ‚ÇΩ';
        }

        function formatDateTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ============ LISTING MODAL & REFINEMENT FUNCTIONS ============

        async function showListingModal(listingId) {
            console.log('showListingModal called with ID:', listingId);
            try {
                const response = await fetch(`/listing/${listingId}`);
                const data = await response.json();

                if (!data.listing) {
                    showNotification('–õ–∏—Å—Ç–∏–Ω–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ', 'error');
                    return;
                }

                const l = data.listing;
                const priceHistory = data.price_history || [];

                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.85);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;

                modal.innerHTML = `
                    <div style="background: #1f2937; border-radius: 12px; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #60a5fa;">üìÅ –ê—Ä—Ö–∏–≤: –õ–∏—Å—Ç–∏–Ω–≥ #${l.id}</h3>
                            <button onclick="this.closest('div').parentElement.remove()" style="background: none; border: none; color: #9ca3af; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>

                        <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                            ${l.is_active ?
                                '<span style="background: #22c55e; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">üü¢ –ê–∫—Ç–∏–≤–µ–Ω</span>' :
                                '<span style="background: #ef4444; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">üî¥ –°–Ω—è—Ç —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</span>'
                            }
                            ${l.url ? `<a href="${l.url}" target="_blank" style="background: #3b82f6; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; text-decoration: none;">–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –¶–ò–ê–ù ‚Üó</a>` : ''}
                            ${l.listing_id ? `<a href="https://realestate.ourdocs.org/listing/${l.listing_id}" target="_blank" style="background: #22c55e; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; text-decoration: none;">–ù–∞—à–∞ –ë–î ‚Üó</a>` : ''}
                        </div>

                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 4px;">–ê–¥—Ä–µ—Å</div>
                            <div style="font-size: 15px; font-weight: 500;">${l.address || '-'}</div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                            <div style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="color: #9ca3af; font-size: 11px;">–¶–µ–Ω–∞</div>
                                <div style="color: #4ade80; font-size: 16px; font-weight: bold;">${l.price ? formatPrice(l.price) : '-'}</div>
                            </div>
                            <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="color: #9ca3af; font-size: 11px;">–ü–ª–æ—â–∞–¥—å</div>
                                <div style="color: #60a5fa; font-size: 16px; font-weight: bold;">${l.area_total || '-'} –º¬≤</div>
                            </div>
                            <div style="background: rgba(168, 85, 247, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="color: #9ca3af; font-size: 11px;">–ö–æ–º–Ω–∞—Ç</div>
                                <div style="color: #c084fc; font-size: 16px; font-weight: bold;">${l.rooms || '-'}</div>
                            </div>
                            <div style="background: rgba(249, 115, 22, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="color: #9ca3af; font-size: 11px;">–≠—Ç–∞–∂</div>
                                <div style="color: #fb923c; font-size: 16px; font-weight: bold;">${l.floor || '-'}/${l.total_floors || '-'}</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                            <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                <div style="color: #9ca3af; font-size: 11px; margin-bottom: 4px;">–¢–∏–ø –¥–æ–º–∞</div>
                                <div style="font-size: 14px;">${l.building_type || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                <div style="color: #9ca3af; font-size: 11px; margin-bottom: 4px;">–¶–µ–Ω–∞/–º¬≤</div>
                                <div style="font-size: 14px; color: #4ade80;">${l.price && l.area_total ? formatPrice(l.price / l.area_total) + '/–º¬≤' : '-'}</div>
                            </div>
                        </div>

                        ${l.area_living || l.area_kitchen ? `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                                <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                    <div style="color: #9ca3af; font-size: 11px; margin-bottom: 4px;">–ñ–∏–ª–∞—è –ø–ª–æ—â–∞–¥—å</div>
                                    <div style="font-size: 14px;">${l.area_living || '-'} –º¬≤</div>
                                </div>
                                <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                    <div style="color: #9ca3af; font-size: 11px; margin-bottom: 4px;">–ö—É—Ö–Ω—è</div>
                                    <div style="font-size: 14px;">${l.area_kitchen || '-'} –º¬≤</div>
                                </div>
                            </div>
                        ` : ''}

                        ${priceHistory.length > 1 ? `
                            <div style="margin-bottom: 20px; padding: 15px; background: rgba(249, 115, 22, 0.1); border-radius: 8px; border-left: 3px solid #f59e0b;">
                                <div style="color: #fb923c; font-size: 14px; margin-bottom: 10px; font-weight: 600;">üìâ –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω (${priceHistory.length} –∑–∞–ø–∏—Å–µ–π)</div>
                                <div style="max-height: 150px; overflow-y: auto;">
                                    ${priceHistory.map((p, i) => `
                                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 13px;">
                                            <span style="color: #9ca3af;">${formatDateTime(p.date)}</span>
                                            <span style="font-weight: 600; ${i === 0 ? 'color: #4ade80;' : ''}">${formatPrice(p.price)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                ${l.price_change_pct ? `<div style="margin-top: 10px; font-size: 12px; color: ${l.price_change_pct < 0 ? '#4ade80' : '#ef4444'};">–ò–∑–º–µ–Ω–µ–Ω–∏–µ: ${l.price_change_pct > 0 ? '+' : ''}${l.price_change_pct.toFixed(1)}%</div>` : ''}
                            </div>
                        ` : ''}

                        ${l.description ? `
                            <div style="margin-bottom: 20px;">
                                <div style="color: #9ca3af; font-size: 12px; margin-bottom: 8px;">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                                <div style="font-size: 13px; line-height: 1.6; max-height: 200px; overflow-y: auto; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">${l.description}</div>
                            </div>
                        ` : ''}

                        <div style="display: flex; gap: 12px; margin-top: 20px; font-size: 12px; color: #6b7280;">
                            <span>–ü–µ—Ä–≤—ã–π —Ä–∞–∑: ${formatDateTime(l.first_seen)}</span>
                            <span>–ü–æ—Å–ª–µ–¥–Ω–∏–π: ${formatDateTime(l.last_seen)}</span>
                        </div>
                    </div>
                `;

                modal.onclick = (e) => {
                    if (e.target === modal) modal.remove();
                };

                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading listing:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏—Å—Ç–∏–Ω–≥–∞', 'error');
            }
        }

        function updateRefineSection() {
            const checked = document.querySelectorAll('.exclude-checkbox:checked');
            const refineSection = document.getElementById('refineSection');

            if (checked.length > 0) {
                refineSection.style.display = 'block';
            } else {
                refineSection.style.display = 'none';
            }
        }

        async function refineValuation() {
            const checked = document.querySelectorAll('.exclude-checkbox:checked');
            if (checked.length === 0) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∞–Ω–∞–ª–æ–≥–∏ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è', 'warning');
                return;
            }

            const excludedIds = Array.from(checked).map(cb => parseInt(cb.dataset.listingId));
            const reason = document.getElementById('exclusionReason')?.value || '';
            const valuationId = window.currentValuationId;

            if (!valuationId) {
                showNotification('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω ID –æ—Ü–µ–Ω–∫–∏', 'error');
                return;
            }

            try {
                const response = await fetch('/valuation/refine', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        valuation_id: valuationId,
                        excluded_listing_ids: excludedIds,
                        reason: reason
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');

                    // Update displayed price
                    const newPrice = result.new_estimated_price;
                    const newPricePerSqm = result.new_price_per_sqm;
                    document.getElementById('price').textContent = formatPrice(newPrice);
                    document.getElementById('pricePerSqm').textContent = formatPrice(newPricePerSqm) + '/–º¬≤';

                    // Recalculate interest price (same discount as original - ~18% from market)
                    const discountRate = 0.82; // 18% —Å–∫–∏–¥–∫–∞ –æ—Ç —Ä—ã–Ω–∫–∞
                    const newInterestPrice = newPrice * discountRate;
                    const newInterestPricePerSqm = newPricePerSqm * discountRate;

                    // Update interest price if displayed
                    const interestPriceEl = document.getElementById('interestPrice');
                    if (interestPriceEl) {
                        const priceInMillions = (newInterestPrice / 1000000).toFixed(2);
                        const discount = Math.round((1 - discountRate) * 100);
                        interestPriceEl.innerHTML = `${priceInMillions} –º–ª–Ω ‚ÇΩ<br><span style="font-size: 12px; opacity: 0.7; font-weight: normal;">‚Üì ${discount}% –æ—Ç —Ä—ã–Ω–∫–∞</span>`;
                    }

                    // Update TOP-3 badges dynamically
                    const allComparables = document.querySelectorAll('.comparable-item');
                    let visibleIndex = 0;
                    allComparables.forEach(item => {
                        if (!excludedIds.includes(parseInt(item.id.replace('comp-', '')))) {
                            const badge = item.querySelector('.badge-top3');
                            if (visibleIndex < 3) {
                                if (!badge) {
                                    const header = item.querySelector('.comparable-header');
                                    if (header) {
                                        header.insertAdjacentHTML('beforeend', '<span class="badge-top3">–¢–û–ü-3</span>');
                                    }
                                }
                                item.classList.add('top3');
                            } else {
                                if (badge) badge.remove();
                                item.classList.remove('top3');
                            }
                            visibleIndex++;
                        }
                    });

                    // Mark excluded items visually
                    excludedIds.forEach(id => {
                        const item = document.getElementById(`comp-${id}`);
                        if (item) {
                            item.style.opacity = '0.4';
                            item.classList.remove('top3');
                            const badge = item.querySelector('.badge-top3');
                            if (badge) badge.remove();
                            // Add EXCLUDED badge
                            const header = item.querySelector('.comparable-header');
                            if (header && !header.querySelector('.badge-excluded')) {
                                header.insertAdjacentHTML('beforeend', '<span class="badge-excluded" style="background: #ef4444; color: white; font-size: 10px; padding: 2px 6px; border-radius: 8px; margin-left: 6px;">–ò–°–ö–õ–Æ–ß–Å–ù</span>');
                            }
                            // Disable checkbox
                            const cb = item.querySelector('.exclude-checkbox');
                            if (cb) {
                                cb.checked = true;
                                cb.disabled = true;
                            }
                        }
                    });

                    // Hide refine section
                    document.getElementById('refineSection').style.display = 'none';

                    // Regenerate investment analysis if visible
                    if (document.getElementById('investmentSection')?.style.display === 'block') {
                        // Update stored estimate for recalculation
                        if (window.lastEstimate) {
                            window.lastEstimate.estimated_price = newPrice;
                            window.lastEstimate.estimated_price_per_sqm = newPricePerSqm;
                            window.lastEstimate.bottom3_price = newPrice; // Use refined price as bottom3
                            window.lastEstimate.bottom3_price_per_sqm = newPricePerSqm;
                            window.lastEstimate.interest_price = newInterestPrice;
                            window.lastEstimate.interest_price_per_sqm = newInterestPricePerSqm;
                            generateInvestmentAnalysis(window.lastEstimate);
                        }
                    }
                } else {
                    showNotification(result.detail || '–û—à–∏–±–∫–∞ —É—Ç–æ—á–Ω–µ–Ω–∏—è', 'error');
                }
            } catch (error) {
                console.error('Error refining valuation:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Ç–æ—á–Ω–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏', 'error');
            }
        }
    </script>
</body>
</html>
